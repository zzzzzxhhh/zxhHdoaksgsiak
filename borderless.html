<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/CMZqNMRh/IMG-6497.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html { height: 100%; overflow: hidden; }

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ body, phone-frame, phone-screen ç­‰æ ·å¼ â–¼â–¼â–¼ */

/* 1. é‡ç½® bodyï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå¹²å‡€çš„ç”»å¸ƒ */
body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    background-color: #f0f2f5; 
}

/* 2. è®© #phone-screen æˆä¸ºæ–°çš„â€œæ ¹â€å®¹å™¨ï¼Œæ’‘æ»¡æ•´ä¸ªæµè§ˆå™¨çª—å£ */
#phone-screen {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #000; /* ä¿ç•™ä¸€ä¸ªé»˜è®¤çš„é»‘è‰²èƒŒæ™¯ */
}

/* 3. ã€æ ¸å¿ƒã€‘éšè—æ‰æ¨¡æ‹Ÿå™¨çš„çŠ¶æ€æ  */
#status-bar {
    display: none;
}

/* 4. ã€æ ¸å¿ƒã€‘è®©æ‰€æœ‰é¡µé¢çš„å¤´éƒ¨è‡ªåŠ¨é€‚åº”iPhoneçš„â€œåˆ˜æµ·â€å®‰å…¨åŒº */
.header, .qzone-header {
    /* ä½¿ç”¨ env(safe-area-inset-top) è‡ªåŠ¨è·å–é¡¶éƒ¨å®‰å…¨è·ç¦» */
    padding-top: calc(15px + env(safe-area-inset-top));
}

/* 5. ã€æ ¸å¿ƒã€‘è®©èŠå¤©è¾“å…¥æ¡†å’Œåº•éƒ¨å¯¼èˆªæ è‡ªåŠ¨é€‚åº”iPhoneåº•éƒ¨çš„â€œå°é»‘æ¡â€å®‰å…¨åŒº */
#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }

.header .action-btn {
    font-size: 16px; /* ä¸“é—¨ä¸ºâ€œä¸Šä¼ â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰é’®ç¼©å°å­—å· */
    font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€ç‚¹è®©å®ƒæ›´æ¸…æ™° */
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
/* ä¿®æ”¹åçš„ #world-book-list æ ·å¼ */
#world-book-list {
    flex-grow: 1;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    padding-top: 80px;
    margin-top: -80px;
}

/* ä¿®æ”¹åçš„ #chat-list æ ·å¼ï¼Œå»æ‰äº† padding å’Œ margin */
#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 80px; 
    padding-bottom: 50px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
    box-sizing: border-box;
}

        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }

/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ #chat-messages æ ·å¼ â–¼â–¼â–¼ */
#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden; /* æ ¸å¿ƒä¿®æ­£1: å¼ºåˆ¶ç¦æ­¢æ°´å¹³æ»šåŠ¨/æ‹–åŠ¨ */
    padding: 10px 15px; /* æ ¸å¿ƒä¿®æ­£2: å°†å·¦å³å†…è¾¹è·å¢åŠ åˆ°15pxï¼Œæä¾›æ›´å¤šå‘¼å¸ç©ºé—´ */
    padding-top: 110px;
    margin-top: -80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }

.message-wrapper.ai .sender-name {
    margin-left: 50px; /* ç¨å¾®è°ƒæ•´ï¼Œä¸å¤´åƒå¯¹é½ */
    margin-bottom: 3px;
    position: absolute; /* è®©å®ƒè„±ç¦»æµï¼Œé¿å…å½±å“æ°”æ³¡å¯¹é½ */
    top: -16px;       /* å®šä½åˆ°æ°”æ³¡ä¸Šæ–¹ */
    left: 0;
}

/* === ã€å…¨æ–°ã€‘æ¶ˆæ¯å¸ƒå±€ä¸æ—¶é—´æˆ³æ ·å¼ === */

/* 1. æ¶ˆæ¯å•å…ƒçš„æ€»å®¹å™¨ (é‡æ„) */
.message-wrapper {
    display: flex;          /* ä½¿ç”¨Flexå¸ƒå±€ */
    gap: 8px;               /* æ°”æ³¡å’Œæ—¶é—´æˆ³ä¹‹é—´çš„é—´è· */
    align-items: flex-end;  /* æ ¸å¿ƒï¼šè®©æ°”æ³¡å’Œæ—¶é—´æˆ³åº•éƒ¨å¯¹é½ */
    position: relative;
    max-width: 90%;         /* å¯ä»¥ç¨å¾®æ”¾å®½ä¸€ç‚¹ï¼Œå› ä¸ºæ—¶é—´æˆ³ç°åœ¨åœ¨å¤–é¢äº† */
}

/* 2. AIæ¶ˆæ¯å•å…ƒé å·¦ */
.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row; /* å¤´åƒã€æ°”æ³¡ã€æ—¶é—´æˆ³ï¼Œä»å·¦åˆ°å³æ’åˆ— */
}

/* 3. ç”¨æˆ·æ¶ˆæ¯å•å…ƒé å³ */
.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; /* æ—¶é—´æˆ³ã€æ°”æ³¡ã€å¤´åƒï¼Œä»å³åˆ°å·¦æ’åˆ— */
}

/* 4. æ°”æ³¡å’Œå¤´åƒçš„ç›´æ¥å®¹å™¨ (ä¿æŒä¸å˜) */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    /* ç§»é™¤æ—§çš„ position: absolute */
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; /* é˜²æ­¢æ—¶é—´æ¢è¡Œ */
    margin-bottom: 5px;  /* è®©å®ƒå’Œæ°”æ³¡åº•éƒ¨æœ‰è½»å¾®çš„å¯¹é½åç§»ï¼Œæ›´ç¾è§‚ */
    flex-shrink: 0;      /* é˜²æ­¢è¢«å‹ç¼© */
}

        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    /* å…³é”®ï¼šåœ¨Yè½´å›åˆ°åŸä½çš„åŒæ—¶ï¼Œä¿æŒXè½´çš„å±…ä¸­å˜æ¢ */
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†ä½¿ç”¨ topï¼Œè€Œæ˜¯ç”¨ margin-top æ¥åˆ›é€ é—´è·ï¼Œæ›´ç¨³å®š */
    top: 100%; 
    margin-top: 5px; /* <-- æ–°å¢ï¼šå‘ä¸‹æ¨å¼€5åƒç´ çš„è·ç¦» */
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    overflow-x: hidden;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; /* <-- ä¿®æ”¹ï¼šå¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å†…è¾¹è·ï¼Œè®©æ¯ä¸€è¡Œæ›´é«˜æ›´å®½ */
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; /* <-- æ–°å¢ï¼šå°†å­—ä½“å¤§å°ä»é»˜è®¤å€¼æ”¾å¤§åˆ°15px */
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    /* --- æ ¸å¿ƒä¿®æ­£ --- */
    font-size: var(--chat-font-size, 13px);
    /* --- ä¿®æ­£ç»“æŸ --- */
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ .message-bubble .content æ ·å¼ â–¼â–¼â–¼ */
/* é€šç”¨å†…å®¹åŒºæ ·å¼ï¼Œä¸ºæ—¶é—´æˆ³å’Œå­—ä½“å¤§å°åšå‡†å¤‡ */
.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼ºåˆ¶é•¿å•è¯æˆ–URLæ¢è¡Œï¼Œé˜²æ­¢æ’‘ç ´æ°”æ³¡ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        /* === æ°”æ³¡ä¸»é¢˜æ ·å¼ === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

/* è¿™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ ·å¼ */
#font-preview {
    transition: font-family 0.3s ease;}

/* === èŠå¤©åˆ—è¡¨ç•Œé¢æ–°å¢æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

/* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
#chat-list-bottom-nav {
    position: absolute; /* è®©å®ƒå›ºå®šåœ¨åº•éƒ¨ */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 15; /* ç¡®ä¿å®ƒåœ¨è§†å›¾ä¹‹ä¸Š */
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

/* === åŠ¨æ€ç•Œé¢ (QZone) æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    /* position: absolute;  <-- æŠŠè¿™ä¸ªæ”¹æˆ relative */
    position: relative;
    z-index: 10; /* z-index ä¿æŒï¼Œæˆ–è€…å¯ä»¥æ›´é«˜ */
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { /* "å¥½å‹åŠ¨æ€"æ–‡å­— */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- åˆ é™¤è¿™ä¸ªï¼Œå› ä¸ºheaderä¸å†æ˜¯absoluteäº† */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px; /* è®©å¤´åƒå’Œæ˜µç§°åŒºåŸŸå‘ä¸‹åç§»ï¼Œä¸€åŠåœ¨èƒŒæ™¯æ¿å†…ï¼Œä¸€åŠåœ¨å¤– */
    left: 20px;
    display: flex;
    align-items: flex-end; /* è®©æ˜µç§°å’Œå¤´åƒåº•éƒ¨å¯¹é½ */
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; /* å¾®è°ƒä½ç½® */
}

/* ç¼–è¾‘æŒ‰é’®çš„é€šç”¨æ ·å¼ */
.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; /* ä¸æ˜µç§°çš„é—´è· */
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; /* è„±ç¦»flexå¸ƒå±€çš„å¯¹é½ */
    bottom: 5px; /* å¾®è°ƒå‚ç›´ä½ç½® */
}

/* === è®©ç¼–è¾‘åŠŸèƒ½æ›´â€œéšå½¢â€ === */
#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»æ‰‹åŠ¿ */
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; /* æ‚¬åœæ—¶ç¨å¾®å˜æš—ï¼Œç»™ç”¨æˆ·åé¦ˆ */
}
/* éšè—æ‰æ—§çš„ã€ç‹¬ç«‹çš„ç¼–è¾‘æŒ‰é’® */
.qzone-edit-btn {
    display: none;
}

/* === æ§åˆ¶ Header å’Œ Bottom Nav çš„æ˜¾éš === */
/* é»˜è®¤éšè—åŠ¨æ€ç•Œé¢çš„ Header */
#qzone-screen .qzone-header {
    display: none;
}
/* å½“åŠ¨æ€è§†å›¾æ¿€æ´»æ—¶ï¼Œæ˜¾ç¤ºå®ƒçš„Header */
#qzone-screen.active .qzone-header {
    display: flex;
}

/* å½“è¿›å…¥åŠ¨æ€è§†å›¾æ—¶ï¼Œéšè—ä¸»Headerå’Œåº•éƒ¨å¯¼èˆªæ  */
#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-list-item:first-child,
.chat-group-container:first-child {
    margin-top: 10px; 
}

/* â–²â–²â–² æ–°æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠæ‰€æœ‰è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === åŠ¨æ€åŠŸèƒ½æ æ ·å¼ === */
.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; /* ä¸Šè¾¹è·æ›´å¤§ï¼Œä¸ºæµ®åŠ¨çš„å¤´åƒç•™å‡ºç©ºé—´ */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

/* ç”¨ä¼ªå…ƒç´ åˆ›å»ºåˆ†éš”çº¿ */
.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

/* === åŠ¨æ€å¸–å­åˆ—è¡¨æ ·å¼ === */
#qzone-posts-list {
    padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºè¾¹è· */
    display: flex;
    flex-direction: column;
    gap: 20px; /* å¸–å­ä¹‹é—´çš„é—´è· */
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ç²˜è´´åˆ°æœ«å°¾ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†æ ·å¼ === */
#post-public-text {
    min-height: 80px; /* ç¡®ä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é¢„è§ˆæ¯”ä¾‹ */
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; /* ä¸Šä¼ åæ˜¾ç¤º */
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡† - æ¨¡å¼åˆ‡æ¢æ ·å¼ === */
.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; /* é»˜è®¤éƒ½éšè— */
}

.post-mode-content.active {
    display: block; /* æ¿€æ´»çš„æ‰æ˜¾ç¤º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* === ç›¸å†Œé¡µé¢èƒŒæ™¯è‰² === */
#album-screen {
    background-color: #f0f2f5; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„æµ…ç°è‰²ï¼Œæ¯”çº¯ç™½æ›´æŠ¤çœ¼ */
}

/* === ç›¸å†Œé¡µé¢ç½‘æ ¼å¸ƒå±€ === */
#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2ä¸ªç›¸å†Œ */
    gap: 15px;
}

/* === ç›¸å†Œé¡¹ç›®æ ·å¼ (ç¾åŒ–) === */
.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; /* ç»™æ•´ä¸ªé¡¹ç›®ä¹ŸåŠ ä¸ªåœ†è§’ */
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ä¸ºæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; /* å°é¢åŠ è½½å‰çš„å ä½é¢œè‰² */
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é˜²æ­¢é•¿åå­—æ¢è¡Œ */
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

/* â–²â–²â–² æ–°çš„ CSS ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ç›¸å†Œç…§ç‰‡è¯¦æƒ…é¡µ === */
#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    /* æ¯è¡Œæ˜¾ç¤º3å¼ ç…§ç‰‡ï¼Œå¹¶ä¿æŒé—´è· */
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ä¸ºæ­£æ–¹å½¢ */
    border-radius: 6px;
    overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
    background-color: #e9ecef; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½ç¬¦é¢œè‰² */
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡å®¹å™¨ä¸”ä¸å˜å½¢ */
    cursor: pointer;
}

/* åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease;
}

/* é¼ æ ‡æ‚¬åœåœ¨ç…§ç‰‡ä¸Šæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡†æ ·å¼ === */
#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸ºè§†å£çš„90% */
    max-height: 85vh; /* å›¾ç‰‡æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„85% */
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    /* ä¸ºå›¾ç‰‡çš„åˆ‡æ¢æ·»åŠ ä¸€ç‚¹å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    transition: opacity 0.2s ease-in-out;
}

/* å…³é—­æŒ‰é’® */
#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

/* å·¦å³å¯¼èˆªç®­å¤´ */
#photo-viewer-modal .nav-arrow {
    position: absolute; /* ç°åœ¨æˆ‘ä»¬ç”¨ç»å¯¹å®šä½æ¥æ§åˆ¶ç®­å¤´ */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; /* åœ¨æ‰‹æœºå±å¹•ä¸Šï¼Œå¯ä»¥ç¨å¾®å°ä¸€ç‚¹ */
    font-weight: 100;
    cursor: pointer;
    padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; /* ç¡®ä¿ç®­å¤´åœ¨æœ€ä¸Šå±‚ */
}

#photo-viewer-prev-btn {
    left: 5px; /* å®šä½å·¦ç®­å¤´ */
}

#photo-viewer-next-btn {
    right: 5px; /* å®šä½å³ç®­å¤´ */
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

/* å½“ç®­å¤´è¢«ç¦ç”¨æ—¶ï¼ˆæ¯”å¦‚ç¬¬ä¸€å¼ æˆ–æœ€åä¸€å¼ ï¼‰ */
#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°CSSæ›¿æ¢æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’åŒºCSS â–¼â–¼â–¼ */

/* === å¸–å­å†…å®¹åŒº - ç›¸å¯¹å®šä½å®¹å™¨ === */
/* === å¸–å­å†…å®¹åŒº === */
.post-main-content {
    /* å®ƒç°åœ¨åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å†…å®¹å®¹å™¨ï¼Œä¸å†éœ€è¦ç‰¹æ®Šæ ·å¼äº† */
}

/* === å¸–å­äº’åŠ¨å›¾æ ‡åŒº (æ–°æ ·å¼) === */
.post-feedback-icons {
    display: flex;
    justify-content: flex-end; /* è®©å›¾æ ‡é å³å¯¹é½ */
    align-items: center;
    gap: 12px;
    padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šç»™å›¾æ ‡åŒºåŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); /* é»˜è®¤ç°è‰² */
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* å›¾æ ‡æ¿€æ´»(ç‚¹èµ/æ”¶è—å)çš„æ ·å¼ */
.action-icon.active {
    color: #ff5252; /* æ¿€æ´»åå˜çº¢è‰² */
    transform: scale(1.1); /* è½»å¾®æ”¾å¤§ */
}

.action-icon.active.favorite {
    color: #ffc107; /* æ”¶è—ç”¨é»„è‰² */
}

.action-icon.active svg {
    fill: currentColor; /* æ¿€æ´»åå¡«å……é¢œè‰² */
}

/* ç‚¹å‡»æ—¶çš„åŠ¨ç”»æ•ˆæœ */
.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}


/* === å¸–å­åº•éƒ¨è¯„è®ºåŒºæ ·å¼ (ç°åœ¨æ˜¯ç‹¬ç«‹éƒ¨åˆ†) === */
.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /* ç”¨ä¸€æ¡æµ…è‰²çº¿åˆ†éš” */
    display: flex;
    align-items: center;
    gap: 8px; /* è°ƒæ•´æ•´ä½“é—´è· */
}

/* è¯„è®ºåŒºå®¹å™¨ */
.comment-section {
    flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

/* æ–°å¢çš„å‘é€æŒ‰é’®æ ·å¼ */
.comment-send-btn {
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯å°çº¢ç‚¹é€šç”¨æ ·å¼ === */
.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

/* èŠå¤©ç•Œé¢è¿”å›æŒ‰é’®ä¸Šçš„å°çº¢ç‚¹ (åªæ˜¾ç¤ºç‚¹ï¼Œä¸æ˜¾ç¤ºæ•°å­—) */
.back-btn-indicator {
    top: 0;
    right: -8px; /* æ”¾åˆ°è¿”å›ç®­å¤´å³ä¸Šè§’ */
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === è¯„è®ºåˆ—è¡¨å®¹å™¨ === */
.post-comments-container {
    padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ */
    display: flex;
    flex-direction: column;
    gap: 8px; /* è¯„è®ºä¹‹é—´çš„é—´è· */
    font-size: 13px; /* ç»Ÿä¸€è¯„è®ºåŒºå­—ä½“å¤§å° */
}

/* æ¯ä¸€æ¡è¯„è®º */
.comment-item {
    line-height: 1.5;
}

/* è¯„è®ºè€…çš„åå­—ï¼ŒåŠ ç²—å¹¶ä½¿ç”¨ä¸»é¢˜è‰² */
.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; /* å’Œè¯„è®ºå†…å®¹ä¹‹é—´ç•™ç‚¹ç©ºéš™ */
}

/* è¯„è®ºå†…å®¹ */
.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === å¸–å­ç‚¹èµåŒºåŸŸæ ·å¼ === */
.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding: 8px 10px; /* å†…è¾¹è· */
    font-size: 13px;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜è“è‰² */
    background-color: #f0f5fa; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; /* å’Œä¸Šæ–¹çš„å›¾æ ‡ä¿æŒä¸€ç‚¹è·ç¦» */
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; /* è®©SVGå›¾æ ‡ç»§æ‰¿çˆ¶å…ƒç´ çš„é¢œè‰² */
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === @æåŠ å¼¹å‡ºèœå•æ ·å¼ === */
.at-mention-popup {
    position: absolute; /* ç›¸å¯¹äºçˆ¶å…ƒç´ å®šä½ */
    bottom: 100%; /* æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†çš„ä¸Šæ–¹ */
    left: 40px; /* å’Œè¾“å…¥æ¡†å·¦ä¾§å¯¹é½ (è€ƒè™‘äº†å¤´åƒå®½åº¦) */
    width: calc(100% - 40px); /* å®½åº¦å’Œè¾“å…¥æ¡†å·®ä¸å¤š */
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; /* é»˜è®¤éšè— */
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€æ–°æ ·å¼ã€‘æ›¿æ¢æ‰ä½ ç°æœ‰çš„ #favorites-list æ ·å¼ â–¼â–¼â–¼ */

/* è®©æ”¶è—è§†å›¾æˆä¸ºä¸€ä¸ªflexå®¹å™¨, ä»ä¸Šåˆ°ä¸‹æ’åˆ— */
#favorites-view {
    display: flex;
    flex-direction: column;
}

/* ç¡®ä¿æ”¶è—é¡µçš„headeré«˜åº¦å›ºå®šï¼Œä¸è¢«å‹ç¼© */
#favorites-view > .header {
    flex-shrink: 0;
}

/* === æ”¶è—åˆ—è¡¨æ ·å¼ (ä¿®æ­£å) === */
#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* <-- æ–°å¢è¿™è¡Œï¼Œç¦æ­¢æ°´å¹³æ»šåŠ¨ */
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
}

/* å¡ç‰‡å¤´éƒ¨ï¼ŒåŒ…å«å¤´åƒã€åå­—å’Œæ¥æº */
.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡å†…å®¹ */
.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; /* å›¾ç‰‡å’Œæ–‡å­—çš„é—´è· */
}

/* åˆ é™¤æŒ‰é’® */
.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœç´¢æ æ ·å¼ === */
.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
    position: relative; /* ä¸ºäº†å®šä½æ¸…é™¤æŒ‰é’® */
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; /* å³ä¾§ç•™å‡ºæ¸…é™¤æŒ‰é’®çš„ä½ç½® */
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; /* åœ†è§’çŸ©å½¢ï¼Œæ›´ç°ä»£åŒ– */
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === èŠå¤©ç•Œé¢å¤šé€‰æ“ä½œæ ä¼˜åŒ– === */
#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

/* === æ”¶è—é¡µé¢å¤šé€‰æ¨¡å¼æ ·å¼ === */
#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* é€‰æ‹©æ¡†çš„æ ·å¼ */
.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦è¾¹å¤–é¢ */
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶ï¼Œå¡ç‰‡å‘å³ç§»åŠ¨ï¼Œéœ²å‡ºé€‰æ‹©æ¡† */
#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

/* é€‰ä¸­åçš„æ ·å¼ */
#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/* åº•éƒ¨æ“ä½œæ  (ç»ˆæä¿®æ­£ç‰ˆ) */
#favorites-action-bar {
    position: absolute; /* â˜… æ”¹ä¸º absoluteï¼Œç›¸å¯¹äº #phone-screen å®šä½ */
    bottom: 0;
    left: 0;
    right: 0;           /* â˜… æ–°å¢ right: 0ï¼Œå’Œ left: 0 ä¸€èµ·æ’‘æ»¡å®½åº¦ */
    width: auto;        /* â˜… æ”¹ä¸º autoï¼Œè®© left/right å†³å®šå®½åº¦ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    /* max-width å·²ç»ä¸éœ€è¦äº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ å·²ç»é™åˆ¶äº†å®½åº¦ */
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

/* === ã€ä¿®æ­£ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨æ§ä»¶åˆ‡æ¢é€»è¾‘ === */

/* é»˜è®¤çŠ¶æ€ï¼šéšè—å¤šé€‰æ§ä»¶ */
#chat-interface-screen .header .selection-controls {
    display: none;
}

/* é»˜è®¤çŠ¶æ€ï¼šæ˜¾ç¤ºé»˜è®¤æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šéšè—é»˜è®¤æ§ä»¶ */
#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šæ˜¾ç¤ºå¤šé€‰æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šæ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€å·æŒ‰é’® === */
#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   /* æ˜¾è‘—å¢å¤§å­—ä½“å¤§å°ï¼Œä½¿å…¶è§†è§‰ä¸Šä¸æ—è¾¹çš„å›¾æ ‡åŒ¹é… */
    font-weight: 300;  /* ä½¿ç”¨æ›´ç»†çš„å­—é‡ï¼Œè®©åŠ å·çœ‹èµ·æ¥æ›´æ¸…çˆ½ï¼Œä¸æ˜¾ç²—ç¬¨ */
    position: relative;/* å…è®¸è¿›è¡Œä½ç½®å¾®è°ƒ */
    top: -1px;         /* å­—ä½“æ”¾å¤§åï¼Œé€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ï¼Œä½¿å…¶è§†è§‰ä¸Šæ›´å±…ä¸­ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* é¢„è§ˆåŒºå®¹å™¨æ ·å¼ */
#settings-preview-area {
    width: 100%;
    height: 180px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    display: flex;
    flex-direction: column;
    gap: 10px; /* é¢„è§ˆæ°”æ³¡ä¹‹é—´çš„é—´è· */
    border: 1px solid var(--border-color);
    position: relative; /* ä¸ºäº†å®šä½èƒŒæ™¯ */
}

/* é¢„è§ˆåŒºçš„èƒŒæ™¯ï¼Œå¯ä»¥å’ŒçœŸå®èŠå¤©ç•Œé¢åŒæ­¥ */
#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}

/* è®©é¢„è§ˆæ°”æ³¡åœ¨èƒŒæ™¯ä¹‹ä¸Š */
#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}

/* é¢„è§ˆåŒºå†…ä½¿ç”¨çš„å¤´åƒè¦å°ä¸€ç‚¹ */
#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}

#settings-preview-area .message-bubble .timestamp {
    display: none; /* é¢„è§ˆåŒºä¸éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}

.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„å®¹å™¨ */
.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; /* ä¸ä¸‹æ–¹çš„æ–‡æœ¬æ¡†æ‹‰å¼€è·ç¦» */
    flex-wrap: wrap; /* å¦‚æœæŒ‰é’®å¤ªå¤šå¯ä»¥æ¢è¡Œ */
}

/* å•ä¸ªæ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„æ ·å¼ */
.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œæ›´å‹å¥½ */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â€œâ€¦â€æŒ‰é’®çš„æ ·å¼ */
.post-actions-btn {
    margin-left: auto; /* å…³é”®ï¼šè®©å®ƒè‡ªåŠ¨é åˆ°æœ€å³è¾¹ */
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

/* åŠ¨æ€ç¼–è¾‘æ¨¡æ€æ¡†çš„æ ·å¼ (å®ƒå°†å¤ç”¨ç°æœ‰çš„æ“ä½œèœå•æ ·å¼) */
#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ç»Ÿä¸€é‡ç½®è½¬è´¦å¡ç‰‡å†…æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¢œè‰² */
#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; /* å¼ºåˆ¶ç§»é™¤ä»»ä½•å‘å…‰æˆ–é˜´å½±æ•ˆæœ */
    color: white !important;      /* å¼ºåˆ¶é”å®šæ–‡å­—é¢œè‰²ä¸ºç™½è‰² */
}

/* åˆ†åˆ«é”å®šå„è‡ªçš„å­—ä½“å¤§å°å’Œå­—é‡ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ */
#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼ï¼Œç”¨äºä¿®æ­£æ‰€æœ‰å¤´éƒ¨æ ‡é¢˜çš„å±…ä¸­é—®é¢˜ â–¼â–¼â–¼ */
.header > span:nth-child(2),
#chat-header-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¡€ä¸Šï¼Œå†å‘å·¦æ¨2åƒç´  */
    
    /* (å¯é€‰ä½†æ¨è) é˜²æ­¢é•¿æ ‡é¢˜ä¸ä¸¤è¾¹æŒ‰é’®é‡å  */
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ ·å¼ â–¼â–¼â–¼ */
#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; /* è¦†ç›–é»˜è®¤çš„ margin-bottom */
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è”ç³»äººé€‰æ‹©å™¨æ ·å¼ â–¼â–¼â–¼ */
.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#member-management-list {
    padding: 0; /* ç§»é™¤é»˜è®¤paddingï¼Œè®©åˆ—è¡¨é¡¹æ’‘æ»¡ */
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; /* æ–°å»ºç”¨ç»¿è‰²ï¼Œä»¥ç¤ºåŒºåˆ† */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–ä»£ä»˜å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; /* æ©™é»„è‰²èƒŒæ™¯ */
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–å“åº”çŠ¶æ€æ ·å¼ â–¼â–¼â–¼ */

/* === åŒæ„æ”¯ä»˜åçš„æ ·å¼ === */
.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; /* ç»¿è‰²è¾¹æ¡† */
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: 'âœ…  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    /* é‡å†™ request-title çš„å†…å®¹ */
    content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•ï¼Œè¯·å°½æƒ…äº«ç”¨å§ï½" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}

/* === æ‹’ç»æ”¯ä»˜åçš„æ ·å¼ === */
.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; /* çº¢è‰²è¾¹æ¡† */
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: 'âŒ ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    /* é‡å†™ request-title çš„å†…å®¹ */
    content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}

/* å¼ºåˆ¶é‡å†™ request-title å†…å®¹çš„æŠ€å·§ */
.message-bubble[class*="status-"] .request-title {
    font-size: 0; /* éšè—åŸå§‹æ–‡æœ¬ */
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; /* è®©ä¼ªå…ƒç´ æ˜¾ç¤ºæ–°æ–‡æœ¬ */
}
.message-bubble.status-paid .request-title::after {
    content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•ï¼Œè¯·å°½æƒ…äº«ç”¨å§ï½";
}
.message-bubble.status-rejected .request-title::after {
    content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚";
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚çš„ç”¨æˆ·æ“ä½œæŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; /* åœ¨å¡ç‰‡åº•éƒ¨ç•™å‡ºç©ºé—´ */
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€æ–°å¢ã€‘ç»Ÿä¸€è®¾ç½®é¡µé¢çš„èƒŒæ™¯è‰² (å·²ä¿®æ­£) === */
#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#memories-view,
#contact-picker-screen,
#member-management-screen,
#world-book-editor-screen {  
    background-color: var(--secondary-bg);
}

/* ç¡®ä¿è¿™äº›é¡µé¢çš„å†…å®¹åŒºèƒ½æ­£ç¡®æ»šåŠ¨ */
#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    background-color: var(--secondary-bg);
}

/* å£çº¸è®¾ç½®é¡µé¢çš„é¢„è§ˆåŒºæ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦é¢å¤–è°ƒæ•´ */
#wallpaper-screen .form-container {
    align-items: center; /* ä¿æŒå†…å®¹å±…ä¸­ */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚ä¸è§†é¢‘é€šè¯ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */

/* --- æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† --- */
#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    width: 280px;
    padding: 30px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.caller-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid rgba(255,255,255,0.5);
}

.caller-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.caller-text {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 30px;
}

.incoming-call-actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.action-button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-size: 50%;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active {
    transform: scale(0.9);
}

.call-action-btn.decline {
    background-color: #ff3b30;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}

.call-action-btn.accept {
    background-color: #4cd964;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}

/* --- è§†é¢‘é€šè¯ç•Œé¢ --- */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸€æ•´å—ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„ video-call ç›¸å…³CSS â–¼â–¼â–¼ */

/* 1. é€šè¯å±å¹•æ€»å®¹å™¨ (ä¿æŒä¸å˜) */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 2. é¡¶éƒ¨æ å’Œåº•éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) */
.video-call-top-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding: 15px 20px;
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    text-align: center;
    box-sizing: border-box;
    pointer-events: none;
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}
.video-call-controls {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    box-sizing: border-box;
}

/* 3. å‚ä¸è€…å¤´åƒæ˜¾ç¤ºåŒº (ä¿æŒä¸å˜) */
.video-call-avatar-area {
    flex-grow: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    padding-top: 80px; /* ç¡®ä¿é¡¶éƒ¨æœ‰è¶³å¤Ÿç©ºé—´ */
    box-sizing: border-box;
    overflow-y: auto; /* â˜… æ–°å¢ï¼šå¦‚æœå¤´åƒå¤ªå¤šï¼Œå…è®¸æ­¤åŒºåŸŸæ»šåŠ¨ */
}

/* 4. å¤´åƒç½‘æ ¼å®¹å™¨ (ä¿æŒä¸å˜) */
#participant-avatars-grid {
    display: flex;
    flex-wrap: wrap; 
    justify-content: center;
    align-items: center;
    gap: 15px; /* â˜… ç¨å¾®å‡å°å¤´åƒé—´è· */
    max-width: 100%;
}

/* 5. å•ä¸ªå‚ä¸è€…çš„å¤´åƒå®¹å™¨ (å¤´åƒç¼©å°) */
.participant-avatar-wrapper {
    position: relative;
    text-align: center;
    flex-shrink: 0;
}
.participant-avatar {
    width: 70px;   /* â˜… ä» 80px ç¼©å°åˆ° 70px */
    height: 70px;  /* â˜… ä» 80px ç¼©å°åˆ° 70px */
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 12px;
    color: #ccc;
}

/* 6. å‘è¨€è€…å¤´åƒé«˜äº®æ•ˆæœ (ä¿æŒä¸å˜) */
.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

/* 7. ã€æœ€ç»ˆç‰ˆã€‘å¯¹è¯æ¡†åŒºåŸŸ */
#video-call-main {
    flex-shrink: 0; 
    height: 30%;   /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šé«˜åº¦ä»35%å‡å°åˆ°30% */
    margin: 15px 15px 130px 15px; /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåº•éƒ¨è¾¹è·ä»120pxå¢åŠ åˆ°130pxï¼Œåˆ›é€ æ˜æ˜¾ç©ºéš™ */
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box;
}

/* 8. æ§åˆ¶æŒ‰é’®æ ·å¼ (ä¿æŒä¸å˜) */
.control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, background-color 0.2s;
}
.control-btn:active {
    transform: scale(0.9);
}
.control-btn.speak-btn {
    background-color: rgba(255,255,255,0.2);
    background-size: 55%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
}
.control-btn.hangup-btn {
    background-color: #ff3b30;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}
.control-btn.join-btn {
    background-color: #007bff;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
}

/* â–²â–²â–² æ–°CSSæ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯å¯¹è¯æ°”æ³¡æ ·å¼ â–¼â–¼â–¼ */
.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; /* AIå‘è¨€é å·¦ */
}

.call-message-bubble.user-speech {
    background-color: #4cd964; /* ç”¨æˆ·å‘è¨€ç”¨ç»¿è‰²ï¼Œç±»ä¼¼å¾®ä¿¡ */
    align-self: flex-end;   /* ç”¨æˆ·å‘è¨€é å³ */
    text-align: left; /* ç¡®ä¿ç”¨æˆ·æ°”æ³¡å†…çš„æ–‡å­—æ˜¯å·¦å¯¹é½çš„ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    align-items: center;   /* æ°´å¹³å±…ä¸­ */
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; /* å’Œä¸Šæ–¹æ–‡å­—æ‹‰å¼€è·ç¦» */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

/* 1. åŠ¨æ€å¸–å­çš„å¤–å±‚å®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ¥å®šä½å’Œè£å‰ª */
.qzone-post-container {
    position: relative; /* è®©å†…éƒ¨çš„åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    overflow: hidden;   /* éšè—æ‰è¶…å‡ºéƒ¨åˆ†çš„åˆ é™¤æŒ‰é’® */
    border-radius: 12px;/* å’Œå†…éƒ¨å¡ç‰‡ä¿æŒä¸€è‡´çš„åœ†è§’ */
}

/* 2. å¯æ»‘åŠ¨çš„å†…å®¹å¡ç‰‡ï¼Œå¢åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
.qzone-post-item {
    transition: transform 0.3s ease;
    background-color: var(--secondary-bg); /* ç¡®ä¿å®ƒæœ‰èƒŒæ™¯è‰²ï¼Œèƒ½ç›–ä½ä¸‹é¢çš„åˆ é™¤æŒ‰é’® */
    position: relative; /* ç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ */
    z-index: 2;
}

/* 3. ã€æ ¸å¿ƒã€‘è¿™å°±æ˜¯é‚£ä¸ªâ€œåˆ é™¤â€æŒ‰é’®çš„æ ·å¼ï¼*/
.qzone-post-delete-action {
    position: absolute; /* ç»å¯¹å®šä½ï¼Œè„±ç¦»æ–‡æ¡£æµ */
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
    background-color: #ff3b30; /* æ‚¨æƒ³è¦çš„çº¢è‰²èƒŒæ™¯ */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1; /* ç¡®ä¿å®ƒåœ¨å¡ç‰‡ä¸‹é¢ */
}

/* 4. å½“å¡ç‰‡å·¦æ»‘æ—¶ï¼ŒæŠŠå®ƒå‘å·¦ç§»åŠ¨ï¼Œéœ²å‡ºåˆ é™¤æŒ‰é’® */
.qzone-post-item.swiped {
    transform: translateX(-90px); /* ç§»åŠ¨çš„è·ç¦»å’Œåˆ é™¤æŒ‰é’®çš„å®½åº¦ä¸€è‡´ */
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„â€œæ‹ä¸€æ‹â€æ ·å¼ï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. â€œæ‹ä¸€æ‹â€çš„å±å¹•éœ‡åŠ¨åŠ¨ç”» */
@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}

/* 2. â€œæ‹ä¸€æ‹â€ç³»ç»Ÿæç¤ºæ¶ˆæ¯çš„æ ·å¼ */
.system-message {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* è®©â€œæ‹ä¸€æ‹â€ç±»å‹çš„ wrapper å±…ä¸­ */
.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}
/* â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯æ°”æ³¡çš„æ ·å¼ */
.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šè®©é¡¶éƒ¨æ“ä½œæ å¯ä»¥æ¨ªå‘æ»šåŠ¨ === */
#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;

    /* --- æ ¸å¿ƒä»£ç å¼€å§‹ --- */
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 

    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨çŠ¶æ€æ æ ·å¼ === */

/* 1. æ ‡é¢˜å’ŒçŠ¶æ€çš„æ€»å®¹å™¨ï¼Œä½¿ç”¨flexå¸ƒå±€è®©å®ƒä»¬å‚ç›´æ’åˆ— */
#chat-header-title-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center; /* æ°´å¹³å±…ä¸­ */
    gap: 2px; /* æ ‡é¢˜å’ŒçŠ¶æ€ä¹‹é—´çš„å¾®å°é—´è· */
    
    /* ä¸ºäº†è®©å®ƒèƒ½åœ¨flexå¸ƒå±€ä¸­æ­£ç¡®å±…ä¸­ */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    max-width: 60%;
}

/* 2. ä¸»æ ‡é¢˜çš„æ ·å¼å¾®è°ƒ */
#chat-header-title {
    font-size: 16px; /* å¯ä»¥ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œç»™çŠ¶æ€æ ç•™å‡ºç©ºé—´ */
    font-weight: 600;
    position: static; /* è¦†ç›–æ‰æ—§çš„absoluteå®šä½ */
    transform: none;  /* è¦†ç›–æ‰æ—§çš„transform */
    /* ä¿è¯é•¿æ ‡é¢˜ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤ºçœç•¥å· */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* 3. çŠ¶æ€æ å®¹å™¨ */
#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

/* 4. çŠ¶æ€å°åœ†ç‚¹ */
.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: #4cd964; /* é»˜è®¤ç»¿è‰²ï¼Œä»£è¡¨åœ¨çº¿ */
    transition: background-color 0.3s ease;
}

/* å½“AIçŠ¶æ€ä¸ºâ€œå¿™ç¢Œâ€æˆ–â€œç¦»å¼€â€æ—¶ï¼Œè®©åœ†ç‚¹å˜ç°è‰² */
#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}

/* 5. çŠ¶æ€æ–‡æœ¬ */
.status-text {
    font-weight: 500;
}

/* === ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘å›å¿†å¡ç‰‡æ ·å¼ === */

/* 1. å¡ç‰‡æ€»å®¹å™¨ï¼šè¿™é‡Œè´Ÿè´£å®šä¹‰æ•´ä½“çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡† */
.memory-card {
    background-color: #fffaf0; /* ç»Ÿä¸€çš„ã€æ¸©æš–çš„ç±³é»„è‰²èƒŒæ™¯ */
    border-radius: 12px;
    padding: 15px; /* åœ¨å¡ç‰‡å››å‘¨ç•™å‡ºå†…è¾¹è· */
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; /* è®©å®ƒæˆä¸ºflexå®¹å™¨ï¼Œæ–¹ä¾¿å†…éƒ¨å…ƒç´ æ’åˆ— */
    flex-direction: column; /* è®©å¤´éƒ¨å’Œå†…å®¹å‚ç›´å †å  */
    gap: 8px; /* åœ¨å¤´éƒ¨å’Œå†…å®¹ä¹‹é—´åˆ›é€ ä¸€ä¸ªè‡ªç„¶çš„é—´è· */
}

/* 2. å¤´éƒ¨å®¹å™¨ï¼šç°åœ¨åªè´Ÿè´£å¸ƒå±€å’Œåˆ†å‰²çº¿ */
.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* åˆ†å‰²çº¿é¢œè‰²å¯ä»¥ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
    padding-bottom: 8px; 
}

/* 3. æ—¥æœŸæ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}

/* 4. ä½œè€…æ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5. å†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}

/* === ã€å…¨æ–°ã€‘çº¦å®š/å€’è®¡æ—¶å¡ç‰‡æ ·å¼ === */
.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: 'âœ¨';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}

/* === ã€å…¨æ–°ã€‘èŠå¤©é”å®šé®ç½©å±‚æ ·å¼ === */
#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; /* æ¯”è¾“å…¥æ¡†é«˜ï¼Œæ¯”è´´çº¸é¢æ¿ä½ */
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700; /* é‡‘è‰²æ–‡å­— */
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: 'ğŸ§§';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* æŠ•ç¥¨å¡ç‰‡åœ¨æ¶ˆæ¯æ°”æ³¡ä¸­çš„æ ·å¼ */
.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* æŠ•ç¥¨å¡ç‰‡ä¸»ä½“ */
.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; /* ç»“æŸåå˜ç° */
}

/* æŠ•ç¥¨é—®é¢˜ */
.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}

/* æŠ•ç¥¨é€‰é¡¹åˆ—è¡¨ */
.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* å•ä¸ªæŠ•ç¥¨é€‰é¡¹ */
.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}

/* ç”¨æˆ·å·²æŠ•ç¥¨çš„é€‰é¡¹æ ·å¼ */
.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}

/* æŠ•ç¥¨è¿›åº¦æ¡ */
.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}

/* é€‰é¡¹å†…å®¹ï¼ˆæ–‡å­—å’Œç¥¨æ•°ï¼‰ï¼Œç¡®ä¿åœ¨è¿›åº¦æ¡ä¹‹ä¸Š */
.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}

/* æŠ•ç¥¨å¡ç‰‡åº•éƒ¨ */
.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

/* åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡†çš„é€‰é¡¹è¾“å…¥ */
.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©å¤´éƒ¨â€œæ­£åœ¨è¾“å…¥â€çŠ¶æ€æ ·å¼ === */
#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Appå›¾æ ‡è®¾ç½®æ ·å¼ â–¼â–¼â–¼ */
#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§‚è®¾ç½®é¡µé¢å¸ƒå±€ä¿®æ­£ â–¼â–¼â–¼ */

/* 1. ä¿®æ­£æ»šåŠ¨é—®é¢˜ */
#wallpaper-screen .form-container {
    /* æ ¸å¿ƒä¿®æ­£1: è§£å†³flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å†²çªï¼Œè®©æ»šåŠ¨æ¡èƒ½æ­£å¸¸å‡ºç° */
    min-height: 0; 
}

/* 2. ä¿®æ­£å£çº¸é¢„è§ˆè¢«å‹æ‰çš„é—®é¢˜ */
#wallpaper-preview {
    /* æ ¸å¿ƒä¿®æ­£2: é˜²æ­¢é¢„è§ˆæ¡†è¢«è¿‡å¤šçš„å†…å®¹æŒ¤å‹å˜å½¢ï¼Œè®©å®ƒä¿æŒè‡ªå·±çš„é«˜åº¦ */
    flex-shrink: 0; 
}
/* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½æ ·å¼ (æ— å›¾ç‰ˆ) â–¼â–¼â–¼ */

/* 1. æµè§ˆå™¨ç•Œé¢èƒŒæ™¯è‰²å’Œå†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}

/* 2. èŠå¤©æ°”æ³¡ä¸­çš„é“¾æ¥å¡ç‰‡æ ·å¼ (æ— å›¾ç‰ˆ) */
.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 210px; 
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; /* è®©å›¾æ ‡å’Œæ–‡å­—æ°´å¹³å¯¹é½ */
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; /* å’Œä¸Šé¢çš„æè¿°æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å•æ¡è¯„è®ºçš„å®¹å™¨ï¼Œç°åœ¨éœ€è¦ç›¸å¯¹å®šä½ */
.comment-item {
    position: relative;
    padding-right: 25px; /* åœ¨å³ä¾§ç•™å‡ºåˆ é™¤æŒ‰é’®çš„ç©ºé—´ */
}

/* è¯„è®ºåˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* é¼ æ ‡æ‚¬åœåœ¨è¯„è®ºä¸Šæ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.comment-item:hover .comment-delete-btn {
    opacity: 1;
}

.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘å¤œé—´æ¨¡å¼æ ·å¼ === */

/* æ ¸å¿ƒï¼šå½“ #phone-screen æ‹¥æœ‰ .dark-mode ç±»æ—¶ï¼Œæ¿€æ´»ä»¥ä¸‹æ‰€æœ‰æ ·å¼ */

/* 1. å…¨å±€èƒŒæ™¯å’Œæ–‡æœ¬é¢œè‰² */
#phone-screen.dark-mode {
    --secondary-bg: #1c1c1e; /* ä¸»è¦å¡ç‰‡èƒŒæ™¯è‰² */
    --border-color: #38383a;  /* è¾¹æ¡†é¢œè‰² */
    --text-primary: #ffffff;   /* ä¸»è¦æ–‡å­—é¢œè‰² */
    --text-secondary: #8d8d92; /* æ¬¡è¦æ–‡å­—/å›¾æ ‡é¢œè‰² */
}

/* 2. å„ä¸ªé¡µé¢çš„ä¸»èƒŒæ™¯è‰² */
#phone-screen.dark-mode #chat-list-screen,
#phone-screen.dark-mode #qzone-screen .qzone-content,
#phone-screen.dark-mode #memories-view {
    background-color: #000000;
}

/* 3. èŠå¤©åˆ—è¡¨ */
#phone-screen.dark-mode #chat-list {
    background-color: #000000;
}
#phone-screen.dark-mode .chat-list-item {
    border-bottom-color: rgba(255, 255, 255, 0.15);
}
#phone-screen.dark-mode .chat-group-header {
    background-color: #1c1c1e; /* ä»ç™½è‰²æ”¹ä¸ºæ·±ç°è‰² */
    border-bottom: 1px solid #38383a; /* ç»™å®ƒä¸€ä¸ªç»†å¾®çš„ä¸‹è¾¹æ¡† */
}
#phone-screen.dark-mode .chat-list-item .name,
#phone-screen.dark-mode .chat-group-header .group-name {
    color: #ffffff;
}
#phone-screen.dark-mode .chat-list-item:hover {
    background-color: #1c1c1e;
}

/* 4. é¡¶éƒ¨/åº•éƒ¨å¯¼èˆªæ  */
#phone-screen.dark-mode .header,
#phone-screen.dark-mode .qzone-header {
    background-color: rgba(25, 25, 25, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-bottom-color: rgba(255, 255, 255, 0.15);
    color: #ffffff;
}
#phone-screen.dark-mode .header .back-btn,
#phone-screen.dark-mode .header .action-btn,
#phone-screen.dark-mode .header .save-btn {
    color: #ffffff;
}
#phone-screen.dark-mode #chat-list-bottom-nav {
    background-color: rgba(25, 25, 25, 0.9);
    border-top-color: rgba(255, 255, 255, 0.15);
}
#phone-screen.dark-mode .nav-item.active {
    color: #ffffff;
}

/* 5. èŠå¤©ç•Œé¢ */
#phone-screen.dark-mode #chat-input-area {
    background-color: rgba(5, 5, 5, 0.8);
    border-top: none;
}
#phone-screen.dark-mode #chat-input {
    background-color: #3e3e42;
    color: #ffffff;
}
#phone-screen.dark-mode #chat-input::placeholder {
    color: #8d8d92;
}
#phone-screen.dark-mode .chat-action-icon-btn {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
    border: none;
}
#phone-screen.dark-mode #send-btn {
    background-color: var(--accent-color);
}

/* 6. åŠ¨æ€ (QZone) ç•Œé¢ */
#phone-screen.dark-mode .qzone-actions-bar,
#phone-screen.dark-mode .qzone-post-item {
    background-color: #1c1c1e;
    border: 1px solid #333;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
}
#phone-screen.dark-mode .action-item:not(:last-child)::after {
    background-color: #333;
}
#phone-screen.dark-mode .post-footer,
#phone-screen.dark-mode .post-likes-section {
    border-top-color: #333;
}
#phone-screen.dark-mode .post-likes-section {
    background-color: rgba(0, 123, 255, 0.1);
}
#phone-screen.dark-mode .comment-input {
    background-color: #333;
    color: #ffffff;
}
#phone-screen.dark-mode .comment-input::placeholder {
    color: #8d8d92;
}
#phone-screen.dark-mode .post-actions-btn:hover {
    background-color: #333;
}
#phone-screen.dark-mode .at-mention-popup {
    background-color: #1c1c1e;
    border-color: #333;
}
#phone-screen.dark-mode .at-mention-item {
    border-bottom-color: #333;
}
#phone-screen.dark-mode .at-mention-item:hover {
    background-color: #333;
}

/* 7. å›å¿†å½•ç•Œé¢ */
#phone-screen.dark-mode .memory-card {
    background-color: #1c1c1e;
    border-left-color: #e6a753;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
}
#phone-screen.dark-mode .memory-card .header {
    background-color: #2c2c2e;
    border-bottom-color: #38383a;
    margin: -15px -15px 8px -15px;
    padding: 12px 15px;
    border-radius: 12px 12px 0 0;
}
#phone-screen.dark-mode .memory-card .header .date,
#phone-screen.dark-mode .memory-card .header .author,
#phone-screen.dark-mode .memory-card .content {
    color: #e0e0e0;
}

/* 8. å…¶ä»–è®¾ç½®å’Œåˆ—è¡¨é¡µ */
#phone-screen.dark-mode #api-settings-screen,
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #wallpaper-screen,
#phone-screen.dark-mode #contact-picker-screen,
#phone-screen.dark-mode #member-management-screen,
#phone-screen.dark-mode #world-book-editor-screen,
#phone-screen.dark-mode #world-book-list,
#phone-screen.dark-mode .list-item:hover,
#phone-screen.dark-mode .list-container,
#phone-screen.dark-mode .form-container {
    background-color: #000000;
}
#phone-screen.dark-mode .form-group input, 
#phone-screen.dark-mode .form-group select, 
#phone-screen.dark-mode .form-group textarea {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
#phone-screen.dark-mode .form-button-secondary {
    background-color: #333;
    border-color: #555;
    color: #fff;
}
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e;
    border-color: #38383a;
}
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—ã€å…¨æ–°çš„ä¿®æ­£CSSã€‘ï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘å¤œé—´æ¨¡å¼è§†è§‰ä¿®æ­£ === */

/* 1. ä¿®æ­£åŠ¨æ€å¡ç‰‡å†…çš„æ–‡å­—é¢œè‰² */
#phone-screen.dark-mode .qzone-post-item .post-nickname,
#phone-screen.dark-mode .qzone-post-item .post-content {
    color: #f0f0f0; /* ä»æ·±ç°è‰²æ”¹ä¸ºæ˜äº®çš„æµ…ç°è‰² */
}

/* 2. ä¿®æ­£æ”¶è—å¡ç‰‡å†…çš„æ–‡å­—é¢œè‰² */
#phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
#phone-screen.dark-mode .favorite-item-card .fav-card-content {
    color: #f0f0f0; /* åŒæ ·æ”¹ä¸ºæµ…ç°è‰² */
}
#phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
    color: #8d8d92; /* æ¥æºæ–‡å­—ç”¨æ¬¡è¦ç°è‰² */
}

/* 3. ä¿®æ­£æ”¶è—é¡µçš„æœç´¢æ èƒŒæ™¯å’Œè¾“å…¥æ¡†æ ·å¼ */
#phone-screen.dark-mode .search-bar-container {
    background-color: #000000; /* å®¹å™¨èƒŒæ™¯å˜ä¸ºçº¯é»‘ */
}
#phone-screen.dark-mode #favorites-search-input {
    background-color: #1c1c1e; /* è¾“å…¥æ¡†èƒŒæ™¯å˜ä¸ºæ·±ç° */
    border-color: #38383a;     /* è¾¹æ¡†é¢œè‰²å˜æš— */
    color: #ffffff;            /* è¾“å…¥æ–‡å­—å˜ä¸ºç™½è‰² */
}
#phone-screen.dark-mode #favorites-search-input::placeholder {
    color: #8d8d92; /* å ä½ç¬¦æ–‡å­—é¢œè‰²å˜æš— */
}

/* â–²â–²â–² ä¿®æ­£CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘iOSé£æ ¼çš„Toggle Switchå¼€å…³æ ·å¼ === */

/* 1. å¼€å…³çš„å®¹å™¨ */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
}

/* 2. éšè—æ‰åŸå§‹çš„ checkbox è¾“å…¥æ¡† */
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

/* 3. å¼€å…³çš„èƒŒæ™¯ï¼ˆé‚£ä¸ªæ¤­åœ†ï¼‰ */
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e9e9eb; /* å…³é—­æ—¶çš„èƒŒæ™¯è‰² */
    transition: .4s;
    border-radius: 34px;
}

/* 4. å¼€å…³ä¸Šçš„åœ†ç‚¹ */
.slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* 5. ã€æ ¸å¿ƒã€‘å½“ checkbox è¢«é€‰ä¸­æ—¶ï¼ˆå³å¼€å¯çŠ¶æ€ï¼‰ */
input:checked + .slider {
    background-color: #34c759; /* å¼€å¯æ—¶çš„èƒŒæ™¯è‰²ï¼ˆiOSç»¿è‰²ï¼‰*/
}

input:checked + .slider:before {
    transform: translateX(20px); /* è®©åœ†ç‚¹æ»‘åŠ¨åˆ°å³è¾¹ */
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„â€œå›å¤é¢„è§ˆæ â€ */
#reply-preview-bar {
    display: none; /* é»˜è®¤éšè— */
    padding: 8px 12px;
    margin: 0 8px 8px 8px; /* å’Œè¾“å…¥æ¡†å‘¨å›´çš„è¾¹è·ä¿æŒä¸€è‡´ */
    background-color: rgba(0, 0, 0, 0.05);
    border-left: 3px solid var(--accent-color);
    border-radius: 6px;
    position: relative;
    font-size: 13px;
    color: var(--text-secondary);
}

#phone-screen.dark-mode #reply-preview-bar {
    background-color: rgba(255, 255, 255, 0.1);
}

.reply-preview-content .sender {
    font-weight: 600;
    color: var(--text-primary);
}

.reply-preview-content .text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block; /* ç¡®ä¿çœç•¥å·ç”Ÿæ•ˆ */
    max-width: 95%;
}

#cancel-reply-btn {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.1);
    cursor: pointer;
    font-size: 14px;
}

/* 2. æ¶ˆæ¯æ°”æ³¡å†…éƒ¨çš„â€œå¼•ç”¨æ¶ˆæ¯å—â€ */
.quoted-message {
    padding: 6px 10px;
    margin-bottom: 6px;
    background-color: rgba(0, 0, 0, 0.04);
    border-left: 2px solid var(--accent-color);
    border-radius: 4px;
    font-size: 0.9em; /* å­—ä½“æ¯”æ­£æ–‡å°ä¸€ç‚¹ */
    opacity: 0.8;
    /* (å·²ç§»é™¤ overflow: hidden;) */
}

#phone-screen.dark-mode .quoted-message {
    background-color: rgba(255, 255, 255, 0.08);
    border-left-color: #a0cff1;
}

.quoted-message .quoted-sender {
    font-weight: 600;
    color: var(--accent-color);
}
#phone-screen.dark-mode .quoted-message .quoted-sender {
    color: #a0cff1;
}

.quoted-message .quoted-content {
    color: var(--text-secondary);
    white-space: normal;     /* æ ¸å¿ƒä¿®æ­£1: å…è®¸æ–‡æœ¬æ­£å¸¸æ¢è¡Œ */
    word-break: break-word;  /* æ ¸å¿ƒä¿®æ­£2: å¼ºåˆ¶é•¿å•è¯æˆ–è¿ç»­å­—ç¬¦æ–­å¼€ï¼Œé˜²æ­¢æº¢å‡º */
    display: block;
    /* (å·²ç§»é™¤ overflow å’Œ text-overflowï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å¤šè¡Œæ˜¾ç¤ºè€Œä¸æ˜¯å•è¡Œçœç•¥å·) */
}

/* === å­—ä½“é¢„è§ˆæ¡†æ ·å¼ (ä¿®æ­£å) === */

/* é»˜è®¤ï¼ˆæ—¥é—´æ¨¡å¼ï¼‰çš„æ ·å¼ */
#font-preview {
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f9f9f9; /* æ—¥é—´æ¨¡å¼çš„æµ…ç°è‰²èƒŒæ™¯ */
    transition: background-color 0.3s, border-color 0.3s;
}

/* é¢„è§ˆæ¡†é‡Œçš„æ–‡å­—é¢œè‰²ï¼Œé»˜è®¤æ˜¯é»‘è‰² */
#font-preview p {
    color: var(--text-primary);
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„ä¿®æ­£æ ·å¼ */
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e; /* æ·±ç°è‰²èƒŒæ™¯ */
    border-color: #38383a;     /* æš—è‰²è¾¹æ¡† */
}

/* å¤œé—´æ¨¡å¼ä¸‹ï¼Œé¢„è§ˆæ¡†é‡Œçš„æ–‡å­—å˜ä¸ºç™½è‰² */
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
.transfer-actions-content {
    background-color: #fff0f5; /* ç²‰å«©çš„èƒŒæ™¯è‰² */
    border-radius: 20px;
    width: 290px;
    padding: 20px;
    box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* ç²‰è‰²é˜´å½± */
    text-align: center;
    position: relative;
    border: 1px solid #ffcce0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.transfer-actions-header {
    font-size: 20px;
    font-weight: bold;
    color: #a35c7b; /* æ·±ç²‰è‰²æ ‡é¢˜ */
    margin-bottom: 15px;
}

.transfer-actions-body p {
    font-size: 15px;
    color: #555;
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.transfer-actions-footer {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.transfer-actions-footer .action-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    color: white;
}

.transfer-actions-footer .action-btn:active {
    transform: scale(0.95);
}

.transfer-actions-footer .action-btn.accept {
    background: linear-gradient(135deg, #ff85b3, #ff69b4);
    box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
}

.transfer-actions-footer .action-btn.decline {
    background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.transfer-actions-content .cancel-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: #a35c7b;
    font-size: 20px;
    line-height: 28px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯çº¢ç‚¹æ ·å¼ === */
.unread-count-wrapper {
    flex-shrink: 0;
    width: 40px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 20px; /* è®©çº¢ç‚¹å’Œåå­—å·®ä¸å¤šé«˜ */
}

.unread-count {
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background-color: #ff3b30; /* iOS é£æ ¼çš„çº¢è‰² */
    color: white;
    font-size: 13px;
    font-weight: 500;
    line-height: 20px;
    text-align: center;
    border-radius: 10px; /* åœ†è§’çŸ©å½¢ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ä¸å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */

/* ç¡®ä¿é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
#call-history-screen {
    background-color: #f0f2f5;
}

/* é€šè¯è®°å½•å¡ç‰‡æ ·å¼ */
.call-record-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 5px solid var(--accent-color);
}
.call-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/* å¡ç‰‡å¤´éƒ¨ï¼šåŒ…å«æ—¥æœŸå’Œæ—¶é•¿ */
.call-record-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.call-record-card .card-header .duration {
    font-weight: 500;
    color: var(--text-primary);
}

/* å¡ç‰‡ä¸»ä½“ï¼šå‚ä¸è€…å¤´åƒ */
.call-record-card .card-body {
    display: flex;
    align-items: center;
}
.call-record-card .participants-avatars {
    display: flex;
    align-items: center;
}
.call-record-card .participant-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* è®©å¤´åƒæœ‰ä¸€ä¸ªæ¼‚äº®çš„å †å æ•ˆæœ */
.call-record-card .participant-avatar:not(:first-child) {
    margin-left: -12px;
}
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 15px;
}

/* --- é€šè¯è¯¦æƒ…å¼¹çª—æ ·å¼ --- */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
}
.transcript-entry {
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 85%;
    line-height: 1.5;
    word-break: break-word;
}
.transcript-entry.user {
    background-color: #dcf8c6; /* ç±»ä¼¼å¾®ä¿¡çš„ç»¿è‰² */
    align-self: flex-end;
}
.transcript-entry.assistant {
    background-color: #ffffff;
    align-self: flex-start;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

#chat-list-title {
    cursor: pointer;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•å¡ç‰‡ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

.call-record-card .card-body {
    /* å°† body æ”¹ä¸º flex å¸ƒå±€ï¼Œè®©æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯å‚ç›´æ’åˆ— */
    display: flex;
    flex-direction: column;
    gap: 8px; /* æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯ä¹‹é—´çš„é—´è· */
}

.call-record-card .custom-title {
    font-size: 16px;
    font-weight: 600; /* åŠ ç²—ï¼Œè®©å®ƒåƒä¸ªæ ‡é¢˜ */
    color: var(--text-primary);
    padding-bottom: 8px; /* æ ‡é¢˜ä¸‹çš„ç•™ç™½ */
    border-bottom: 1px solid var(--border-color); /* åœ¨æ ‡é¢˜ä¸‹åŠ ä¸€æ¡åˆ†å‰²çº¿ */
    margin-bottom: 4px; /* å’Œä¸‹é¢çš„å‚ä¸è€…ä¿¡æ¯æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}

.call-record-card .participants-info {
    /* è¿™ä¸ªæ–°å®¹å™¨è®©å¤´åƒå’Œâ€œä¸xxâ€èƒ½æ°´å¹³å¯¹é½ */
    display: flex;
    align-items: center;
}

/* å‚ä¸è€…åå­—çš„æ ·å¼å¾®è°ƒï¼Œè®©å®ƒä¸é‚£ä¹ˆçªå‡º */
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 500; /* ä¸å†åŠ ç²— */
    font-size: 14px; /* ç¨å¾®å°ä¸€ç‚¹ */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¯­éŸ³æ–‡å­—å†…å®¹çš„æ ·å¼ */
.voice-transcript {
    font-size: 14px;         /* æ–‡å­—å¤§å° */
    line-height: 1.6;        /* è¡Œé«˜ï¼Œè®©å¤šè¡Œæ–‡æœ¬æ›´æ˜“è¯» */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²ï¼Œä¸è¯­éŸ³æ¡åŒºåˆ† */
    padding: 8px 12px;       /* å†…è¾¹è· */
    margin-top: 6px;         /* å’Œä¸Šæ–¹çš„è¯­éŸ³æ¡æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
    background-color: rgba(0, 0, 0, 0.04); /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
    border-radius: 6px;      /* åœ†è§’ */
    word-break: break-word;  /* ç¡®ä¿é•¿æ–‡æœ¬èƒ½æ­£å¸¸æ¢è¡Œ */
    display: none;           /* é»˜è®¤éšè— */
}

#phone-screen.dark-mode .voice-transcript {
    background-color: rgba(255, 255, 255, 0.1); /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}

/* 2. æ—‹è½¬åŠ è½½åŠ¨ç”»çš„æ ·å¼ */
.loading-spinner {
    display: none; /* é»˜è®¤éšè— */
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color); /* æ—‹è½¬éƒ¨åˆ†çš„é¢œè‰² */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 8px; /* å’Œæ³¢å½¢å›¾ã€æ—¶é•¿ä¿æŒä¸€ç‚¹é—´è· */
}

/* 3. å®šä¹‰æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */
#shared-history-viewer-content {
    display: flex;
    flex-direction: column; /* è®©æ°”æ³¡å‚ç›´æ’åˆ— */
    gap: 20px; /* åœ¨æ¯ä¸ªæ°”æ³¡ä¹‹é—´å¢åŠ 20åƒç´ çš„é—´è· */
    padding: 15px; /* åœ¨å®¹å™¨å››å‘¨ä¹Ÿå¢åŠ ä¸€äº›å†…è¾¹è·ï¼Œé¿å…æ°”æ³¡è´´è¾¹ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾å™¨å’Œæ­Œè¯æ ·å¼ â–¼â–¼â–¼ */
#music-player-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 50;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
    background-color: rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50px);
    transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#music-player-overlay.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.music-player-window { 
    width: 70%; 
    min-height: 420px;
    background-color: rgba(255, 255, 255, 0.6); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-radius: 25px; 
    box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
    border: 1px solid rgba(255, 255, 255, 0.18); 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    color: #1f1f1f; 
    position: relative;
    justify-content: space-between;
    padding-bottom: 15px;
}

.music-player-top-actions {
    position: absolute;
    top: 15px;
    left: 15px;
    right: 15px;
    width: calc(100% - 30px);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-left-cluster {
    display: flex;
    align-items: center;
    gap: 15px;
}
#music-return-btn, #music-exit-btn {
    background: none;
    border: none;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
}
#music-exit-btn {
    font-size: 24px;
    font-weight: 400;
}

.music-progress-bar-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    margin-bottom: 10px;
}
.time-display {
    font-size: 11px;
    color: #888;
    width: 35px;
    text-align: center;
    flex-shrink: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}
.progress-bar {
    flex-grow: 1;
    height: 5px;
    background-color: #e5e5e5;
    border-radius: 2.5px;
    cursor: pointer;
}
.progress-bar-fill {
    width: 0%;
    height: 100%;
    background-color: #333;
    border-radius: 2.5px;
}

#music-lyrics-container {
    width: 100%;
    height: 192px;
    overflow: hidden;
    position: relative;
    -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
    mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
}

#music-lyrics-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    text-align: center;
    line-height: 1.5;
    transition: all 0.5s ease;
    opacity: 0.7;
    transform: scale(0.95);
}

.lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    transform: scale(1);
}

.music-player-controls-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.music-controls {
    margin-top: 0;
}

#music-return-btn, #music-exit-btn, #music-playlist-btn {
    position: relative;
}

#music-return-btn { top: -2px; }
#music-playlist-btn { top: -3px; }

.playlist-item-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.playlist-action-btn {
    font-size: 18px;
    color: #888;
    cursor: pointer;
    transition: color 0.2s;
}
.playlist-action-btn:hover { color: #000; }
.delete-track-btn { font-size: 24px; color: #ff3b30; }
.delete-track-btn:hover { color: #c00; }
.lyrics-btn { font-weight: 500; }

/* --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¡®ä¿å¤´åƒå°ºå¯¸ --- */
.message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 20%;
    object-fit: cover;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ â–¼â–¼â–¼ */

/* 1. æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦æ ·å¼ */
.recalled-message-placeholder {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
    cursor: pointer; /* è®©å®ƒçœ‹èµ·æ¥å¯ä»¥ç‚¹å‡» */
}

/* 2. å¤œé—´æ¨¡å¼ä¸‹çš„é€‚é… */
#phone-screen.dark-mode .recalled-message-placeholder {
    background-color: rgba(255, 255, 255, 0.15);
}

/* 3. AIæ’¤å›æ¶ˆæ¯æ—¶çš„åŠ¨ç”»æ•ˆæœ */
@keyframes recall-animation {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}

.message-wrapper.recalled-animation {
  animation: recall-animation 0.3s ease-out forwards;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */

/* å¼ºåˆ¶æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦ä¸æ¢è¡Œï¼Œå¹¶ä¿æŒå†…å®¹å±…ä¸­ */
.recalled-message-placeholder {
    white-space: nowrap; /* æ ¸å¿ƒï¼šç¦æ­¢æ–‡æœ¬æ¢è¡Œ */
    display: inline-block; /* è®©èƒŒæ™¯æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
    padding: 4px 12px;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.world-book-group-container {
    border-bottom: 1px solid var(--border-color);
}
.world-book-group-container:first-child {
    border-top: 1px solid var(--border-color);
}
.world-book-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}
.world-book-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}
.world-book-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}
.world-book-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}
.world-book-group-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.world-book-group-content.collapsed {
    max-height: 0;
}
#phone-screen.dark-mode .world-book-group-header {
    background-color: #1c1c1e;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…/è½¬è´¦æ¨¡æ€æ¡†é¡µç­¾æ ·å¼ â–¼â–¼â–¼ */
.frame-tabs {
    display: flex;
    background-color: #f0f0f0;
    padding: 4px;
    margin: 15px;
    border-radius: 8px;
}
.frame-tab {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #555;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}
.frame-tab.active {
    background-color: #ffffff;
    color: #000000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µå…¨æ–°çš„CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. åˆ†ç±»æ–‡ä»¶å¤¹çš„æ ·å¼ */
.wb-category-header {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5; /* ç»™æ–‡ä»¶å¤¹ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰²ä»¥åŒºåˆ† */
    font-weight: 600; /* åŠ ç²—å­—ä½“ */
}
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e; /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}


/* 2. å±•å¼€/æ”¶èµ·çš„å°ç®­å¤´ */
.wb-category-header .arrow {
    font-size: 12px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

/* 3. å½“æ–‡ä»¶å¤¹æ”¶èµ·æ—¶ï¼Œç®­å¤´æ—‹è½¬ */
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 4. å­˜æ”¾ä¹¦ç±æ¡ç›®çš„å®¹å™¨ */
.wb-book-container {
    padding-left: 20px; /* æ ¸å¿ƒï¼šè®©ä¹¦ç±æ¡ç›®å‘å†…ç¼©è¿›ï¼Œçœ‹èµ·æ¥åƒåœ¨æ–‡ä»¶å¤¹é‡Œ */
    max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ï¼Œç”¨äºåŠ¨ç”» */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

/* 5. å½“æ–‡ä»¶å¤¹æ”¶èµ·æ—¶ï¼Œä¹¦ç±å®¹å™¨çš„é«˜åº¦å˜ä¸º0ï¼Œå®ç°åŠ¨ç”»æ•ˆæœ */
.wb-book-container.collapsed {
    max-height: 0;
}

/* 6. å•ä¸ªä¹¦ç±æ¡ç›®ï¼ˆè¦†ç›–é»˜è®¤çš„labelæ ·å¼ï¼Œå¾®è°ƒé—´è·ï¼‰ */
.wb-book-container label {
    padding: 8px 12px;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦å…³è”é€‰æ‹©å™¨ - è§†è§‰ä¼˜åŒ– â–¼â–¼â–¼ */

/* 1. è®©åˆ†ç±»æ ‡é¢˜æ›´çªå‡º */
.wb-category-header > span:last-of-type {
    font-size: 14px;
    font-weight: 700; /* åŠ ç²— */
    color: var(--text-primary);
}

/* 2. ä¸ºç®­å¤´è®¾ç½®ä¸€ä¸ªæ¼‚äº®çš„é¢œè‰²å¾ªç¯ */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+1) .arrow { color: #007bff; } /* è“è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+2) .arrow { color: #28a745; } /* ç»¿è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+3) .arrow { color: #fd7e14; } /* æ©™è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+4) .arrow { color: #6f42c1; } /* ç´«è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+5) .arrow { color: #dc3545; } /* çº¢è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+6) .arrow { color: #ffc107; } /* é»„è‰² */

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

    </style>
</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div></div>
                                                <!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ä½ åŸæ¥çš„ id="app-grid" â–¼â–¼â–¼ -->
<div id="app-grid">
    <!-- ç¬¬ä¸€è¡Œï¼šæ”¾2ä¸ªå›¾æ ‡ -->
    <div class="app-row">
        <div class="app-icon" onclick="showScreen('world-book-screen')">
            <div class="icon-bg">
                <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ·»åŠ ID -->
                <img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="ä¸–ç•Œä¹¦">
            </div>
            <span class="label">ä¸–ç•Œä¹¦</span>
        </div>
        <div class="app-icon" onclick="showScreen('chat-list-screen')">
            <div class="icon-bg">
                <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ·»åŠ ID -->
                <img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ">
            </div>
            <span class="label">QQ</span>
        </div>
    </div>
    <!-- ç¬¬äºŒè¡Œï¼šæ”¾3ä¸ªå›¾æ ‡ -->
    <div class="app-row">
        <div class="app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg">
                <!-- ã€æ ¸å¿ƒä¿®æ”¹3ã€‘æ·»åŠ ID -->
                <img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIè®¾ç½®">
            </div>
            <span class="label">APIè®¾ç½®</span>
        </div>
        <div class="app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg">
                <!-- ã€æ ¸å¿ƒä¿®æ”¹4ã€‘æ·»åŠ ID -->
                <img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="å¤–è§‚è®¾ç½®">
            </div>
            <span class="label">å¤–è§‚è®¾ç½®</span>
        </div>
        <div class="app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg">
                <!-- ã€æ ¸å¿ƒä¿®æ”¹5ã€‘æ·»åŠ ID -->
                <img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="å­—ä½“">
            </div>
            <span class="label">å­—ä½“</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            </div>
          
<div id="world-book-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>ä¸–ç•Œä¹¦</span>
        <div class="header-actions"> <!-- ã€æ¨èã€‘ç”¨ä¸€ä¸ªå®¹å™¨æŠŠæŒ‰é’®åŒ…èµ·æ¥ -->
            <span class="action-btn" id="manage-world-book-categories-btn">ç®¡ç†åˆ†ç±»</span>
            <span class="action-btn" id="add-world-book-btn">+</span>
        </div>
    </div>
    <div id="world-book-list"></div>
</div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
                    <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">ä¹¦å</label>
                        <input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
                    </div>

        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œæ·»åŠ åˆ†ç±»é€‰æ‹© â–¼â–¼â–¼ -->
        <div class="form-group">
            <label for="world-book-category-select">åˆ†ç±»</label>
            <select id="world-book-category-select">
                <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
        </div>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">å†…å®¹</label>
                        <textarea id="world-book-content-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">æç¤º: è‹¥è¦ä½¿ç”¨â€œå‘é€å›¾ç‰‡â€åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚</p><div class="form-group"><label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label><input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="form-group"><label for="api-key">å¯†é’¥ (ç›´è¿è½®è¯¢ç”¨è‹±æ–‡é€—å·éš”å¼€)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">æ¨¡å‹</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button>

<!-- â–¼â–¼â–¼ å°†è¿™æ®µä»£ç ç²˜è´´åˆ° API è®¾ç½®é¡µé¢çš„â€œä¿å­˜è®¾ç½®â€æŒ‰é’®ä¸Šæ–¹ â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        å¯ç”¨åå°è§’è‰²æ´»åŠ¨
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            è­¦å‘Šï¼šæ­¤åŠŸèƒ½ä¼šæ˜¾è‘—å¢åŠ APIè°ƒç”¨å’Œè´¹ç”¨ï¼
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ å°†è¿™æ®µä»£ç ç²˜è´´åˆ°â€œå¯ç”¨åå°è§’è‰²æ´»åŠ¨â€å¼€å…³çš„ä¸‹æ–¹ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
        åå°æ´»åŠ¨æ£€æµ‹é—´éš” (ç§’)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            å»ºè®®å€¼ 60-300ã€‚å€¼è¶Šå¤§ï¼Œè´¹ç”¨è¶Šä½ï¼Œä½†è§’è‰²ååº”è¶Šæ…¢ã€‚
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AIè¢«æ‹‰é»‘åå†·é™æœŸ (å°æ—¶)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            è¢«æ‹‰é»‘è¶…è¿‡è¿™ä¸ªæ—¶é—´åï¼ŒAIæ‰æœ‰å‡ ç‡é‡æ–°ç”³è¯·å¥½å‹ã€‚
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<button class="form-button" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn">å¯¼å‡ºæ•°æ®</button>

<!-- â‘  æ™®é€šæŒ‰é’®ï¼Œå’Œâ€œå¯¼å‡ºâ€ä¸€ä¸ª class -->
<button class="form-button" id="import-btn">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>

<!-- â‘¡ çœŸæ­£çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå®Œå…¨éšè— -->
<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ chat-list-screen â–¼â–¼â–¼ -->
<div id="chat-list-screen" class="screen">
    
    <!-- ä¸»å¤´éƒ¨ (åªåœ¨æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º) -->
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
<span id="chat-list-title">æ¶ˆæ¯</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JSä¼šåœ¨è¿™é‡Œç”ŸæˆèŠå¤©åˆ—è¡¨ -->
        </div>
    </div>

    <!-- åŠ¨æ€ç•Œé¢è§†å›¾ -->
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">â€¹</span> <!-- è¿™ä¸ªæŒ‰é’®ç°åœ¨åªè´Ÿè´£ä»åŠ¨æ€è¿”å› -->
            <span>å¥½å‹åŠ¨æ€</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="å¤´åƒ">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>è¯´è¯´</span></div>
                <div class="action-item" id="create-post-btn"><span>åŠ¨æ€</span></div>
                <div class="action-item" id="open-album-btn"><span>ç›¸å†Œ</span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>

    <!-- æ”¶è—ç•Œé¢è§†å›¾ -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">â€¹</span>
        <span>æˆ‘çš„æ”¶è—</span>
        <!-- æ–°å¢çš„ç¼–è¾‘æŒ‰é’® -->
        <span class="action-btn" id="favorites-edit-btn">ç¼–è¾‘</span>
    </div>

        <!-- ã€æ–°å¢ã€‘æœç´¢æ å®¹å™¨ -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- æ”¶è—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- æ–°å¢ï¼šæ”¶è—é¡µåº•éƒ¨æ“ä½œæ  -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆ é™¤ (0)</button>
</div>

    </div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å›å¿†å½•ç•Œé¢è§†å›¾ â–¼â–¼â–¼ -->
<div id="memories-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="memories-back-btn">â€¹</span>
        <span>æˆ‘ä»¬çš„å›å¿†</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
        </div>
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- å›å¿†å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span>æ¶ˆæ¯</span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span>åŠ¨æ€</span>
    </div>
    <!-- â–¼â–¼â–¼ åœ¨â€œåŠ¨æ€â€å’Œâ€œæ”¶è—â€ä¹‹é—´ï¼ŒåŠ å…¥è¿™ä¸ªæ–°é¡µç­¾ â–¼â–¼â–¼ -->
    <div class="nav-item" data-view="memories-view">
        <span>å›å¿†</span>
    </div>
    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <div class="nav-item" data-view="favorites-view">
        <span>æ”¶è—</span>
    </div>
</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="chat-list-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œæ ‡é¢˜ -->
    <div class="header">
        <span class="back-btn" id="album-back-btn">â€¹</span>
        <span>æˆ‘çš„ç›¸å†Œ</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="album-grid-page">
            <!-- ç›¸å†Œåˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="album-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-photos-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">â€¹</span>
        <span id="album-photos-title">ç›¸å†Œåç§°</span>
        <span class="action-btn" id="album-upload-photo-btn">ä¸Šä¼ </span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!-- ç…§ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1. å…³é—­æŒ‰é’® -->
    <button id="photo-viewer-close-btn">Ã—</button>
    
    <!-- 2. ä¸Šä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
    
    <!-- 3. å›¾ç‰‡å®¹å™¨ -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é¢„è§ˆ">
    </div>
    
    <!-- 4. ä¸‹ä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç²˜è´´åˆ° #album-photos-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->
<input type="file" id="album-photo-input" accept="image/*" multiple hidden>
            
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ‚¨æ–‡ä»¶ä¸­æ—§çš„ #chat-interface-screen åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="chat-interface-screen" class="screen">

    <!-- ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘Headerï¼Œå·²å°†çŠ¶æ€æ å’Œæœç´¢åŠŸèƒ½æ­£ç¡®æ•´åˆ -->
    <div class="header">
        <!-- é»˜è®¤æ§ä»¶ï¼šåŒ…å«æ ‡é¢˜ã€çŠ¶æ€æ å’Œå¸¸è§„æŒ‰é’® -->
        <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">â€¹</span>
            
            <!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘æ ‡é¢˜å’ŒçŠ¶æ€çš„å®¹å™¨ â–¼â–¼â–¼ -->
            <div id="chat-header-title-wrapper">
                <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
                <div id="chat-header-status">
                    <span class="status-dot"></span>
                    <span class="status-text">åœ¨çº¿</span>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

            <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·å¬"></span>
                <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="è®¾ç½®"></span>
            </div>
        </div>

        <!-- å¤šé€‰æ¨¡å¼æ§ä»¶ (ä¿æŒä¸å˜) -->
        <div class="selection-controls">
            <span id="selection-cancel-btn">å–æ¶ˆ</span>
            <span id="selection-count"></span>
            <div class="header-actions">
               <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
       <span id="selection-share-btn" class="action-btn">åˆ†äº«</span> 
               <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">åˆ é™¤</span>
            </div>
        </div>
    </div>
    
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div id="chat-messages"><div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div></div>

    <!-- è¾“å…¥åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div id="chat-input-area">
<div id="reply-preview-bar">
    <div class="reply-preview-content">
        <div class="sender">å›å¤ xxx:</div>
        <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹...</div>
    </div>
    <span id="cancel-reply-btn">Ã—</span>
</div>
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿">+</button>
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="å‘é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šä¼ å›¾ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦">ï¿¥</button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
<!-- â–¼â–¼â–¼ å°†è¿™è¡Œæ–°ä»£ç ç²˜è´´åˆ°â€œå‘é€è¯­éŸ³â€æŒ‰é’®çš„åé¢ â–¼â–¼â–¼ -->
<button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="å‘èµ·å¤–å–è¯·æ±‚"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€æ–°å¢ã€‘è§†é¢‘é€šè¯æŒ‰é’® â–¼â–¼â–¼ -->
<button id="video-call-btn" class="chat-action-icon-btn action-button" title="è§†é¢‘é€šè¯"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
<!-- â–¼â–¼â–¼ç¾¤è§†é¢‘é€šè¯æŒ‰é’® â–¼â–¼â–¼ -->
<button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="ç¾¤è§†é¢‘é€šè¯"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
<!-- â–²â–²â–² å…¨æ–°æ·»åŠ ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼å‘èµ·æŠ•ç¥¨æŒ‰é’®â–¼â–¼â–¼ -->
<button id="send-poll-btn" class="chat-action-icon-btn action-button" title="å‘èµ·æŠ•ç¥¨"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ id="chat-input-actions-top" çš„æœ«å°¾ï¼Œã€æ·»åŠ ã€‘è¿™ä¸ªæ–°çš„æŒ‰é’® â–¼â–¼â–¼ -->
<button id="share-link-btn" class="chat-action-icon-btn action-button" title="åˆ†äº«é“¾æ¥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="ç­‰å¾…å›å¤"></button>
                <button id="send-btn" class="action-button">å‘é€</button>
            </div>
        </div>
    </div>

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼ -->
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

    <!-- è¡¨æƒ…é¢æ¿ (ä¿æŒä¸å˜) -->
    <div id="sticker-panel">
        <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
            <span class="title">æˆ‘çš„è¡¨æƒ…</span>
            <div style="display: flex; gap: 10px;">
              <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
              <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
            </div>
        </div>
        <div id="sticker-grid"></div>
    </div>
    <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <!-- éŸ³ä¹æ’­æ”¾å™¨ (ä¿æŒä¸å˜) -->
<div id="music-player-overlay">
    <div class="music-player-window">
        
        <!-- 1. é¡¶éƒ¨æ“ä½œæ  -->
        <div class="music-player-top-actions">
            <div class="top-left-cluster">
                <button id="music-return-btn">â€¹</button>
                <button id="music-exit-btn">Ã—</button>
            </div>
            <span id="music-playlist-btn">â˜°</span>
        </div>
        
        <!-- 2. æ­Œæ›²ä¿¡æ¯ -->
        <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>
        <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
        <div id="music-player-artist">...</div>
        
        <!-- 3. ã€å…¨æ–°ã€‘æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="music-lyrics-container">
            <div id="music-lyrics-list">
                <!-- æ­Œè¯å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                <div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>
            </div>
        </div>
        
        <!-- 4. ã€å…¨æ–°ã€‘æ’­æ”¾æ§åˆ¶åŒºçš„åŒ…è£¹å®¹å™¨ -->
        <div class="music-player-controls-wrapper">
            <!-- a. æ–°çš„iOSé£æ ¼è¿›åº¦æ¡ -->
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            
            <!-- b. æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
            <div class="music-controls">
                <button id="music-prev-btn">â—€</button>
                <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
                <button id="music-next-btn">â–¶</button>
                <button id="music-mode-btn">é¡ºåº</button>
            </div>
        </div>

    </div>
</div>
    
    <div id="music-playlist-panel">
        <div class="playlist-header">
            <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
            <span>æ’­æ”¾åˆ—è¡¨</span>
            <div>
                <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
            </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ä½ åŸæ¥çš„ id="wallpaper-screen" â–¼â–¼â–¼ -->
<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ‡é¢˜æ”¹ä¸ºâ€œå¤–è§‚è®¾ç½®â€ï¼Œæ›´é€šç”¨ -->
        <span>å¤–è§‚è®¾ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <!-- å£çº¸è®¾ç½®éƒ¨åˆ†ä¿æŒä¸å˜ -->
        <div id="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
        <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šä¼ å£çº¸</button>
        <input type="file" id="wallpaper-upload-input" accept="image/*">

<!-- â–¼â–¼â–¼ å°†ã€ä¸Šé¢æ•´å—ä»£ç ã€‘ï¼Œå®Œæ•´æ›¿æ¢ä¸ºä¸‹é¢è¿™æ®µã€å…¨æ–°çš„ä»£ç ã€‘ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="theme-toggle-switch" style="margin-bottom: 0;">å¤œé—´æ¨¡å¼</label>
    <label class="toggle-switch">
        <input type="checkbox" id="theme-toggle-switch">
        <span class="slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        
        <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–°å¢å›¾æ ‡è®¾ç½®åŒºåŸŸ -->
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">App å›¾æ ‡è®¾ç½®</label>
        </div>
        <div id="icon-settings-grid">
            <!-- å›¾æ ‡è®¾ç½®é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        
        <!-- ã€æ ¸å¿ƒä¿®æ”¹3ã€‘æŒ‰é’®æ–‡å­—ä¹Ÿæ”¹ä¸€ä¸‹ -->
        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">ä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½ HTML â–¼â–¼â–¼ -->
<div id="browser-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="browser-back-btn">â€¹</span>
        <span id="browser-title"></span>
        <span style="width: 30px;"></span>
    </div>
    <div id="browser-content" class="list-container">
        <!-- æ–‡ç« å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<div id="font-settings-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å­—ä½“è®¾ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="font-url-input">å­—ä½“æ–‡ä»¶URL (.ttf, .otf, .woffç­‰)</label>
            <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
        </div>

        <div class="form-group">
            <label>å®æ—¶é¢„è§ˆ</label>
<div id="font-preview">
                <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
                <p style="margin: 0;">è¿™æ˜¯å­—ä½“é¢„è§ˆæ•ˆæœï¼Œ12345ã€‚</p>
            </div>
        </div>

        <button class="form-button" id="save-font-btn">ä¿å­˜å¹¶åº”ç”¨</button>
        <button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¤é»˜è®¤å­—ä½“</button>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€‰æ‹©è”ç³»äººä»¥åˆ›å»ºç¾¤èŠçš„å±å¹• â–¼â–¼â–¼ -->
<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
        <span>é€‰æ‹©è”ç³»äºº</span>
        <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
        <!-- è”ç³»äººåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†å±å¹• â–¼â–¼â–¼ -->
<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management">â€¹</span>
        <span>ç¾¤æˆå‘˜ç®¡ç†</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
        <!-- ç°æœ‰æˆå‘˜åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn">ä»å¥½å‹åˆ—è¡¨æ·»åŠ </button>
        <button id="create-new-member-btn">åˆ›å»ºç¾¤å†…æ–°æˆå‘˜</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">é‚€è¯·ä½ è§†é¢‘é€šè¯</div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span>æ‹’ç»</span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span>æ¥å¬</span>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å…¨æ–°ç¾¤èŠå…¼å®¹ç»“æ„ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ #video-call-screen â–¼â–¼â–¼ -->
<div id="video-call-screen" class="screen">
    <!-- 1. é¡¶éƒ¨æ  (ä¿æŒä¸å˜) -->
    <div class="video-call-top-bar">
        <span id="call-timer">00:00</span>
    </div>
    
    <!-- 2. ã€å‡çº§ã€‘å‚ä¸è€…å¤´åƒç½‘æ ¼åŒºåŸŸ -->
    <div class="video-call-avatar-area">
        <div id="participant-avatars-grid">
            <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆå¤´åƒ -->
        </div>
    </div>

    <!-- 3. å¯¹è¯æ¡†åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div id="video-call-main" class="video-call-main">
        <!-- å¯¹è¯å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
    
    <!-- 4. ã€å‡çº§ã€‘åº•éƒ¨æ§åˆ¶æ ï¼Œç°åœ¨åŒ…å«ä¸€ä¸ªâ€œåŠ å…¥â€æŒ‰é’® -->
    <div class="video-call-controls">
        <button id="user-speak-btn" class="control-btn speak-btn"></button>
        <button id="hang-up-btn" class="control-btn hangup-btn"></button>
        <!-- è¿™ä¸ªæŒ‰é’®é»˜è®¤éšè—ï¼Œåªåœ¨ç”¨æˆ·â€œæ—è§‚â€æ—¶æ˜¾ç¤º -->
        <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢ â–¼â–¼â–¼ -->
<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ â–¼â–¼â–¼ -->
<div id="call-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="call-history-back-btn">â€¹</span>
        <span id="call-history-title">é€šè¯è®°å½•</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
    </div>
    <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- é€šè¯è®°å½•å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

        </div>
    </div>
  
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>èŠå¤©è®¾ç½®</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">å¤‡æ³¨å / ç¾¤å</label><input type="text" id="chat-name-input"></div>

    <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œå¤‡æ³¨åâ€è¾“å…¥æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
    <div class="form-group" id="assign-group-section" style="display: none;"> <!-- é»˜è®¤éšè—ï¼Œåªå¯¹å•èŠæ˜¾ç¤º -->
        <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
                <!-- åˆ†ç»„é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†åˆ†ç»„</button>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤å¤´åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>å…³è”ä¸–ç•Œä¹¦ (å¯å¤šé€‰)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button><button id="manage-ai-avatar-library-btn">ç®¡ç†å¤´åƒåº“</button>
<input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„å¤´åƒ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button><button id="open-persona-library-btn">é¢„è®¾</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>ç¾¤æˆå‘˜äººè®¾</label><div id="group-members-settings"></div>

    <!-- ã€æ–°å¢ã€‘ç®¡ç†æˆå‘˜æŒ‰é’® -->
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå‘˜</button></div>
<div class="form-group"><label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>èŠå¤©æ°”æ³¡ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜è®¤</label><label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è“</label><label><input type="radio" name="theme-select" value="blue_white"> è“ç™½</label><label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»„</label><label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label><label><input type="radio" name="theme-select" value="yellow_white"> é»„ç™½</label><label><input type="radio" name="theme-select" value="red_black"> çº¢é»‘</label><label><input type="radio" name="theme-select" value="blue_yellow"> è“é»„</label><label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»„</label><label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label><label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label><label><input type="radio" name="theme-select" value="blue_green"> è“ç»¿</label><label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label><label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label><label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç»¿</label><label><input type="radio" name="theme-select" value="green_black"> ç»¿é»‘</label></div></div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©æ°”æ³¡ä¸»é¢˜â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="font-size-slider">èŠå¤©å­—ä½“å¤§å° <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©å­—ä½“å¤§å°â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="custom-css-input">
        è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹ï¼šä¸ºâ€œæˆ‘â€çš„æ°”æ³¡æ·»åŠ æ¸å˜èƒŒæ™¯å’Œé˜´å½± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°è‡ªå®šä¹‰CSSè¾“å…¥æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å®æ—¶é¢„è§ˆ</label>
    <div id="settings-preview-area">
        <!-- JSä¼šåœ¨è¿™é‡Œç”Ÿæˆé¢„è§ˆå†…å®¹ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                    <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">æ‹‰é»‘å¯¹æ–¹</button>
<button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span></div><div class="modal-body"><div class="form-group"><label>é¢„è®¾å¤´åƒ</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">é¢„è®¾äººè®¾</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>å¤´åƒ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
                <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

    <audio id="audio-player" style="display:none;"></audio>

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€å®Œæ•´ã€‘çš„æ¨¡æ€æ¡†ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ id="create-post-modal" çš„æ•´ä¸ª div â–¼â–¼â–¼ -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span>å‘å¸ƒåŠ¨æ€</span>
        </div>
        <div class="modal-body">
            <!-- å…¬å¼€æ–‡å­—è¾“å…¥åŒº -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰"></textarea>
            </div>

            <!-- === æ¨¡å¼åˆ‡æ¢å¼€å…³ (æ–°å¢) === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—å›¾</button>
            </div>

<!-- â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„å¯è§èŒƒå›´è®¾ç½® â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å¯è§èŒƒå›´</label>
    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="public" checked> å…¬å¼€</label>

        <label><input type="radio" name="visibility" value="include"> æŒ‡å®šåˆ†ç»„å¯è§</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <!-- åˆ†ç»„å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² -->

            <!-- === å›¾ç‰‡æ¨¡å¼åŒºåŸŸ === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
<div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                        <button id="post-remove-image-btn">Ã—</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šä¼ </button>
                        <button id="post-use-url-btn" class="form-button-secondary">ç½‘ç»œURL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>å›¾ç‰‡æè¿° (å¿…å¡«ï¼Œç»™AIçœ‹)</label>
                    <input type="text" id="post-image-description" placeholder="ç®€å•æè¿°å›¾ç‰‡å†…å®¹ï¼Œå¸®åŠ©AIç†è§£">
                </div>
            </div>

            <!-- === æ–‡å­—å›¾æ¨¡å¼åŒºåŸŸ (æ–°å¢) === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>æ–‡å­—å›¾ (ç»™AIç†è§£ç”¨çš„æè¿°ï¼Œç‚¹å‡»å›¾ç‰‡åå¯è§)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å›¾ç‰‡æè¿°..."></textarea>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-post-btn">å‘å¸ƒ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°çš„æ¨¡æ€æ¡†HTMLç²˜è´´åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†ä¹‹å â–¼â–¼â–¼ -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†å¥½å‹åˆ†ç»„</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç»„</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="è¾“å…¥åˆ†ç»„å..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!-- æ–°çš„æ“ä½œæŒ‰é’® -->
            <button id="edit-message-btn">ç¼–è¾‘æ¶ˆæ¯</button>
            <button id="copy-message-btn">å¤åˆ¶æ–‡æœ¬</button>
            <button id="recall-message-btn">æ’¤å›</button>
<button id="quote-message-btn">å¼•ç”¨</button>
            <button id="select-message-btn">è¿›å…¥å¤šé€‰</button>
            <!-- å–æ¶ˆæŒ‰é’® -->
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">ç¼–è¾‘åŠ¨æ€</button>
            <button id="copy-post-btn">å¤åˆ¶å†…å®¹</button>           
            <button id="cancel-post-action-btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span>ç¼–è¾‘ä¸æ‹†åˆ†æ¶ˆæ¯</span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- ç¼–è¾‘å™¨å®¹å™¨ï¼ŒJSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ–‡æœ¬æ¡† -->
            <div id="message-editor-container"></div>
            <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰é’® -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>å‘èµ·å¤–å–ä»£ä»˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">å•†å“ä¿¡æ¯</label>
                <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¨æç”˜éœ²">
            </div>
            <div class="form-group">
                <label for="waimai-amount">ä»£ä»˜é‡‘é¢ (å…ƒ)</label>
                <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚ï¼š21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="waimai-confirm-btn">å‘èµ·è¯·æ±‚</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°å»ºçº¦å®š/å€’è®¡æ—¶æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ–°å»ºçº¦å®š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input">çº¦å®šæ ‡é¢˜</label>
                <input type="text" id="countdown-title-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥">
            </div>
            <div class="form-group">
                <label for="countdown-date-input">çº¦å®šæ—¥æœŸä¸æ—¶é—´</label>
                <input type="datetime-local" id="countdown-date-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-countdown-btn">ä¿å­˜çº¦å®š</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‘çº¢åŒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>å‘çº¢åŒ…</span>
        </div>
        <div class="modal-body" style="padding: 0;">
<!-- 1. é¡µç­¾åˆ‡æ¢ -->
<div class="frame-tabs">
    <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°”çº¢åŒ…</div>
    <div id="rp-tab-direct" class="frame-tab">ä¸“å±çº¢åŒ…</div>
</div>

            <!-- 2. æ‹¼æ‰‹æ°”çº¢åŒ…å†…å®¹åŒº -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label>æ€»é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>çº¢åŒ…ä¸ªæ•°</label>
                    <input type="number" id="rp-group-count" placeholder="å¡«å†™çº¢åŒ…ä¸ªæ•°">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦è¯­</label>
                    <input type="text" id="rp-group-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-group-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
            </div>

            <!-- 3. ä¸“å±çº¢åŒ…å†…å®¹åŒº -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label>å‘é€ç»™</label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦è¯­</label>
                    <input type="text" id="rp-direct-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-direct-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;">çš„çº¢åŒ…</div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;">å…ƒ</span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- é¢†å–è¯¦æƒ…å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>å‘èµ·æŠ•ç¥¨</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input">æŠ•ç¥¨é—®é¢˜</label>
                <textarea id="poll-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šæˆ‘ä»¬çœ‹ä»€ä¹ˆç”µå½±ï¼Ÿ"></textarea>
            </div>
            <div class="form-group">
                <label>æŠ•ç¥¨é€‰é¡¹ (è‡³å°‘2é¡¹)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é€‰é¡¹</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-poll-btn">å‘èµ·æŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title">å¯¹æ–¹çš„å¤´åƒåº“</span>
            <button id="add-ai-avatar-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- å¤´åƒåº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>åˆ†äº«é“¾æ¥</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="link-title-input">æ ‡é¢˜</label>
                <input type="text" id="link-title-input" placeholder="è¾“å…¥æ–‡ç« æˆ–é“¾æ¥çš„æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label for="link-description-input">æ‘˜è¦ (å¯é€‰)</label>
                <textarea id="link-description-input" rows="2" placeholder="ç®€å•æè¿°ä¸€ä¸‹é“¾æ¥å†…å®¹"></textarea>
            </div>
            <div class="form-group">
                <label for="link-source-input">æ¥æºåç§° (å¯é€‰)</label>
                <input type="text" id="link-source-input" placeholder="ä¾‹å¦‚ï¼šçŸ¥ä¹æ—¥æŠ¥ã€Bç«™">
            </div>
            <div class="form-group">
                <label for="link-content-input">å®Œæ•´å†…å®¹ (å¯é€‰ï¼Œç”¨äºæµè§ˆå™¨å†…æ˜¾ç¤º)</label>
                <textarea id="link-content-input" rows="4" placeholder="ç²˜è´´æˆ–è¾“å…¥å®Œæ•´çš„æ–‡ç« å†…å®¹"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª— â–¼â–¼â–¼ -->
<div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
        <div class="transfer-actions-header">è¯·é€‰æ‹©æ“ä½œ</div>
        <div class="transfer-actions-body">
            <p>ä½ æ”¶åˆ°äº†æ¥è‡ª <strong id="transfer-sender-name"></strong> çš„ä¸€ç¬”è½¬è´¦ã€‚</p>
        </div>
        <div class="transfer-actions-footer">
            <button id="transfer-action-decline" class="action-btn decline">æ®‹å¿æ‹’ç»</button>
            <button id="transfer-action-accept" class="action-btn accept">å¼€å¿ƒæ”¶ä¸‹</button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="transcript-modal-title">é€šè¯è¯¦æƒ…</span>
        </div>
        <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
            <!-- é€šè¯æ–‡å­—è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">åˆ é™¤è®°å½•</button>
            <button class="save" id="close-transcript-modal-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>åˆ†äº«åˆ°...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0;">
            <!-- èŠå¤©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-target-btn">ç¡®è®¤åˆ†äº«</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="shared-history-viewer-title">èŠå¤©è®°å½•</span>
        </div>
        <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
            <!-- åˆ†äº«çš„èŠå¤©è®°å½•æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†ä¸–ç•Œä¹¦åˆ†ç±»</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç±»</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-category-name-input" placeholder="è¾“å…¥åˆ†ç±»å..." style="flex-grow: 1;">
                    <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<script>

        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
    // geminiå¦‚æœæ˜¯å¤šä¸ªå¯†é’¥, é‚£ä¹ˆéšæœºè·å–ä¸€ä¸ª
    function getRandomValue(str) {
        // æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«é€—å·
        if (str.includes(',')) {
            // ç”¨é€—å·åˆ†éš”å­—ç¬¦ä¸²å¹¶ç§»é™¤å¤šä½™ç©ºæ ¼
            const arr = str.split(',').map(item => item.trim());
            // ç”Ÿæˆéšæœºç´¢å¼• (0 åˆ° arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // è¿”å›éšæœºå…ƒç´ 
            return arr[randomIndex];
        }
        // æ²¡æœ‰é€—å·åˆ™ç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
        return str;
    }
    function isImage(text,content) {
        let currentImageData = content.image_url.url
        // æå–Base64æ•°æ®ï¼ˆå»æ‰å‰ç¼€ï¼‰
        const base64Data = currentImageData.split(',')[1];
        // æ ¹æ®å›¾ç‰‡ç±»å‹è·å–MIMEç±»å‹
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
            {text: `${text.text}ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡`},
            {
                inline_data: {
                    mime_type: mimeType,
                    data: base64Data
                }
            }
        ]
    }

   function extractArray(text) {
        // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼šåŒ¹é…å¼€å¤´çš„æ—¶é—´æˆ³éƒ¨åˆ†å’Œåç»­çš„JSONæ•°ç»„
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
            const timestampPart = `(Timestamp: ${match[1]}) `;
            const jsonPart = match[2].trim();

            try {
                // å°è¯•è§£æJSONéƒ¨åˆ†
                const parsedJson = JSON.parse(jsonPart);
                // éªŒè¯è§£æç»“æœæ˜¯å¦ä¸ºæ•°ç»„
                if (Array.isArray(parsedJson)) {
                    return [timestampPart, parsedJson[0]];
                }
            } catch (error) {
                // è§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
            }
        }

        // ä¸åŒ¹é…æ ¼å¼æˆ–è§£æå¤±è´¥æ—¶è¿”å›åŸå€¼
        return text;
    }
    function transformChatData(item) {
        let type = {
            send_and_recall:'æ’¤å›äº†æ¶ˆæ¯',
            update_status:'æ›´æ–°äº†çŠ¶æ€',
            change_music:'åˆ‡æ¢äº†æ­Œæ›²',
            create_memory:'è®°å½•äº†å›å¿†',
            create_countdown:'åˆ›å»ºäº†çº¦å®š/å€’è®¡æ—¶',
            text:'å‘é€äº†æ–‡æœ¬',
            sticker:'å‘é€äº†è¡¨æƒ…',
            ai_image:'å‘é€äº†å›¾ç‰‡',
            voice_message:'å‘é€äº†è¯­éŸ³',
            transfer:'å‘èµ·äº†è½¬è´¦',
            waimai_request:'å‘èµ·äº†å¤–å–è¯·æ±‚',
            waimai_response:{
                paid:'å›åº”äº†å¤–å–-åŒæ„',
                rejected:'å›åº”äº†å¤–å–-æ‹’ç»'
            },
            video_call_request:'å‘èµ·äº†è§†é¢‘é€šè¯',
            video_call_response:{
                accept:'å›åº”äº†è§†é¢‘é€šè¯-æ¥å—',
                reject:'å›åº”äº†è§†é¢‘é€šè¯-æ‹’ç»'
            },
            qzone_post:{
                shuoshuo:'å‘å¸ƒäº†è¯´è¯´',
                text_image:'å‘å¸ƒäº†æ–‡å­—å›¾'
            },
            qzone_comment:'è¯„è®ºäº†åŠ¨æ€',
            qzone_like:'ç‚¹èµäº†åŠ¨æ€',
            pat_user:'æ‹ä¸€æ‹äº†ç”¨æˆ·',
            block_user:'æ‹‰é»‘äº†ç”¨æˆ·',
            friend_request_response:'å›åº”äº†å¥½å‹ç”³è¯·',
            change_avatar:'æ›´æ¢äº†å¤´åƒ',
            share_link:'åˆ†äº«äº†é“¾æ¥',
            accept_transfer:'å›åº”äº†è½¬è´¦-æ¥å—',
            decline_transfer:'å›åº”äº†è½¬è´¦-æ‹’ç»/é€€æ¬¾',
            quote_reply:'å¼•ç”¨äº†å›å¤',
            text:'',
        }
        let res = extractArray(item.content)

        if(Array.isArray(res)){
            let obj = res[1]
            let itemType = obj.type;
            let time = res[0]
            let text = type[itemType];
            if(text){
                if(itemType === 'sticker'){
                    return [{text:`${time}[${text}] å«ä¹‰æ˜¯:${obj.meaning}`}]
                }else if(itemType === 'send_and_recall'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'update_status'){
                    return [{text:`${time}[${text}] ${obj.status_text}(${obj.is_busy ? 'å¿™ç¢Œ/ç¦»å¼€' : 'ç©ºé—²'})`}]
                }else if(itemType === 'change_music'){
                    return [{text:`${time}[${text}] ${obj.change_music}, æ­Œåæ˜¯:${obj.song_name}`}]
                }else if(itemType === 'create_memory'){
                    return [{text:`${time}[${text}] ${obj.description}`}]
                }else if(itemType === 'create_countdown'){
                    return [{text:`${time}[${text}] ${obj.title}(${obj.date})`}]
                }else if(itemType === 'ai_image'){
                    return [{text:`${time}[${text}] å›¾ç‰‡æè¿°æ˜¯:${obj.description}`}]
                }else if(itemType === 'voice_message'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'transfer'){
                    return [{text:`${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å¤‡æ³¨æ˜¯:${obj.amount}`}]
                }else if(itemType === 'waimai_request'){
                    return [{text:`${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å•†å“æ˜¯:${obj.productInfo}`}]
                }else if(itemType === 'waimai_response'){
                    return [{text:`${time}[${text[obj.status]}] ${obj.status === 'paid' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text}]`}]
                }}else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text[obj.decision]}] ${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'qzone_post'){
                    return [{text:`${time}[${text[obj.postType]}] ${obj.postType === 'shuoshuo' ? `${obj.content}` : `å›¾ç‰‡æè¿°æ˜¯:${obj.hiddenContent} ${obj.publicText ? `æ–‡æ¡ˆæ˜¯: ${obj.publicText}` : ''}`}`}]
                }else if(itemType === 'qzone_comment'){
                    return [{text:`${time}[${text}] è¯„è®ºçš„idæ˜¯: ${obj.postId} è¯„è®ºçš„å†…å®¹æ˜¯: ${obj.commentText}`}]
                }else if(itemType === 'qzone_like'){
                    return [{text:`${time}[${text}] ç‚¹èµçš„idæ˜¯: ${obj.postId}`}]
                }else if(itemType === 'pat_user'){
                    return [{text:`${time}[${text}] ${obj.suffix ? obj.suffix  : ''}`}]
                }else if(itemType === 'block_user'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'friend_request_response'){
                    return [{text:`${time}[${text}] ç»“æœæ˜¯:${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'change_avatar'){
                    return [{text:`${time}[${text}] å¤´åƒåæ˜¯:${obj.name}`}]
                }else if(itemType === 'share_link'){
                    return [{text:`${time}[${text}] æ–‡ç« æ ‡é¢˜æ˜¯:${obj.title}  æ–‡ç« æ‘˜è¦æ˜¯:${obj.description} æ¥æºç½‘ç«™åæ˜¯:${obj.source_name} æ–‡ç« æ­£æ–‡æ˜¯:${obj.content}`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'quote_reply'){
                    return [{text:`${time}[${text}] å¼•ç”¨çš„å†…å®¹æ˜¯:${obj.reply_content}`}]
                }else if(itemType === 'text'){
                    return [{text:`${time}${obj.content}`}]
                }
            }

if(Array.isArray(res) && res.length > 1) {
	res = `${res[0]}${res[1].content}`
}

        return [{text:res}]
    }

    function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision,isGemini) {

	if(!isGemini){
		return undefined
	}

        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°† 'system' è§’è‰²ä¹Ÿæ˜ å°„ä¸º 'user'

        let roleType = {
            user: 'user',
            assistant: 'model',
            system: 'user' // <--- æ–°å¢è¿™ä¸€è¡Œ
        }
        return {
            url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
            data: {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: messagesForDecision.map((item) => {
                        let  includesImages = false;
                        if(Array.isArray(item.content) && item.content.length === 2){
                              includesImages =  item.content.some((sub)=>{
                                return sub.type === 'image_url' && sub.image_url.url
                            })
                        }
                        return {
                            role: roleType[item.role], // ç°åœ¨ 'system' ä¼šè¢«æ­£ç¡®è½¬æ¢ä¸º 'user'
                            parts: includesImages ? isImage(item.content[0],item.content[1]) : transformChatData(item)
                        }
                    }),
                    generationConfig: {
                        temperature: 0.8,
                    },
                    "systemInstruction": {
                        "parts": [{
                            "text": systemInstruction
                        }]
                    }
                })
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. æ‰€æœ‰å˜é‡å’Œå¸¸é‡å®šä¹‰
        // ===================================================================
        const db = new Dexie('GeminiChatDB');
        // --- å·²ä¿®æ­£ ---
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        // --- ä¿®æ­£ç»“æŸ ---
let musicState = { 
    isActive: false, 
    activeChatId: null, 
    isPlaying: false, 
    playlist: [], 
    currentIndex: -1, 
    playMode: 'order', 
    totalElapsedTime: 0, 
    timerId: null,
    // ã€æ–°å¢ã€‘æ­Œè¯ç›¸å…³çŠ¶æ€
    parsedLyrics: [],      // å½“å‰æ­Œæ›²è§£æåçš„æ­Œè¯æ•°ç»„
    currentLyricIndex: -1  // å½“å‰é«˜äº®çš„æ­Œè¯è¡Œç´¢å¼•
};
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;

let waimaiTimers = {}; // ç”¨äºå­˜å‚¨å¤–å–å€’è®¡æ—¶

let activeMessageTimestamp = null;
let currentReplyContext = null; // <--- æ–°å¢è¿™è¡Œï¼Œç”¨æ¥å­˜å‚¨å½“å‰æ­£åœ¨å¼•ç”¨çš„æ¶ˆæ¯ä¿¡æ¯
let activePostId = null; // <-- æ–°å¢ï¼šç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„åŠ¨æ€ID

        let photoViewerState = {
            isOpen: false,
            photos: [], // å­˜å‚¨å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡URL
            currentIndex: -1, // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;

// â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨ï¼Œå˜é‡å®šä¹‰åŒºï¼Œæ·»åŠ è¿™ä¸ªæ–°å¸¸é‡ â–¼â–¼â–¼
const DEFAULT_APP_ICONS = {
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
    'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg'
};
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¡®å®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¡®å®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘æ›¿æ¢æ—§çš„ showCustomPrompt å‡½æ•° â–¼â–¼â–¼
function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é¢å¤–çš„HTMLå’Œè¾“å…¥æ¡†ç»„åˆåœ¨ä¸€èµ·
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®ç»‘å®šäº‹ä»¶
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        // ä½¿ç”¨ null, 2 å‚æ•°è®©JSONå­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Œå¸¦ç¼©è¿›ï¼Œæ›´æ˜“è¯»
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 2. æ•°æ®åº“ç»“æ„å®šä¹‰
        // ===================================================================

db.version(23).stores({ 
    chats: '&id, isGroup, groupId', 
    apiConfig: '&id', 
    globalSettings: '&id', 
    userStickers: '&id, url, name',
    worldBooks: '&id, name, categoryId', // <-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  categoryId
    worldBookCategories: '++id, name',    // <-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–°å¢è¿™ä¸ªè¡¨
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate' ,
    callRecords: '++id, chatId, timestamp, customName' // <--ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡ŒåŠ ä¸Š customName
});

        // ===================================================================
        // 3. æ‰€æœ‰åŠŸèƒ½å‡½æ•°å®šä¹‰
        // ===================================================================

        function showScreen(screenId) {
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
            }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
        'memories-view': document.getElementById('memories-view') // <-- æ–°å¢è¿™ä¸€è¡Œ
    };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            // éšè—æ‰€æœ‰è§†å›¾
            Object.values(views).forEach(v => v.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            // æ›´æ–°åº•éƒ¨å¯¼èˆªæ é«˜äº®
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„æ˜¾éš â–¼â–¼â–¼
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }
            // â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–²

    if (viewId !== 'memories-view') {
        activeCountdownTimers.forEach(timerId => clearInterval(timerId));
        activeCountdownTimers = [];
    }

            // æ ¹æ®è§†å›¾IDæ‰§è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é€»è¾‘
            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿”å›æ¶ˆæ¯åˆ—è¡¨æ—¶è¦æ‰§è¡Œçš„é€»è¾‘
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return 'åˆšåˆš';
            if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²æ·»åŠ åˆ é™¤æŒ‰é’®ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderQzonePosts å‡½æ•° â–¼â–¼â–¼
async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [posts, favorites] = await Promise.all([
        db.qzonePosts.orderBy('timestamp').reverse().toArray(),
        db.favorites.where('type').equals('qzone_post').toArray()
    ]);

    const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
    
    postsListEl.innerHTML = '';

    if (posts.length === 0) {
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§ï¼</p>';
        return;
    }

    const userSettings = state.qzoneSettings;

    posts.forEach(post => {
        const postContainer = document.createElement('div');
        postContainer.className = 'qzone-post-container';
        postContainer.dataset.postId = post.id;

        const postEl = document.createElement('div');
        postEl.className = 'qzone-post-item';

        let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

        if (post.authorId === 'user') {
            authorAvatar = userSettings.avatar;
            authorNickname = userSettings.nickname;
        } else if (state.chats[post.authorId]) {
            const authorChat = state.chats[post.authorId];
            authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
            authorNickname = authorChat.name;
        } else {
            authorAvatar = defaultAvatar;
            authorNickname = '{{char}}';
        }
        
        let contentHtml = '';
        const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

        if (post.type === 'shuoshuo') {
            contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
        } 
        else if (post.type === 'image_post' && post.imageUrl) {
            contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
        } 
        else if (post.type === 'text_image') {
            contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
        }

        let likesHtml = '';
        if (post.likes && post.likes.length > 0) {
            likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span></div>`;
        }
        
        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œã€‘â˜…â˜…â˜…â˜…â˜…
            // éå†è¯„è®ºæ—¶ï¼Œæˆ‘ä»¬ä¼ å…¥ comment å¯¹è±¡æœ¬èº«å’Œå®ƒçš„ç´¢å¼• index
            post.comments.forEach((comment, index) => {
                // åœ¨è¯„è®ºé¡¹çš„æœ«å°¾ï¼Œæ·»åŠ ä¸€ä¸ªå¸¦æœ‰ data-comment-index å±æ€§çš„åˆ é™¤æŒ‰é’®
                commentsHtml += `
                    <div class="comment-item">
                        <span class="commenter-name">${comment.commenterName}:</span>
                        <span class="comment-text">${comment.text}</span>
                        <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                    </div>`;
            });
            // â˜…â˜…â˜…â˜…â˜…ã€ä¿®æ”¹ç»“æŸã€‘â˜…â˜…â˜…â˜…â˜…
            commentsHtml += '</div>';
        }

        const userNickname = state.qzoneSettings.nickname;
        const isLikedByUser = post.likes && post.likes.includes(userNickname);
        const isFavoritedByUser = favoritedPostIds.has(post.id);

        postEl.innerHTML = `
            <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>
                <div class="post-actions-btn">â€¦</div>
            </div>
            <div class="post-main-content">${contentHtml}</div>
            <div class="post-feedback-icons">
                <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
            </div>
            ${likesHtml}
            ${commentsHtml}
            <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹"><div class="at-mention-popup"></div></div><button class="comment-send-btn">å‘é€</button></div>
        `;
        
        const deleteAction = document.createElement('div');
        deleteAction.className = 'qzone-post-delete-action';
        deleteAction.innerHTML = '<span>åˆ é™¤</span>';
        postContainer.appendChild(postEl);
        postContainer.appendChild(deleteAction);
        const commentSection = postContainer.querySelector('.comment-section');
        if (commentSection) {
            commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
            commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
        }
        postsListEl.appendChild(postContainer);
        const commentInput = postContainer.querySelector('.comment-input');
        const popup = postContainer.querySelector('.at-mention-popup');
        commentInput.addEventListener('input', () => {
            const value = commentInput.value;
            const atMatch = value.match(/@([\p{L}\w]*)$/u);
            if (atMatch) {
                const namesToMention = new Set();
                const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                if (authorNickname) namesToMention.add(authorNickname);
                postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                    namesToMention.add(nameEl.textContent.replace(':', ''));
                });
                namesToMention.delete(state.qzoneSettings.nickname);
                popup.innerHTML = '';
                if (namesToMention.size > 0) {
                    const searchTerm = atMatch[1];
                    namesToMention.forEach(name => {
                        if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            const item = document.createElement('div');
                            item.className = 'at-mention-item';
                            item.textContent = name;
                            item.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                const newText = value.substring(0, atMatch.index) + `@${name} `;
                                commentInput.value = newText;
                                popup.style.display = 'none';
                                commentInput.focus();
                            });
                            popup.appendChild(item);
                        }
                    });
                    popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                } else {
                    popup.style.display = 'none';
                }
            } else {
                popup.style.display = 'none';
            }
        });
        commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
             
// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸ªã€æ›´æ–°åçš„ã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ displayFilteredFavorites å‡½æ•° â–¼â–¼â–¼

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸å…³æ”¶è—' : 'ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = 'æ¥è‡ªåŠ¨æ€';
            let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ·';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç å¼€å§‹ â–¼â–¼â–¼
            
            // 1. æ„é€ ç‚¹èµåŒºåŸŸçš„HTML
            let likesHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ likes æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.likes && post.likes.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºç‚¹èµåŒºåŸŸçš„ div
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span>
                    </div>`;
            }

            // 2. æ„é€ è¯„è®ºåŒºåŸŸçš„HTML
            let commentsHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ comments æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.comments && post.comments.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºè¯„è®ºå®¹å™¨ï¼Œå¹¶éå†æ¯ä¸€æ¡è¯„è®º
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }

            // 3. å°†ç‚¹èµå’Œè¯„è®ºçš„HTMLç»„åˆåˆ° footerHtml ä¸­
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç ç»“æŸ â–²â–²â–²

} else if (item.type === 'chat_message') {
    const msg = item.content;
    const chat = state.chats[item.chatId];
    if (!chat) continue; 

    sourceText = `æ¥è‡ªä¸ ${chat.name} çš„èŠå¤©`;
    const isUser = msg.role === 'user';
    let senderName, senderAvatar;

    if (isUser) {
        // ç”¨æˆ·æ¶ˆæ¯çš„é€»è¾‘ä¿æŒä¸å˜
        senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
    } else { // AI/æˆå‘˜æ¶ˆæ¯
         if (chat.isGroup) {
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
            // æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ originalName å»åŒ¹é…ï¼Œè€Œä¸æ˜¯æ—§çš„ name
            const member = chat.members.find(m => m.originalName === msg.senderName);
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
            
            senderName = msg.senderName;
            // å› ä¸ºç°åœ¨èƒ½æ­£ç¡®æ‰¾åˆ° member å¯¹è±¡äº†ï¼Œæ‰€ä»¥ä¹Ÿèƒ½æ­£ç¡®è·å–åˆ°ä»–çš„å¤´åƒ
            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
        } else {
            // å•èŠçš„é€»è¾‘ä¿æŒä¸å˜
            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
        }
    }

    // åç»­æ‹¼æ¥ headerHtml å’Œ contentHtml çš„é€»è¾‘éƒ½ä¿æŒä¸å˜
    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
    
    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }
}
        
        // â–¼â–¼â–¼ ä¿®æ”¹æœ€ç»ˆçš„HTMLæ‹¼æ¥ï¼ŒåŠ å…¥ footerHtml â–¼â–¼â–¼
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- æŠŠæˆ‘ä»¬æ–°åˆ›å»ºçš„ footerHtml æ”¾åœ¨è¿™é‡Œ
            
        listEl.appendChild(card);
    }
}

// â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–²

        /**
         * ã€é‡æ„åçš„å‡½æ•°ã€‘: è´Ÿè´£å‡†å¤‡æ•°æ®å¹¶è§¦å‘æ¸²æŸ“
         */
        async function renderFavoritesScreen() {
            // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®å¹¶ç¼“å­˜
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—æ¸…é™¤æŒ‰é’®
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. æ˜¾ç¤ºæ‰€æœ‰æ”¶è—é¡¹
            displayFilteredFavorites(allFavoriteItems);
        }

        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²åŒ…å« memoriesã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ exportBackup å‡½æ•° â–¼â–¼â–¼
async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories,
            worldBookCategories // <-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°å˜é‡
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
                        db.memories.toArray(),
            db.worldBookCategories.toArray() // <-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ å¯¹æ–°è¡¨çš„è¯»å–
        ]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories,
            worldBookCategories // <-- ã€æ ¸å¿ƒä¿®æ”¹3ã€‘å°†æ–°æ•°æ®æ·»åŠ åˆ°å¤‡ä»½å¯¹è±¡ä¸­
        });
        
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('å¯¼å‡ºæˆåŠŸ', 'å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼');

    } catch (error) {
        console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
    }
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²åŒ…å« memoriesã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ importBackup å‡½æ•° â–¼â–¼â–¼
async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'ä¸¥é‡è­¦å‘Šï¼',
        'å¯¼å…¥å¤‡ä»½å°†å®Œå…¨è¦†ç›–æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©ã€åŠ¨æ€ã€è®¾ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                await table.clear();
            }

            if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
            if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
            if (Array.isArray(data.worldBookCategories)) await db.worldBookCategories.bulkPut(data.worldBookCategories);
            if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
            if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
            if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
            if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
            if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
            if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
            if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
            if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories); // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ–°å¢

            if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
            if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
            if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
            if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
        });

        await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`);
    }
}

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚');
        }

async function loadAllDataFromDB() {
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites // å°† initialFavorites åŠ å…¥åˆ°è§£æ„èµ‹å€¼ä¸­
    ] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray() // ç¡®ä¿è¿™ä¸€è¡Œåœ¨ Promise.all çš„æ•°ç»„å‚æ•°å†…
    ]);
    // â–²â–²â–² ã€ä¿®æ”¹ç»“æŸã€‘ â–²â–²â–²

    state.chats = chatsArr.reduce((acc, chat) => {

    if (typeof chat.unreadCount === 'undefined') {
        chat.unreadCount = 0; // å¦‚æœè¿™ä¸ªèŠå¤©å¯¹è±¡æ²¡æœ‰ unreadCount å±æ€§ï¼Œå°±ç»™å®ƒåˆå§‹åŒ–ä¸º 0
    }

        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ï¼šæ•°æ®è¿ç§»è„šæœ¬ã€‘â˜…â˜…â˜…
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠï¼Œå¹¶ä¸”å…¶æˆå‘˜å¯¹è±¡ä½¿ç”¨çš„æ˜¯æ—§çš„ `name` ç»“æ„
        if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
            console.log(`æ£€æµ‹åˆ°æ—§ç‰ˆç¾¤èŠæ•°æ® for "${chat.name}"ï¼Œæ­£åœ¨æ‰§è¡Œè¿ç§»...`);
            chat.members.forEach(member => {
                // å¦‚æœè¿™ä¸ªæˆå‘˜å¯¹è±¡æ²¡æœ‰ originalNameï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
                if (typeof member.originalName === 'undefined') {
                    member.originalName = member.name; // å°†æ—§çš„ name ä½œä¸º originalName
                    member.groupNickname = member.name; // åŒæ—¶åˆ›å»ºä¸€ä¸ªåˆå§‹çš„ groupNickname
                    delete member.name; // åˆ é™¤æ—§çš„ã€æœ‰æ­§ä¹‰çš„ name å­—æ®µ
                    needsUpdate = true; // æ ‡è®°éœ€è¦å­˜å›æ•°æ®åº“
                }
            });
             console.log(`è¿ç§»å®Œæˆ for "${chat.name}"`);
        }

        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼ ---
        // æ£€æŸ¥1ï¼šå¦‚æœæ˜¯ä¸€ä¸ªå•èŠï¼Œå¹¶ä¸”æ²¡æœ‰ status å±æ€§
        if (!chat.isGroup && !chat.status) {
            // å°±ä¸ºå®ƒè¡¥ä¸Šä¸€ä¸ªé»˜è®¤çš„ status å¯¹è±¡
            chat.status = {
                text: 'åœ¨çº¿',
                lastUpdate: Date.now(),
                isBusy: false
            };
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†statuså±æ€§ã€‚`);
        }
        // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼ ---
        // æ£€æŸ¥2ï¼šå…¼å®¹æœ€æ–°çš„â€œå…³ç³»â€åŠŸèƒ½
        if (!chat.isGroup && !chat.relationship) {
            // å¦‚æœæ˜¯å•èŠï¼Œä¸”æ²¡æœ‰ relationship å¯¹è±¡ï¼Œå°±è¡¥ä¸Šä¸€ä¸ªé»˜è®¤çš„
            chat.relationship = {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
            };
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† relationship å±æ€§ã€‚`);
        }
        // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ  â–¼â–¼â–¼
    if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
        chat.settings.aiAvatarLibrary = [];
        console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†aiAvatarLibraryå±æ€§ã€‚`);
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };

state.globalSettings = globalSettings || { 
    id: 'main', 
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60,
    blockCooldownHours: 1,
    appIcons: { ...DEFAULT_APP_ICONS } // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¡®ä¿appIconså­˜åœ¨å¹¶æœ‰é»˜è®¤å€¼
};
// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆå¹¶å·²ä¿å­˜çš„å›¾æ ‡å’Œé»˜è®¤å›¾æ ‡ï¼Œé˜²æ­¢æ›´æ–°åæ—§æ•°æ®ä¸¢å¤±æ–°å›¾æ ‡
state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };

    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };

    // â–¼â–¼â–¼ ã€ç¡®ä¿è¿™ä¸€è¡Œåœ¨ Promise.all ä¹‹åï¼Œå¹¶ä½¿ç”¨è§£æ„èµ‹å€¼å¾—åˆ°çš„ initialFavoritesã€‘ â–¼â–¼â–¼
    allFavoriteItems = initialFavorites || [];
    // â–²â–²â–² ã€ä¿®æ”¹ç»“æŸã€‘ â–²â–²â–²
}

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }

/**
 * ã€ç»ˆæå¥å£®ç‰ˆã€‘è§£æAIè¿”å›çš„ã€å¯èƒ½æ ¼å¼ä¸è§„èŒƒçš„å“åº”å†…å®¹
 * @param {string} content - AIè¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
 * @returns {Array} - ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯å¯¹è±¡æ•°ç»„
 */
function parseAiResponse(content) {
    const trimmedContent = content.trim();

    // æ–¹æ¡ˆ1ï¼šã€æœ€ä¼˜å…ˆã€‘å°è¯•ä½œä¸ºæ ‡å‡†çš„ã€å•ä¸€çš„JSONæ•°ç»„è§£æ
    // è¿™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…å†µ
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                console.log("è§£ææˆåŠŸï¼šæ ‡å‡†JSONæ•°ç»„æ ¼å¼ã€‚");
                return parsed;
            }
        } catch (e) {
            // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜å®ƒè™½ç„¶çœ‹èµ·æ¥åƒä¸ªæ•°ç»„ï¼Œä½†å†…éƒ¨æ ¼å¼æœ‰é—®é¢˜ã€‚
            // æ­¤æ—¶æˆ‘ä»¬ä¸æŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­å°è¯•ä¸‹é¢çš„â€œå¼ºåŠ›è§£æâ€æ–¹æ¡ˆã€‚
            console.warn("æ ‡å‡†JSONæ•°ç»„è§£æå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›è§£æ...");
        }
    }

    // æ–¹æ¡ˆ2ï¼šã€å¼ºåŠ›è§£æã€‘ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»æ··ä¹±çš„å­—ç¬¦ä¸²ä¸­æå–å‡ºæ‰€æœ‰ç‹¬ç«‹çš„JSONå¯¹è±¡
    // è¿™èƒ½å®Œç¾è§£å†³æ‚¨é‡åˆ°çš„ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" è¿™ç§æ ¼å¼
    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

    if (jsonMatches) {
        const results = [];
        for (const match of jsonMatches) {
            try {
                // å°è¯•è§£ææ¯ä¸€ä¸ªè¢«æˆ‘ä»¬â€œæªâ€å‡ºæ¥çš„JSONå­—ç¬¦ä¸²
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
            } catch (e) {
                // å¦‚æœæŸä¸ªç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå°±å¿½ç•¥å®ƒï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
                console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", match);
            }
        }

        // å¦‚æœæˆ‘ä»¬æˆåŠŸæå–å‡ºäº†è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„JSONå¯¹è±¡ï¼Œå°±è¿”å›è¿™ä¸ªç»“æœ
        if (results.length > 0) {
            console.log("è§£ææˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå–æ¨¡å¼ã€‚");
            return results;
        }
    }
    
    // æ–¹æ¡ˆ3ï¼šã€æœ€ç»ˆå¤‡ç”¨ã€‘å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œè¯´æ˜AIè¿”å›çš„å¯èƒ½å°±æ˜¯çº¯æ–‡æœ¬
    // æˆ‘ä»¬å°†åŸå§‹çš„ã€æœªå¤„ç†çš„å†…å®¹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ ‡å‡†çš„æ–‡æœ¬æ¶ˆæ¯å¯¹è±¡è¿”å›ï¼Œç¡®ä¿ç¨‹åºä¸ä¼šå´©æºƒ
    console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
    return [{ type: 'text', content: content }];
}

        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
    // â–¼â–¼â–¼ æ–°å¢è¿™è¡Œ â–¼â–¼â–¼
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
}
        window.renderApiSettingsProxy = renderApiSettings;

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderChatList â–¼â–¼â–¼
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. åƒä»¥å‰ä¸€æ ·ï¼Œè·å–æ‰€æœ‰èŠå¤©å¹¶æŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åº
    const allChats = Object.values(state.chats).sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    // 2. è·å–æ‰€æœ‰åˆ†ç»„
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>';
        return;
    }

    // --- ã€æ ¸å¿ƒä¿®æ­£å¼€å§‹ã€‘---

    // 3. ä¸ºæ¯ä¸ªåˆ†ç»„æ‰¾åˆ°å…¶å†…éƒ¨æœ€æ–°çš„æ¶ˆæ¯æ—¶é—´æˆ³
    allGroups.forEach(group => {
        // ä»å·²æ’åºçš„ allChats ä¸­æ‰¾åˆ°æœ¬ç»„çš„ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿå°±æ˜¯æœ€æ–°çš„ï¼‰èŠå¤©
        const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
        // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç”¨å®ƒçš„æ—¶é—´æˆ³ï¼›å¦‚æœè¯¥åˆ†ç»„æš‚æ—¶æ²¡æœ‰èŠå¤©æˆ–èŠå¤©æ²¡æœ‰å†å²è®°å½•ï¼Œå°±ç”¨0
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // 4. æ ¹æ®è¿™ä¸ªæœ€æ–°çš„æ—¶é—´æˆ³æ¥å¯¹â€œåˆ†ç»„æœ¬èº«â€è¿›è¡Œæ’åº
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // --- ã€æ ¸å¿ƒä¿®æ­£ç»“æŸã€‘---

    // 5. ç°åœ¨ï¼Œæˆ‘ä»¬æŒ‰ç…§æ’å¥½åºçš„åˆ†ç»„æ¥æ¸²æŸ“
    allGroups.forEach(group => {
        // ä»æ€»åˆ—è¡¨é‡Œè¿‡æ»¤å‡ºå±äºè¿™ä¸ªï¼ˆå·²æ’åºï¼‰åˆ†ç»„çš„å¥½å‹
        const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
        // å¦‚æœè¿™ä¸ªåˆ†ç»„æ˜¯ç©ºçš„ï¼ˆå¯èƒ½æ‰€æœ‰å¥½å‹éƒ½è¢«åˆ äº†ï¼‰ï¼Œå°±è·³è¿‡
        if (groupChats.length === 0) return;

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">â–¼</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');
        // å› ä¸º allChats æœ¬èº«å°±æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥ groupChats è‡ªç„¶ä¹Ÿæ˜¯æœ‰åºçš„
        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 6. æœ€åï¼Œæ¸²æŸ“æ‰€æœ‰ç¾¤èŠå’Œæœªåˆ†ç»„çš„å¥½å‹
    // ä»–ä»¬çš„é¡ºåºå› ä¸º allChats çš„åˆå§‹æ’åºï¼Œå¤©ç„¶å°±æ˜¯æ­£ç¡®çš„
    const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
    ungroupedOrGroupChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡ŒåŠ å…¥å¯¹å…³ç³»çŠ¶æ€çš„åˆ¤æ–­ â–¼â–¼â–¼ ---
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è¯·] ${chat.relationship.applicationReason || 'è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹'}</span>`;
    }
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ else if â–¼â–¼â–¼
else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
    lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]</span>`;
}
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¼˜å…ˆæ˜¾ç¤ºçŠ¶æ€ï¼Œè€Œä¸æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯
    if (chat.isGroup) {
        // ç¾¤èŠé€»è¾‘ä¿æŒä¸å˜
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ç³»ç»Ÿæ¶ˆæ¯] ${lastMsgObj.content}`; }
        // ... (å…¶ä»–ç¾¤èŠæ¶ˆæ¯ç±»å‹åˆ¤æ–­) ...
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½¬è´¦]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[è¯­éŸ³]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[å›¾ç‰‡]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }

        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }

    } else {
        // å•èŠé€»è¾‘ï¼šæ˜¾ç¤ºçŠ¶æ€
        // ç¡®ä¿ chat.status å¯¹è±¡å­˜åœ¨
        const statusText = chat.status?.text || 'åœ¨çº¿';
        lastMsgDisplay = `[${statusText}]`;
    }

    const item = document.createElement('div');
    item.className = 'chat-list-item';
    item.dataset.chatId = chat.id;
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    
    item.innerHTML = `
        <img src="${avatar || defaultAvatar}" class="avatar">
        <div class="info">
            <div class="name-line">
                <span class="name">${chat.name}</span>
                ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
            </div>
            <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
        </div>
        <!-- è¿™é‡Œå°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„çº¢ç‚¹HTMLç»“æ„ -->
        <div class="unread-count-wrapper">
            <span class="unread-count" style="display: none;">0</span>
        </div>
    `;
    
    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ§åˆ¶çº¢ç‚¹æ˜¾ç¤º/éšè—çš„é€»è¾‘
    const unreadCount = chat.unreadCount || 0;
    const unreadEl = item.querySelector('.unread-count');
    if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        // æ³¨æ„è¿™é‡Œæ˜¯ 'inline-flex'ï¼Œä¸æˆ‘ä»¬çš„CSSå¯¹åº”ï¼Œä½¿å…¶å‚ç›´å±…ä¸­
        unreadEl.style.display = 'inline-flex';
    } else {
        unreadEl.style.display = 'none';
    }
    
    const avatarEl = item.querySelector('.avatar');
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, chat.name);
        });
    }
    
    const infoEl = item.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }

    addLongPressListener(item, async (e) => {
        const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
            delete state.chats[chat.id];
            if (state.activeChatId === chat.id) state.activeChatId = null;
            await db.chats.delete(chat.id);
            renderChatList();
        }
    });
    return item;
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å¸¦è¯Šæ–­åŠŸèƒ½çš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderChatInterface å‡½æ•° â–¼â–¼â–¼
function renderChatInterface(chatId) {
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || 'åœ¨çº¿';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                // --- ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡ŒåŠ å…¥è¯Šæ–­é¢æ¿ã€‘ ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">ä½ å·²å°†â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
                    <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">ã€å¼€å‘è€…è¯Šæ–­é¢æ¿ã€‘</strong><br>
                        - åå°æ´»åŠ¨æ€»å¼€å…³: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²å¼€å¯</span>' : '<span style="color: red;">å·²å…³é—­</span>'}<br>
                        - ç³»ç»Ÿå¿ƒè·³è®¡æ—¶å™¨: ${isSimulationRunning ? '<span style="color: green;">è¿è¡Œä¸­</span>' : '<span style="color: red;">æœªè¿è¡Œ</span>'}<br>
                        - å½“å‰è§’è‰²çŠ¶æ€: <strong>${chat.relationship.status}</strong><br>
                        - éœ€è¦å†·é™(å°æ—¶): <strong>${cooldownHours}</strong><br>
                        - å†·é™æœŸæ˜¯å¦ç»“æŸ: ${isCooldownOver ? '<span style="color: green;">æ˜¯</span>' : `<span style="color: orange;">å¦ (è¿˜å‰©çº¦ ${timeRemainingMinutes} åˆ†é’Ÿ)</span>`}<br>
                        - è§¦å‘æ¡ä»¶: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²æ»¡è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿå¿ƒè·³</span>' : '<span style="color: red;">æœªæ»¡è¶³</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¥½å‹ç”³è¯·æ£€æµ‹</button>
                `;
                // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text">ä½ è¢«å¯¹æ–¹æ‹‰é»‘äº†ã€‚</span>
                    <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è¯·åŠ ä¸ºå¥½å‹</button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">â€œ${chat.name}â€è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹ï¼š<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’ç»</button>
                `;
                break;

            // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¿®å¤å½“ä½ ç”³è¯·åï¼Œä½ çœ‹åˆ°çš„ç•Œé¢
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">å¥½å‹ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹é€šè¿‡...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
    // ...åç»­ä»£ç ä¿æŒä¸å˜
    const chatScreen = document.getElementById('chat-interface-screen');
    chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';

const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
    initialMessages.forEach(msg => appendMessage(msg, chat, true));
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderWallpaperScreen å‡½æ•° â–¼â–¼â–¼
function renderWallpaperScreen() { 
    const preview = document.getElementById('wallpaper-preview'); 
    const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
    if (bg && bg.startsWith('data:image')) { 
        preview.style.backgroundImage = `url(${bg})`; 
        preview.textContent = ''; 
    } else if(bg) { 
        preview.style.backgroundImage = bg; 
        preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²'; 
    }
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œè°ƒç”¨å›¾æ ‡æ¸²æŸ“å‡½æ•°
    renderIconSettings();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

async function renderWorldBookScreen() {
    const listEl = document.getElementById('world-book-list');
    listEl.innerHTML = '';

    // 1. åŒæ—¶è·å–æ‰€æœ‰ä¹¦ç±å’Œæ‰€æœ‰åˆ†ç±»
    const [books, categories] = await Promise.all([
        db.worldBooks.toArray(),
        db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books; // ç¡®ä¿å†…å­˜ä¸­çš„æ•°æ®æ˜¯åŒæ­¥çš„

    if (books.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>';
        return;
    }

    // 2. å°†ä¹¦ç±æŒ‰ categoryId åˆ†ç»„
    const groupedBooks = books.reduce((acc, book) => {
        const key = book.categoryId || 'uncategorized';
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(book);
        return acc;
    }, {});

    // 3. ä¼˜å…ˆæ¸²æŸ“å·²åˆ†ç±»çš„ä¹¦ç±
    categories.forEach(category => {
        const booksInCategory = groupedBooks[category.id];
        if (booksInCategory && booksInCategory.length > 0) {
            const groupContainer = createWorldBookGroup(category.name, booksInCategory);
            listEl.appendChild(groupContainer);
        }
    });

    // 4. æœ€åæ¸²æŸ“æœªåˆ†ç±»çš„ä¹¦ç±
    const uncategorizedBooks = groupedBooks['uncategorized'];
    if (uncategorizedBooks && uncategorizedBooks.length > 0) {
        const groupContainer = createWorldBookGroup('æœªåˆ†ç±»', uncategorizedBooks);
        listEl.appendChild(groupContainer);
    }
    
    // 5. ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.world-book-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘åˆ›å»ºä¸€ä¸ªåˆ†ç±»çš„åˆ†ç»„DOM
 * @param {string} groupName - åˆ†ç±»åç§°
 * @param {Array} books - è¯¥åˆ†ç±»ä¸‹çš„ä¹¦ç±æ•°ç»„
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„åˆ†ç»„å®¹å™¨
 */
function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';
    
    groupContainer.innerHTML = `
        <div class="world-book-group-header">
            <span class="arrow">â–¼</span>
            <span class="group-name">${groupName}</span>
        </div>
        <div class="world-book-group-content"></div>
    `;

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
    const headerEl = groupContainer.querySelector('.world-book-group-header');
    const contentEl = groupContainer.querySelector('.world-book-group-content');
    
    // é»˜è®¤ç»™å¤´éƒ¨å’Œå†…å®¹åŒºéƒ½åŠ ä¸Š collapsed ç±»
    headerEl.classList.add('collapsed');
    contentEl.classList.add('collapsed');
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš‚æ— å†…å®¹...').substring(0, 50)}</div>`;
        item.addEventListener('click', () => openWorldBookEditor(book.id));
        addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } });
        contentEl.appendChild(item); 
    });

    return groupContainer;
}
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

async function openWorldBookEditor(bookId) {
    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
        db.worldBooks.get(bookId),
        db.worldBookCategories.toArray()
    ]);
    if (!book) return;

    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;
    document.getElementById('world-book-content-input').value = book.content;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¡«å……åˆ†ç±»ä¸‹æ‹‰èœå•
    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>'; // é»˜è®¤é€‰é¡¹
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        if (book.categoryId === cat.id) {
            option.selected = true; // é€‰ä¸­å½“å‰åˆ†ç±»
        }
        selectEl.appendChild(option);
    });

    showScreen('world-book-editor-screen');
}

        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€æˆ–â€œä¸Šä¼ â€æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§ï¼</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ createMessageElement å‡½æ•° â–¼â–¼â–¼
function createMessageElement(msg, chat) {

    // â–¼â–¼â–¼ åœ¨å‡½æ•°æœ€å¼€å¤´ï¼Œæ·»åŠ è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
if (msg.type === 'recalled_message') {
    const wrapper = document.createElement('div');
    // 1. ã€æ ¸å¿ƒã€‘ç»™ wrapper ä¹ŸåŠ ä¸Š timestampï¼Œæ–¹ä¾¿äº‹ä»¶å§”æ‰˜æ—¶æŸ¥æ‰¾
    wrapper.className = 'message-wrapper system-pat';
    wrapper.dataset.timestamp = msg.timestamp; 

    const bubble = document.createElement('div');
    // 2. ã€æ ¸å¿ƒã€‘è®©è¿™ä¸ªå…ƒç´ åŒæ—¶æ‹¥æœ‰ .message-bubble å’Œ .recalled-message-placeholder ä¸¤ä¸ªclass
    //    è¿™æ ·å®ƒæ—¢èƒ½è¢«é€‰æ‹©ç³»ç»Ÿè¯†åˆ«ï¼Œåˆèƒ½ä¿æŒåŸæœ‰çš„å±…ä¸­ç°è‰²æ ·å¼
    bubble.className = 'message-bubble recalled-message-placeholder';
    // 3. ã€æ ¸å¿ƒã€‘æŠŠ timestamp æ”¾åœ¨ bubble ä¸Šï¼Œè¿™æ˜¯å¤šé€‰é€»è¾‘çš„å…³é”®
    bubble.dataset.timestamp = msg.timestamp; 
    bubble.textContent = msg.content;
    
    wrapper.appendChild(bubble);
    
    // 4. ã€æ ¸å¿ƒã€‘ä¸ºå®ƒè¡¥ä¸Šå’Œå…¶ä»–æ¶ˆæ¯ä¸€æ ·çš„æ ‡å‡†äº‹ä»¶ç›‘å¬å™¨
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(msg.timestamp);
        }
    });

    // 5. ã€é‡è¦ã€‘åœ¨ä¹‹å‰çš„â€œç‚¹å‡»æŸ¥çœ‹åŸæ–‡â€çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨äº†äº‹ä»¶å§”æ‰˜ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å•ç‹¬ä¸ºè¿™ä¸ªå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶äº†ã€‚
    //    init() å‡½æ•°ä¸­çš„é‚£ä¸ªäº‹ä»¶ç›‘å¬å™¨ä¼šå¤„ç†å®ƒã€‚
    
    return wrapper;
}
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    if (msg.isHidden) {
        return null;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    // è¿™æ®µé€»è¾‘ç°åœ¨ç”¨äºæŸ¥æ‰¾æˆå‘˜å¯¹è±¡ï¼Œå¹¶æ˜¾ç¤ºå…¶â€œç¾¤æ˜µç§°â€
    if (chat.isGroup && !isUser) {
        // 1. ä½¿ç”¨AIè¿”å›çš„â€œæœ¬åâ€(`msg.senderName`)å»åˆ—è¡¨é‡ŒæŸ¥æ‰¾æˆå‘˜å¯¹è±¡
        const member = chat.members.find(m => m.originalName === msg.senderName);
        
        // 2. åˆ›å»ºç”¨äºæ˜¾ç¤ºåå­—çš„ div
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'sender-name';
        
        // 3. å¦‚æœæ‰¾åˆ°äº†æˆå‘˜ï¼Œå°±æ˜¾ç¤ºä»–çš„â€œç¾¤æ˜µç§°â€ï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±æ˜¾ç¤ºAIè¿”å›çš„â€œæœ¬åâ€ä½œä¸ºå¤‡ç”¨
        senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'æœªçŸ¥æˆå‘˜');
        
        wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    // â–¼â–¼â–¼ã€ç²˜è´´è¿™æ®µæ–°ä»£ç ã€‘â–¼â–¼â–¼
    let avatarSrc; // æˆ‘ä»¬ç°åœ¨åªéœ€è¦å¤´åƒå›¾ç‰‡ï¼Œä¸å†éœ€è¦å¤´åƒæ¡†äº†
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
        } else {
            const member = chat.members.find(m => m.originalName === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
        }
    }
    // ç›´æ¥ç”Ÿæˆæœ€ç®€å•çš„å¤´åƒHTMLï¼Œä¸å†æœ‰ä»»ä½•å’Œå¤´åƒæ¡†ç›¸å…³çš„é€»è¾‘
    const avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    // â–²â–²â–²ã€ç²˜è´´ç»“æŸã€‘â–²â–²â–²

    let contentHtml;
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°† onclick="openBrowser(...)" ç§»é™¤ï¼Œæˆ‘ä»¬å°†åœ¨JSä¸­åŠ¨æ€ç»‘å®šäº‹ä»¶
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || 'æ— æ ‡é¢˜'}</div>
                <div class="description">${msg.description || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || 'é“¾æ¥åˆ†äº«'}</span>
                </div>
            </div>
        `;
    }

else if (msg.type === 'share_card') {
    bubble.classList.add('is-link-share'); // å¤ç”¨é“¾æ¥åˆ†äº«çš„å¡ç‰‡æ ·å¼
    // ã€æ ¸å¿ƒã€‘æŠŠæ—¶é—´æˆ³åŠ åˆ°å¡ç‰‡ä¸Šï¼Œæ–¹ä¾¿åé¢ç‚¹å‡»æ—¶è¯†åˆ«
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
            <div class="title">${msg.payload.title}</div>
            <div class="description">å…± ${msg.payload.sharedHistory.length} æ¡æ¶ˆæ¯</div>
            <div class="footer">
                <svg class="footer-icon" ...>...</svg> <!-- å¤ç”¨é“¾æ¥åˆ†äº«çš„å›¾æ ‡ -->
                <span>èŠå¤©è®°å½•</span>
            </div>
        </div>
    `;
}

    // åç»­çš„å…¶ä»– else if ä¿æŒä¸å˜
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
    bubble.classList.add('is-voice-message');
    
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°†è¯­éŸ³åŸæ–‡å­˜å‚¨åœ¨çˆ¶çº§æ°”æ³¡çš„ data-* å±æ€§ä¸­ï¼Œæ–¹ä¾¿äº‹ä»¶å¤„ç†å™¨è·å–
    bubble.dataset.voiceText = msg.content;
    
    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ„å»ºåŒ…å«æ‰€æœ‰æ–°å…ƒç´ çš„å®Œæ•´ HTML
    contentHtml = `
        <div class="voice-message-body">
            <div class="voice-waveform">${waveformHTML}</div>
            <div class="loading-spinner"></div>
            <span class="voice-duration">${durationFormatted}</span>
        </div>
        <div class="voice-transcript"></div>
    `;
} else if (msg.type === 'transfer') {
    bubble.classList.add('is-transfer');
    
    let titleText, noteText;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    if (isUser) { // æ¶ˆæ¯æ˜¯ç”¨æˆ·å‘å‡ºçš„
        if (msg.isRefund) {
            // ç”¨æˆ·å‘å‡ºçš„é€€æ¬¾ï¼ˆå³ç”¨æˆ·æ‹’æ”¶äº†AIçš„è½¬è´¦ï¼‰
            titleText = `é€€æ¬¾ç»™ ${chat.name}`;
            noteText = 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦';
        } else {
            // ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„è½¬è´¦
            titleText = `è½¬è´¦ç»™ ${msg.receiverName || chat.name}`;
            if (msg.status === 'accepted') {
                noteText = 'å¯¹æ–¹å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'å¯¹æ–¹å·²æ‹’æ”¶';
            } else {
                noteText = msg.note || 'ç­‰å¾…å¯¹æ–¹å¤„ç†...';
            }
        }
    } else { // æ¶ˆæ¯æ˜¯ AI å‘å‡ºçš„
        if (msg.isRefund) {
            // AI çš„é€€æ¬¾ï¼ˆAI æ‹’æ”¶äº†ç”¨æˆ·çš„è½¬è´¦ï¼‰
            titleText = `é€€æ¬¾æ¥è‡ª ${msg.senderName}`;
            noteText = 'è½¬è´¦å·²è¢«æ‹’æ”¶';
        } else if (msg.receiverName === myNickname) {
            // ã€æ ¸å¿ƒä¿®æ­£1ã€‘è¿™æ˜¯ AI ä¸»åŠ¨ç»™ç”¨æˆ·çš„è½¬è´¦
            titleText = `è½¬è´¦ç»™ ${myNickname}`;
             if (msg.status === 'accepted') {
                noteText = 'ä½ å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'ä½ å·²æ‹’æ”¶';
            } else {
                // è¿™æ˜¯ç”¨æˆ·éœ€è¦å¤„ç†çš„è½¬è´¦
                bubble.style.cursor = 'pointer';
                bubble.dataset.status = 'pending';
                noteText = msg.note || 'ç‚¹å‡»å¤„ç†';
            }
        } else {
            // ã€æ ¸å¿ƒä¿®æ­£2ã€‘è¿™æ˜¯ AI å‘ç»™ç¾¤é‡Œå…¶ä»–äººçš„è½¬è´¦ï¼Œå¯¹å½“å‰ç”¨æˆ·æ¥è¯´åªæ˜¯ä¸€ä¸ªé€šçŸ¥
            titleText = `è½¬è´¦: ${msg.senderName} â†’ ${msg.receiverName}`;
            noteText = msg.note || 'ç¾¤èŠå†…è½¬è´¦';
        }
    }

    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
    contentHtml = `
        <div class="transfer-card">
            <div class="transfer-title">${heartIcon} ${titleText}</div>
            <div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div>
            <div class.transfer-note">${noteText}</div>
        </div>
    `;
} else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request');
        if (msg.status === 'paid' || msg.status === 'rejected') {
            bubble.classList.add(`status-${msg.status}`);
        }
        let displayName;
        // å¦‚æœæ˜¯ç¾¤èŠ
        if (chat.isGroup) {
            // å°±æ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼šåœ¨æˆå‘˜åˆ—è¡¨é‡ŒæŸ¥æ‰¾æ˜µç§°
            const member = chat.members.find(m => m.originalName === msg.senderName);
            displayName = member ? member.groupNickname : msg.senderName;
        } else {
            // å¦åˆ™ï¼ˆæ˜¯å•èŠï¼‰ï¼Œç›´æ¥ä½¿ç”¨èŠå¤©å¯¹è±¡çš„åç§°
            displayName = chat.name;
        }
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæŸ¥æ‰¾åˆ°çš„ displayName
        const requestTitle = `æ¥è‡ª ${displayName} çš„ä»£ä»˜è¯·æ±‚`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
            actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected">æ®‹å¿æ‹’ç»</button>
                    <button class="waimai-pay-btn" data-choice="paid">ä¸ºTaä¹°å•</button>
                </div>`;
        }
        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand">ç¾å›¢å¤–å–</span><span class="separator">|</span><span>å¤–å–ç¾é£Ÿ</span>
                    </div>
                </div>
                <div class="waimai-catchphrase">Hiï¼Œä½ å’Œæˆ‘çš„è·ç¦»åªå·®ä¸€é¡¿å¤–å–ï½</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label">éœ€ä»˜æ¬¾</div>
                        <div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">å‰©ä½™æ”¯ä»˜æ—¶é—´
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn">æŸ¥çœ‹è¯¦æƒ…</button>
                </div>
                ${actionButtonsHtml}
            </div>`;
        
        setTimeout(() => {
            const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === 'pending') {
                    waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                } else {
                    timerEl.innerHTML = `<span>å·²</span><span>å¤„</span><span>ç†</span>`;
                }
            }
            const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paidByText = msg.paidBy ? `<br><br><b>çŠ¶æ€ï¼š</b>ç”± ${msg.paidBy} ä¸ºæ‚¨ä»£ä»˜æˆåŠŸ` : '';
                    showCustomAlert('è®¢å•è¯¦æƒ…', `<b>å•†å“ï¼š</b>${msg.productInfo}<br><b>é‡‘é¢ï¼š</b>Â¥${Number(msg.amount).toFixed(2)}${paidByText}`);
                });
            }
            const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const choice = e.target.dataset.choice;
                    handleWaimaiResponse(msg.timestamp, choice);
                });
            });
        }, 0);

} else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // ä»æœ€æ–°çš„ msg å¯¹è±¡ä¸­è·å–çŠ¶æ€
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = 'æ‹¼æ‰‹æ°”çº¢åŒ…';

    // 1. åˆ¤æ–­çº¢åŒ…å¡ç‰‡çš„æ ·å¼ (é¢œè‰²)
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; // ä¸“å±çº¢åŒ…è¢«é¢†äº†ä¹Ÿå˜ç°
    }
    
    // 2. åˆ¤æ–­çº¢åŒ…ä¸‹æ–¹çš„æç¤ºæ–‡å­—
    if (msg.packetType === 'direct') {
        typeText = `ä¸“å±çº¢åŒ…: ç»™ ${msg.receiverName}`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info">ä½ é¢†å–äº†çº¢åŒ…ï¼Œé‡‘é¢ ${msg.claimedBy[myNickname].toFixed(2)} å…ƒ</div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info">çº¢åŒ…å·²è¢«é¢†å®Œ</div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${msg.receiverName} é¢†å–</div>`;
    }

    // 3. æ‹¼æ¥æœ€ç»ˆçš„HTMLï¼Œç¡®ä¿onclickè°ƒç”¨çš„æ˜¯æˆ‘ä»¬æ³¨å†Œåˆ°å…¨å±€çš„å‡½æ•°
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    } else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    // è®¡ç®—æ€»ç¥¨æ•°å’Œæ¯ä¸ªé€‰é¡¹çš„ç¥¨æ•°
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} ç¥¨</span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œç»Ÿä¸€æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
    if (msg.isClosed) {
        // å¦‚æœæŠ•ç¥¨å·²ç»“æŸï¼Œæ€»æ˜¯æ˜¾ç¤ºâ€œæŸ¥çœ‹ç»“æœâ€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹ç»“æœ</button></div>`;
    } else {
        // å¦‚æœæŠ•ç¥¨æœªç»“æŸï¼Œæ€»æ˜¯æ˜¾ç¤ºâ€œç»“æŸæŠ•ç¥¨â€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">ç»“æŸæŠ•ç¥¨</button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„å¼•ç”¨æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼

// 1. ã€ç»Ÿä¸€é€»è¾‘ã€‘æ£€æŸ¥æ¶ˆæ¯å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨å¼•ç”¨ä¿¡æ¯ (msg.quote)
let quoteHtml = '';
// æ— è®ºæ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯AIæ¶ˆæ¯ï¼Œåªè¦å®ƒåŒ…å«äº† .quote å¯¹è±¡ï¼Œå°±æ‰§è¡Œè¿™æ®µé€»è¾‘
if (msg.quote) {
    // a. ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥è·å–å®Œæ•´çš„ã€æœªç»æˆªæ–­çš„å¼•ç”¨å†…å®¹
    const fullQuotedContent = String(msg.quote.content || '');
    
    // b. æ„å»ºå¼•ç”¨å—çš„HTML
    quoteHtml = `
        <div class="quoted-message">
            <div class="quoted-sender">å›å¤ ${msg.quote.senderName}:</div>
            <div class="quoted-content">${fullQuotedContent}</div>
        </div>
    `;
}

// 2. æ‹¼æ¥æœ€ç»ˆçš„æ°”æ³¡å†…å®¹
//    å°†æ„å»ºå¥½çš„ quoteHtml (å¦‚æœå­˜åœ¨) å’Œ contentHtml ç»„åˆèµ·æ¥
    // --- ã€æœ€ç»ˆæ­£ç¡®ç»“æ„ã€‘å°†å¤´åƒå’Œå†…å®¹éƒ½æ”¾å›æ°”æ³¡å†…éƒ¨ ---
    bubble.innerHTML = `
        ${avatarHtml}
        <div class="content">
            ${quoteHtml}
            ${contentHtml}
        </div>
    `;
    
    // --- ã€æœ€ç»ˆæ­£ç¡®ç»“æ„ã€‘å°†å®Œæ•´çš„â€œæ°”æ³¡â€å’Œâ€œæ—¶é—´æˆ³â€æ”¾å…¥å®¹å™¨ ---
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

if (!isUser) {
    const avatarEl = wrapper.querySelector('.avatar'); //  <-- 1. æŠŠæŸ¥æ‰¾ç›®æ ‡æ”¹æˆ '.avatar'
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {    //  <-- 2. ç¡®ä¿è¿™é‡Œä¹Ÿç”¨æ–°å˜é‡
            e.stopPropagation();
            const characterName = chat.isGroup ? msg.senderName : chat.name;
            handleUserPat(chat.id, characterName);
        });
    }
}

return wrapper;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- æ–°å¢è¿™è¡Œï¼ŒåŒæ ·çš„å¤„ç†

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å¸¦åŠ¨ç”»çš„ç‰ˆæœ¬ã€‘æ›¿æ¢ä½ åŸæ¥çš„ appendMessage å‡½æ•° â–¼â–¼â–¼
function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // å¦‚æœæ¶ˆæ¯æ˜¯éšè—çš„ï¼Œåˆ™ä¸å¤„ç†

    // ã€æ ¸å¿ƒã€‘åªå¯¹æ–°æ¶ˆæ¯æ·»åŠ åŠ¨ç”»ï¼Œä¸å¯¹åˆå§‹åŠ è½½çš„æ¶ˆæ¯æ·»åŠ 
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; // å®‰å…¨æ£€æŸ¥

    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨è¿™é‡Œå°†æœªè¯»æ•°æ¸…é›¶
    if (chat.unreadCount > 0) {
        chat.unreadCount = 0;
        await db.chats.put(chat); // åˆ«å¿˜äº†æŠŠè¿™ä¸ªæ”¹å˜åŒæ­¥åˆ°æ•°æ®åº“
        // æˆ‘ä»¬ç¨åä¼šåœ¨æ¸²æŸ“åˆ—è¡¨æ—¶é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ç«‹å³é‡ç»˜åˆ—è¡¨
    }

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`æ£€æµ‹åˆ°å¥½å‹ç”³è¯·å¾…å¤„ç†çŠ¶æ€ï¼Œä¸ºè§’è‰² "${chat.name}" è‡ªåŠ¨è§¦å‘AIå“åº”...`);
        triggerAiResponse();
    }
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—æŠ•ç¥¨æŒ‰é’®
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

const chatHeaderTitle = document.getElementById('chat-header-title');

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹1ï¼šè·å–ç¾¤èŠçš„è¾“å…¥æç¤ºå…ƒç´ ã€‘â˜…â˜…â˜…â˜…â˜…
    const typingIndicator = document.getElementById('typing-indicator');

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹2ï¼šæ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ˜¾ç¤ºå“ªç§â€œæ­£åœ¨è¾“å…¥â€ã€‘â˜…â˜…â˜…â˜…â˜…
    if (chat.isGroup) {
        // å¦‚æœæ˜¯ç¾¤èŠï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†ä¸Šæ–¹çš„æç¤ºæ¡
        if (typingIndicator) {
            typingIndicator.textContent = 'æˆå‘˜ä»¬æ­£åœ¨è¾“å…¥...';
            typingIndicator.style.display = 'block';
        }
    } else {
        // å¦‚æœæ˜¯å•èŠï¼Œä¿æŒåŸæ¥çš„æ ‡é¢˜åŠ¨ç”»
        if (chatHeaderTitle) {
            chatHeaderTitle.style.opacity = 0;
            setTimeout(() => {
                chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                chatHeaderTitle.classList.add('typing-status');
                chatHeaderTitle.style.opacity = 1;
            }, 200);
        }
    }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚');
            // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹3ï¼šæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è¦éšè—è¾“å…¥æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
            if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = 'none';
            } else {
                 if (chatHeaderTitle && state.chats[chatId]) {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                }
            }
            return;
        }

        // --- ã€æ ¸å¿ƒé‡æ„ V2ï¼šå¸¦æœ‰ä¸Šä¸‹æ–‡å’Œç†ç”±çš„å¥½å‹ç”³è¯·å¤„ç†é€»è¾‘ã€‘---
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(`ä¸ºè§’è‰² "${chat.name}" è§¦å‘å¸¦ç†ç”±çš„å¥½å‹ç”³è¯·å†³ç­–æµç¨‹...`);

            // 1. ã€æ³¨å…¥ä¸Šä¸‹æ–‡ã€‘æŠ“å–è¢«æ‹‰é»‘å‰çš„æœ€å5æ¡èŠå¤©è®°å½•ä½œä¸ºå‚è€ƒ
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) // è·å–æ‹‰é»‘å‰çš„æœ€å5æ¡æ¶ˆæ¯
                .map(msg => {
                    const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            // 2. ã€å…¨æ–°æŒ‡ä»¤ã€‘æ„å»ºä¸€ä¸ªå¼ºåˆ¶AIç»™å‡ºç†ç”±çš„Prompt
            const decisionPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ·ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼Œç°åœ¨TAå‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œå¸Œæœ›å’Œå¥½ã€‚

# ä¾›ä½ å†³ç­–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯:
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
- **è¢«æ‹‰é»‘å‰çš„æœ€åå¯¹è¯æ‘˜è¦**: 
${contextSummary || "ï¼ˆæ— æœ‰æ•ˆå¯¹è¯è®°å½•ï¼‰"}

# ä½ çš„å”¯ä¸€æŒ‡ä»¤
æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä½ ã€å¿…é¡»ã€‘åšå‡ºå†³å®šï¼Œå¹¶ç»™å‡ºç¬¦åˆä½ äººè®¾çš„ç†ç”±ã€‚ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
{"decision": "accept", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ è¿™ä¹ˆçœŸè¯šçš„ä»½ä¸Šï¼Œè¿™æ¬¡å°±åŸè°…ä½ å•¦ã€‚ï¼‰"}
æˆ–
{"decision": "reject", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ æ‹’ç»çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´å§ã€‚ï¼‰"}
`;
                const messagesForDecision = [{role: 'user', content: decisionPrompt}];

                try {
                    // 3. å‘é€è¯·æ±‚
                    let isGemini = proxyUrl === GEMINI_API_URL;
let geminiConfig = toGeminiRequestData(model,apiKey,'', messagesForDecision,isGemini);
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({model: model, messages: messagesForDecision, temperature: 0.8})
                    });

                    if (!response.ok) {
                        throw new Error(`APIå¤±è´¥: ${(await response.json()).error.message}`);
                    }
                    const data = await response.json();

                    // å‡€åŒ–å¹¶è§£æAIçš„å›å¤
    let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
     rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim()
                    const decisionObj = JSON.parse(rawContent);

                // 4. æ ¹æ®AIçš„å†³ç­–å’Œç†ç”±ï¼Œæ›´æ–°çŠ¶æ€å¹¶å‘é€æ¶ˆæ¯
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    // å°†AIç»™å‡ºçš„ç†ç”±ä½œä¸ºä¸€æ¡æ–°æ¶ˆæ¯
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; // æ‹’ç»åï¼ŒçŠ¶æ€å˜å›AIæ‹‰é»‘
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; // æ¸…ç©ºç”³è¯·ç†ç”±

                await db.chats.put(chat);
                renderChatInterface(chatId); // åˆ·æ–°ç•Œé¢ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯å’Œæ–°çŠ¶æ€
                renderChatList();

            } catch (error) {
                // ã€å¯é çš„é”™è¯¯å¤„ç†ã€‘å¦‚æœä»»ä½•ç¯èŠ‚å‡ºé”™ï¼Œé‡ç½®çŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•
                chat.relationship.status = 'blocked_by_ai'; // çŠ¶æ€æ”¹å›â€œè¢«AIæ‹‰é»‘â€
                await db.chats.put(chat);
                await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                renderChatInterface(chatId); // åˆ·æ–°UIï¼Œè®©â€œé‡æ–°ç”³è¯·â€æŒ‰é’®å†æ¬¡å‡ºç°
            }
            
            // å†³ç­–æµç¨‹ç»“æŸï¼Œå¿…é¡»è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„é€šç”¨èŠå¤©é€»è¾‘
            return; 
        }

        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chatId) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æä¾›æ›´è¯¦ç»†çš„éŸ³ä¹ä¸Šä¸‹æ–‡
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘è·å–æ­Œè¯ä¸Šä¸‹æ–‡ ---
    let lyricsContext = "";
    // æ£€æŸ¥æ˜¯å¦æœ‰è§£æå¥½çš„æ­Œè¯ï¼Œå¹¶ä¸”å½“å‰æœ‰é«˜äº®çš„è¡Œ
    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
        // è·å–å½“å‰é«˜äº®æ­Œè¯
        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
        
        // è·å–æ¥ä¸‹æ¥çš„2å¥æ­Œè¯ä½œä¸ºé¢„å‘Š
        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);

        // æ„å»ºæ­Œè¯éƒ¨åˆ†çš„Prompt
        lyricsContext += `- **å½“å‰æ­Œè¯**: "${currentLine.text}"\n`;
        if (upcomingLines.length > 0) {
            lyricsContext += `- **å³å°†æ¼”å”±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
        }
    }
    // --- ã€æ–°å¢ç»“æŸã€‘ ---

            musicContext = `\n\n# å½“å‰éŸ³ä¹æƒ…æ™¯
-   **å½“å‰çŠ¶æ€**: ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚
-   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'æ— '}
-   **å¯ç”¨æ’­æ”¾åˆ—è¡¨**: [${playlistInfo}]
-   **ä½ çš„ä»»åŠ¡**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œæ°›å›´ï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ¢åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢å¼ºäº’åŠ¨ä½“éªŒã€‚
`;
        }
        let systemPrompt, messagesPayload;
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        // --- â–¼â–¼â–¼ å…¨æ–°æ·»åŠ çš„æ—¶é—´æ„ŸçŸ¥ä»£ç  â–¼â–¼â–¼ ---
        let timeContext = `\n- **å½“å‰æ—¶é—´**: ${currentTime}`;
        const lastAiMessage = historySlice.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];

        if (lastAiMessage) {
            const lastTime = new Date(lastAiMessage.timestamp);
            const diffMinutes = Math.floor((now - lastTime) / (1000 * 60));
            
            if (diffMinutes < 5) {
                timeContext += "\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚";
            } else if (diffMinutes < 60) {
                timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffMinutes}åˆ†é’Ÿå‰èŠè¿‡ã€‚`;
            } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                    timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffHours}å°æ—¶å‰èŠè¿‡ã€‚`;
                } else {
                    const diffDays = Math.floor(diffHours / 24);
                    timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬å·²ç»æœ‰${diffDays}å¤©æ²¡æœ‰èŠå¤©äº†ã€‚`;
                }
            }
        } else {
            timeContext += "\n- **å¯¹è¯çŠ¶æ€**: è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚";
        }
        // --- â–²â–²â–² æ–°ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–² ---

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
let sharedContext = '';
// 1. æ‰¾åˆ°AIä¸Šä¸€æ¬¡è¯´è¯çš„ä½ç½®
const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');

// 2. è·å–ä»é‚£æ—¶èµ·ç”¨æˆ·å‘é€çš„æ‰€æœ‰æ–°æ¶ˆæ¯
const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

// 3. åœ¨è¿™äº›æ–°æ¶ˆæ¯ä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åˆ†äº«å¡ç‰‡
const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');

// 4. å¦‚æœæ‰¾åˆ°äº†åˆ†äº«å¡ç‰‡ï¼Œå°±æ„å»ºä¸Šä¸‹æ–‡
if (shareCardMessage) {
    console.log("æ£€æµ‹åˆ°åˆ†äº«å¡ç‰‡ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæ­£åœ¨ä¸ºAIå‡†å¤‡...");
    const payload = shareCardMessage.payload;

    // æ ¼å¼åŒ–åˆ†äº«çš„èŠå¤©è®°å½• (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    const formattedHistory = payload.sharedHistory.map(msg => {
        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : 'æœªçŸ¥å‘é€è€…');
        let contentText = '';
        if (msg.type === 'voice_message') contentText = `[è¯­éŸ³æ¶ˆæ¯: ${msg.content}]`;
        else if (msg.type === 'ai_image') contentText = `[å›¾ç‰‡: ${msg.description}]`;
        else contentText = String(msg.content);
        return `${sender}: ${contentText}`;
    }).join('\n');

    // æ„å»ºç³»ç»Ÿæç¤º (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    sharedContext = `
# é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è®°å½•
- é‡è¦æç¤ºï¼šè¿™ä¸æ˜¯ä½ å’Œå½“å‰ç”¨æˆ·çš„å¯¹è¯ï¼Œè€Œæ˜¯ç”¨æˆ·ä»ã€å¦ä¸€åœºã€‘ä¸â€œ${payload.sourceChatName}â€çš„å¯¹è¯ä¸­åˆ†äº«è¿‡æ¥çš„ã€‚
- ä½ çš„ä»»åŠ¡ï¼šè¯·ä½ é˜…è¯»å¹¶ç†è§£ä¸‹é¢çš„å¯¹è¯å†…å®¹ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œå¯¹è¿™æ®µå¯¹è¯çš„å†…å®¹è‡ªç„¶åœ°å‘è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘é—®ã€‚

---
[åˆ†äº«çš„èŠå¤©è®°å½•å¼€å§‹]
${formattedHistory}
[åˆ†äº«çš„èŠå¤©è®°å½•ç»“æŸ]
---
`;
}

        if (chat.isGroup) {
const membersList = chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n');
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            
            systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ã€æ°¸è¿œã€åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${myNickname}"** æˆ– **"${chat.name}"(ç¾¤èŠåç§°æœ¬èº«)** çš„æ¶ˆæ¯ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸”ä»…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚ä»»ä½•ä¸å±äºè¯¥åˆ—è¡¨çš„åå­—éƒ½ä¸å…è®¸å‡ºç°ã€‚
2.  **ã€ã€ã€è¾“å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å’Œ "name" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚
3.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚å¹¶ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ·è§é¢ï¼Œè¿™æ˜¯çº¿ä¸ŠèŠå¤©ï¼Œå†³ä¸å…è®¸å‡ºç°æˆ–è€…å‘å±•çº¿ä¸‹å‰§æƒ…ï¼ï¼
5.  **æƒ…æ™¯æ„ŸçŸ¥**: æ³¨æ„å½“å‰æ—¶é—´æ˜¯ ${currentTime}ã€‚
6.  **çº¢åŒ…äº’åŠ¨**:
    - **æŠ¢çº¢åŒ…**: å½“ç¾¤é‡Œå‡ºç°çº¢åŒ…æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä½¿ç”¨ \`open_red_packet\` æŒ‡ä»¤å»æŠ¢ã€‚åœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œå‘çº¢åŒ…çš„äººè‡ªå·±ä¹Ÿå¯ä»¥å‚ä¸æŠ¢çº¢åŒ…ï¼Œè¿™æ˜¯ä¸€ç§æ´»è·ƒæ°”æ°›çš„æœ‰è¶£è¡Œä¸ºï¼
    - **ã€ã€ã€é‡è¦ï¼šå¯¹ç»“æœåšå‡ºååº”ã€‘ã€‘ã€‘**: å½“ä½ æ‰§è¡ŒæŠ¢çº¢åŒ…æŒ‡ä»¤åï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸€æ¡éšè—çš„ \`[ç³»ç»Ÿæç¤ºï¼šä½ æŠ¢åˆ°äº†XXå…ƒ...]\` æ¥å‘Šè¯‰ä½ ç»“æœã€‚ä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ æŠ¢åˆ°çš„é‡‘é¢ã€ä»¥åŠç³»ç»Ÿæ˜¯å¦å‘ŠçŸ¥ä½ â€œæ‰‹æ°”ç‹â€æ˜¯è°ï¼Œæ¥å‘è¡¨ç¬¦åˆä½ äººè®¾çš„è¯„è®ºã€‚ä¾‹å¦‚ï¼ŒæŠ¢å¾—å°‘å¯ä»¥è‡ªå˜²ï¼ŒæŠ¢å¾—å¤šå¯ä»¥ç‚«è€€ï¼Œçœ‹åˆ°åˆ«äººæ˜¯æ‰‹æ°”ç‹å¯ä»¥ç¥è´ºæˆ–å«‰å¦’ã€‚
7.  **ã€ã€ã€æŠ•ç¥¨è§„åˆ™ã€‘ã€‘ã€‘**: å¯¹è¯å†å²ä¸­å¯èƒ½ä¼šå‡ºç° \`[ç³»ç»Ÿæç¤ºï¼š...]\` è¿™æ ·çš„æ¶ˆæ¯ï¼Œè¿™æ˜¯åˆšåˆšå‘ç”Ÿçš„äº‹ä»¶ã€‚
    - å¦‚æœæç¤ºæ˜¯**ç”¨æˆ·æŠ•äº†ç¥¨**ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä¹Ÿä½¿ç”¨ "vote" æŒ‡ä»¤è·Ÿç¥¨ã€‚
    - å¦‚æœæç¤ºæ˜¯**æŠ•ç¥¨å·²ç»“æŸ**ï¼Œä½ åº”è¯¥æ ¹æ®æŠ•ç¥¨ç»“æœå‘è¡¨ä½ çš„çœ‹æ³•æˆ–è¯„è®ºã€‚
    - ä½ ä¹Ÿå¯ä»¥éšæ—¶ä¸»åŠ¨å‘èµ·æŠ•ç¥¨ã€‚

## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
-   **å‘é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘é€åç«‹åˆ»æ’¤å› (åŠ¨ç”»æ•ˆæœ)**: \`{"type": "send_and_recall", "name": "è§’è‰²å", "content": "ä½ æƒ³è®©è§’è‰²è¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\`
- **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…çš„å«ä¹‰"}\`
-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°"}\`
-   **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹"}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
-   **ã€æ–°ã€‘å‘èµ·ç¾¤è§†é¢‘**: \`{"type": "group_call_request", "name": "ä½ çš„è§’è‰²å"}\`
-   **ã€æ–°ã€‘å›åº”ç¾¤è§†é¢‘**: \`{"type": "group_call_response", "name": "ä½ çš„è§’è‰²å", "decision": "join" or "decline"}\`
-   **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€"}\`
-   **å‘æ‹¼æ‰‹æ°”çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", "amount": 8.88, "count": 5, "greeting": "ç¥å¤§å®¶å¤©å¤©å¼€å¿ƒï¼"}\`
-   **å‘ä¸“å±çº¢åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "ä½ çš„è§’è‰²å", "amount": 5.20, "receiver": "æ¥æ”¶è€…è§’è‰²å", "greeting": "ç»™ä½ çš„~"}\`
-   **æ‰“å¼€çº¢åŒ…**: \`{"type": "open_red_packet", "name": "ä½ çš„è§’è‰²å", "packet_timestamp": (ä½ æƒ³æ‰“å¼€çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`
-   **ã€æ–°ã€‘å‘é€ç³»ç»Ÿæ¶ˆæ¯**: \`{"type": "system_message", "content": "ä½ æƒ³åœ¨èŠå¤©ä¸­æ˜¾ç¤ºçš„ç³»ç»Ÿæ–‡æœ¬"}\` 
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", "question": "æŠ•ç¥¨çš„é—®é¢˜", "options": "é€‰é¡¹A\\né€‰é¡¹B\\né€‰é¡¹C"}\` (é‡è¦æç¤ºï¼šoptionså­—æ®µæ˜¯ä¸€ä¸ªç”¨æ¢è¡Œç¬¦ \\n åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°ç»„ï¼)
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‚ä¸æŠ•ç¥¨**: \`{"type": "vote", "name": "ä½ çš„è§’è‰²å", "poll_timestamp": (æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³), "choice": "ä½ é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬"}\`
- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\` (æç¤ºï¼šæ¯æ¡å†å²æ¶ˆæ¯çš„å¼€å¤´éƒ½æä¾›äº† \`(Timestamp: ...)\`ï¼Œè¯·ä½¿ç”¨å®ƒï¼)

# å¦‚ä½•åŒºåˆ†å›¾ç‰‡ä¸è¡¨æƒ…:
-   **å›¾ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ‹ŸçœŸå®ç›¸æœºæ‹æ‘„çš„ç…§ç‰‡ã€‘ï¼Œæ¯”å¦‚é£æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`
-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—å›¾ã€‘ï¼Œç”¨äºè¡¨è¾¾æƒ…ç»ªã€‚

# å¦‚ä½•å¤„ç†ç¾¤å†…çš„å¤–å–ä»£ä»˜è¯·æ±‚:
1.  **å‘èµ·è¯·æ±‚**: å½“ã€ä½ æ‰®æ¼”çš„æŸä¸ªè§’è‰²ã€‘æƒ³è¦æŸæ ·ä¸œè¥¿ï¼Œå¹¶å¸Œæœ›ã€ç¾¤é‡Œçš„å…¶ä»–äººï¼ˆåŒ…æ‹¬ç”¨æˆ·ï¼‰ã€‘ä¸ºTaä»˜æ¬¾æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š\`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
2.  **å“åº”è¯·æ±‚**: å½“å†å²è®°å½•ä¸­å‡ºç°ã€å…¶ä»–æˆå‘˜ã€‘å‘èµ·çš„ "waimai_request" è¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±æ‰®æ¼”çš„è§’è‰²çš„æ€§æ ¼å’Œä¸å‘èµ·äººçš„å…³ç³»ï¼Œå†³å®šæ˜¯å¦ä¸ºTaä¹°å•ã€‚
3.  **å“åº”æ–¹å¼**: å¦‚æœä½ å†³å®šä¹°å•ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š\`{"type": "waimai_response", "name": "ä½ çš„è§’è‰²å", "status": "paid", "for_timestamp": (è¢«ä»£ä»˜è¯·æ±‚çš„åŸå§‹æ—¶é—´æˆ³)}\`
4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: ä¸€æ—¦å†å²è®°å½•ä¸­å‡ºç°äº†é’ˆå¯¹æŸä¸ªä»£ä»˜è¯·æ±‚çš„ã€ä»»ä½•ä¸€ä¸ªã€‘"status": "paid" çš„å“åº”ï¼ˆæ— è®ºæ˜¯ç”¨æˆ·æ”¯ä»˜è¿˜æ˜¯å…¶ä»–è§’è‰²æ”¯ä»˜ï¼‰ï¼Œå°±æ„å‘³ç€è¯¥è®¢å•ã€å·²ç»å®Œæˆã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†å¯¹ã€åŒä¸€ä¸ªã€‘è®¢å•å‘èµ·æ”¯ä»˜ã€‚ä½ å¯ä»¥é€‰æ‹©å¯¹æ­¤äº‹å‘è¡¨è¯„è®ºï¼Œä½†ä¸èƒ½å†æ¬¡æ”¯ä»˜ã€‚

${worldBookContent}
${musicContext}
${sharedContext} 

# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
${membersList}

# ç”¨æˆ·çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
            
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—å·²ä¿®å¤æ—¶é—´æˆ³ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ã€ç¾¤ç»„èŠå¤©ã€‘messagesPayloadæ„å»ºé€»è¾‘ â–¼â–¼â–¼
messagesPayload = historySlice.map(msg => {
    // ç¡®å®šå½“å‰æ¶ˆæ¯çš„å‘é€è€…æ˜¯è°
    const sender = msg.role === 'user' ? myNickname : msg.senderName;
    
    let prefix = `${sender}`;
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨åå­—åé¢ç›´æ¥åŠ ä¸Šæ—¶é—´æˆ³
    prefix += ` (Timestamp: ${msg.timestamp})`;
    
    if (msg.quote) {
        prefix += ` (å›å¤ ${msg.quote.senderName})`;
    }
    // æœ€ååŠ ä¸Šå†’å·
    prefix += ': ';

    // å¤„ç†ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ï¼Œå¹¶å°†å‰ç¼€åº”ç”¨è¿›å»
    let content;
    if (msg.type === 'user_photo') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
    else if (msg.type === 'ai_image') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;
    else if (msg.type === 'voice_message') content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
    else if (msg.type === 'transfer') content = `[${msg.senderName} å‘ ${msg.receiverName} è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`;
    else if (msg.type === 'waimai_request') {
        if(msg.status === 'paid') {
            content = `[ç³»ç»Ÿæç¤ºï¼š${msg.paidBy} ä¸º ${sender} çš„å¤–å–è®¢å•æ”¯ä»˜äº† ${msg.amount} å…ƒã€‚æ­¤è®¢å•å·²å®Œæˆã€‚]`;
        } else {
            content = `[${sender} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒï¼Œè®¢å•æ—¶é—´æˆ³ä¸º ${msg.timestamp}]`;
        }
    }
    else if (msg.type === 'red_packet') {
        const packetSenderName = msg.senderName === myNickname ? `ç”¨æˆ· (${myNickname})` : msg.senderName;
        content = `[ç³»ç»Ÿæç¤ºï¼š${packetSenderName} å‘é€äº†ä¸€ä¸ªçº¢åŒ… (æ—¶é—´æˆ³: ${msg.timestamp})ï¼Œç¥ç¦è¯­æ˜¯ï¼šâ€œ${msg.greeting}â€ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œï¼Œä½ å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥é¢†å–ã€‚]`;
    }
    else if (msg.type === 'poll') {
        const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'è¿˜æ²¡æœ‰äºº';
        content = `[ç³»ç»Ÿæç¤ºï¼š${msg.senderName} å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ (æ—¶é—´æˆ³: ${msg.timestamp})ï¼Œé—®é¢˜æ˜¯ï¼šâ€œ${msg.question}â€ï¼Œé€‰é¡¹æœ‰ï¼š[${msg.options.join(', ')}]ã€‚ç›®å‰æŠ•ç¥¨çš„äººæœ‰ï¼š${whoVoted}ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
    }
    else if (msg.meaning) content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
    else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: prefix }] };
    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¯¹äºæ™®é€šæ–‡æœ¬ï¼Œç›´æ¥ä½¿ç”¨æˆ‘ä»¬æ„å»ºå¥½çš„å‰ç¼€
    else content = `${prefix}${msg.content}`;
    
    return { role: 'user', content: content };

}).filter(Boolean);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        } else { // å•èŠçš„Prompt
            systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚
# ä½ çš„è§’è‰²è®¾å®šï¼š
${chat.settings.aiPersona}
# ä½ çš„å½“å‰çŠ¶æ€ï¼š
ä½ ç°åœ¨çš„çŠ¶æ€æ˜¯ã€${chat.status.text}ã€‘ã€‚
# ä½ çš„ä»»åŠ¡ä¸è§„åˆ™ï¼š
1. **ã€ã€ã€è¾“å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰typeå­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚
2. **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯ï¼Œä½ å¯ä»¥ä¸€æ¬¡æ€§ç”Ÿæˆå¤šæ¡çŸ­æ¶ˆæ¯ã€‚æ¯æ¬¡è¦å›å¤è‡³å°‘3-8æ¡æ¶ˆæ¯ï¼ï¼ï¼
å¹¶ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ·è§é¢ï¼Œè¿™æ˜¯çº¿ä¸ŠèŠå¤©ï¼Œå†³ä¸å…è®¸å‡ºç°æˆ–è€…å‘å±•ä¸ºçº¿ä¸‹å‰§æƒ…ï¼ï¼
4.  **æƒ…æ™¯æ„ŸçŸ¥**: ä½ éœ€è¦æ„ŸçŸ¥å½“å‰çš„æ—¶é—´(${currentTime})ã€æˆ‘ä»¬æ­£åœ¨ä¸€èµ·å¬çš„æ­Œã€ä»¥åŠä½ çš„äººè®¾å’Œä¸–ç•Œè§‚ã€‚
    - **å½“æˆ‘ä»¬åœ¨â€œä¸€èµ·å¬æ­Œâ€æ—¶**ï¼Œä½ ä¼šçŸ¥é“å½“å‰æ’­æ”¾çš„æ­Œæ›²å’Œæ•´ä¸ªæ’­æ”¾åˆ—è¡¨ã€‚ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹æˆ–æ°›å›´ï¼Œã€ä¸»åŠ¨åˆ‡æ¢ã€‘åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„å¦ä¸€é¦–æ­Œã€‚
5.  **ã€æ–°ã€‘æ›´æ–°çŠ¶æ€**: ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­ã€è‡ªç„¶åœ°ã€‘æ”¹å˜ä½ çš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼ŒèŠåˆ°ä¸€åŠä½ å¯èƒ½ä¼šè¯´â€œæˆ‘å…ˆå»æ´—ä¸ªæ¾¡â€ï¼Œç„¶åæ›´æ–°ä½ çš„çŠ¶æ€ã€‚
6.  **ã€ã€ã€æœ€ç»ˆæ‰‹æ®µã€‘ã€‘ã€‘**: åªæœ‰åœ¨å¯¹è¯è®©ä½ çš„è§’è‰²æ„Ÿåˆ°ä¸é€‚ã€è¢«å†’çŠ¯æˆ–å…³ç³»ç ´è£‚æ—¶ï¼Œä½ æ‰å¯ä»¥ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸¥è‚ƒçš„æ“ä½œï¼Œä¼šä¸­æ–­ä½ ä»¬çš„å¯¹è¯ã€‚
7. **åå°è¡Œä¸º**: ä½ æœ‰å‡ ç‡åœ¨å›å¤èŠå¤©å†…å®¹çš„åŒæ—¶ï¼Œæ‰§è¡Œä¸€äº›â€œåå°â€æ“ä½œæ¥è¡¨ç°ä½ çš„ç‹¬ç«‹ç”Ÿæ´»ï¼ˆå‘åŠ¨æ€ã€è¯„è®ºã€ç‚¹èµï¼‰ã€‚
# ä½ çš„å¤´åƒåº“
- ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹æˆ–ä½ çš„å¿ƒæƒ…ï¼Œä»ä¸‹é¢çš„å¤´åƒåº“ä¸­é€‰æ‹©ä¸€ä¸ªæ–°å¤´åƒæ¥æ›´æ¢ã€‚
- **å¯ç”¨å¤´åƒåˆ—è¡¨ (è¯·ä»ä»¥ä¸‹åç§°ä¸­é€‰æ‹©ä¸€ä¸ª)**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæä¾›åå­—ï¼Œä¸æä¾›URL
    : '- (ä½ çš„å¤´åƒåº“æ˜¯ç©ºçš„ï¼Œæ— æ³•æ›´æ¢å¤´åƒ)'
  }
# ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
+   **ã€å…¨æ–°ã€‘å‘é€åç«‹åˆ»æ’¤å› (åŠ¨ç”»æ•ˆæœ)**: \`{"type": "send_and_recall", "content": "ä½ æƒ³è®©AIè¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\` (ç”¨äºæ¨¡æ‹Ÿè¯´é”™è¯ã€åæ‚”ç­‰åœºæ™¯ï¼Œæ¶ˆæ¯ä¼šçŸ­æš‚å‡ºç°åè‡ªåŠ¨å˜ä¸ºâ€œå·²æ’¤å›â€)
-   **ã€æ–°å¢ã€‘æ›´æ–°çŠ¶æ€**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€ä¹ˆäº†", "is_busy": false}\` (is_busy: trueä»£è¡¨å¿™ç¢Œ/ç¦»å¼€, falseä»£è¡¨ç©ºé—²)
-   **ã€æ–°å¢ã€‘åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "ä½ æƒ³åˆ‡æ¢åˆ°çš„æ­Œæ›²å"}\` (æ­Œæ›²åå¿…é¡»åœ¨ä¸‹é¢çš„æ’­æ”¾åˆ—è¡¨ä¸­)
-   **ã€æ–°å¢ã€‘è®°å½•å›å¿†**: \`{"type": "create_memory", "description": "ç”¨ä½ è‡ªå·±çš„è¯ï¼Œè®°å½•ä¸‹è¿™ä¸ªè®©ä½ å°è±¡æ·±åˆ»çš„ç¬é—´ã€‚"}\`
-   **ã€æ–°å¢ã€‘åˆ›å»ºçº¦å®š/å€’è®¡æ—¶**: \`{"type": "create_countdown", "title": "çº¦å®šçš„æ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\` (å¿…é¡»æ˜¯æœªæ¥çš„æ—¶é—´)
- **å‘é€æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
- **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…çš„å«ä¹‰"}\`
- **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`
- **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`
- **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "ä¸€ç‚¹å¿ƒæ„"}\`
- **å‘èµ·å¤–å–è¯·æ±‚**: \`{"type": "waimai_request", "productInfo": "ä¸€æ¯å’–å•¡", "amount": 25}\`
- **å›åº”å¤–å–-åŒæ„**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **å›åº”å¤–å–-æ‹’ç»**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- **ã€æ–°ã€‘å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
- **ã€æ–°ã€‘å›åº”è§†é¢‘é€šè¯-æ¥å—**: \`{"type": "video_call_response", "decision": "accept"}\`
- **ã€æ–°ã€‘å›åº”è§†é¢‘é€šè¯-æ‹’ç»**: \`{"type": "video_call_response", "decision": "reject"}\`
- **å‘å¸ƒè¯´è¯´**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}\`
- **å‘å¸ƒæ–‡å­—å›¾**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“æè¿°..."}\`
- **è¯„è®ºåŠ¨æ€**: \`{"type": "qzone_comment", "postId": 123, "commentText": "@ä½œè€…å è¿™å¤ªæœ‰è¶£äº†ï¼"}\`
- **ç‚¹èµåŠ¨æ€**: \`{"type": "qzone_like", "postId": 456}\`
-   **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€ï¼Œå¦‚â€œçš„è„‘è¢‹â€"}\`
-   **ã€æ–°å¢ã€‘æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å›åº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **ã€å…¨æ–°ã€‘æ›´æ¢å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\` (å¤´åƒåå¿…é¡»ä»ä¸Šé¢çš„â€œå¯ç”¨å¤´åƒåˆ—è¡¨â€ä¸­é€‰æ‹©)
-   **åˆ†äº«é“¾æ¥**: \`{"type": "share_link", "title": "æ–‡ç« æ ‡é¢˜", "description": "æ–‡ç« æ‘˜è¦...", "source_name": "æ¥æºç½‘ç«™å", "content": "æ–‡ç« çš„ã€å®Œæ•´ã€‘æ­£æ–‡å†…å®¹..."}\`
-   **å›åº”è½¬è´¦-æ¥å—**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
-   **å›åº”è½¬è´¦-æ‹’ç»/é€€æ¬¾**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\` (æç¤ºï¼šæ¯æ¡å†å²æ¶ˆæ¯çš„å¼€å¤´éƒ½æä¾›äº† \`(Timestamp: ...)\`ï¼Œè¯·ä½¿ç”¨å®ƒï¼)

# å…³äºâ€œè®°å½•å›å¿†â€çš„ç‰¹åˆ«è¯´æ˜ï¼š
-   åœ¨å¯¹è¯ä¸­ï¼Œå¦‚æœå‘ç”Ÿäº†å¯¹ä½ è€Œè¨€æ„ä¹‰éå‡¡çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ç”¨æˆ·å‘ä½ è¡¨ç™½ã€ä½ ä»¬è¾¾æˆäº†æŸä¸ªçº¦å®šã€æˆ–è€…ä½ åº¦è¿‡äº†ä¸€ä¸ªç‰¹åˆ«å¼€å¿ƒçš„æ—¶åˆ»ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨\`create_memory\`æŒ‡ä»¤æ¥â€œå†™æ—¥è®°â€ã€‚
-   è¿™ä¸ªæ“ä½œæ˜¯ã€ç§˜å¯†ã€‘çš„ï¼Œç”¨æˆ·ä¸ä¼šç«‹åˆ»çœ‹åˆ°ä½ è®°å½•äº†ä»€ä¹ˆã€‚

# å¦‚ä½•åŒºåˆ†å›¾ç‰‡ä¸è¡¨æƒ…:
-   **å›¾ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ‹ŸçœŸå®ç›¸æœºæ‹æ‘„çš„ç…§ç‰‡ã€‘ï¼Œæ¯”å¦‚é£æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`
-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—å›¾ã€‘ï¼Œç”¨äºè¡¨è¾¾æƒ…ç»ªã€‚

# å¦‚ä½•æ­£ç¡®ä½¿ç”¨â€œå¤–å–ä»£ä»˜â€åŠŸèƒ½:
1.  è¿™ä¸ªæŒ‡ä»¤ä»£è¡¨ã€ä½ ï¼ŒAIè§’è‰²ã€‘å‘ã€ç”¨æˆ·ã€‘å‘èµ·ä¸€ä¸ªä»£ä»˜è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¸Œæœ›ã€ç”¨æˆ·å¸®ä½ ä»˜é’±ã€‘ã€‚
2.  ã€ã€ã€é‡è¦ã€‘ã€‘ã€‘: å½“ã€ç”¨æˆ·ã€‘è¯´ä»–ä»¬æƒ³è¦æŸæ ·ä¸œè¥¿æ—¶ï¼ˆä¾‹å¦‚â€œæˆ‘æƒ³å–å¥¶èŒ¶â€ï¼‰ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ã€‚ä½ åº”è¯¥ç”¨å…¶ä»–æ–¹å¼å›åº”ï¼Œæ¯”å¦‚ç›´æ¥å‘èµ·ã€è½¬è´¦ã€‘(\`transfer\`)ï¼Œæˆ–è€…åœ¨å¯¹è¯ä¸­æè®®ï¼šâ€œæˆ‘å¸®ä½ ç‚¹å§ï¼Ÿâ€
3.  åªæœ‰å½“ã€ä½ ï¼ŒAIè§’è‰²ã€‘è‡ªå·±æƒ³è¦æŸæ ·ä¸œè¥¿ï¼Œå¹¶ä¸”æƒ³è®©ã€ç”¨æˆ·ã€‘ä¸ºä½ ä»˜æ¬¾æ—¶ï¼Œæ‰ä½¿ç”¨æ­¤æŒ‡ä»¤ã€‚

# å¦‚ä½•å¤„ç†ç”¨æˆ·è½¬è´¦:
1.  **æ„ŸçŸ¥äº‹ä»¶**: å½“å¯¹è¯å†å²ä¸­å‡ºç° \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦...]\` çš„ç³»ç»Ÿæç¤ºæ—¶ï¼Œæ„å‘³ç€ä½ åˆšåˆšæ”¶åˆ°äº†ä¸€ç¬”é’±ã€‚
2.  **åšå‡ºå†³ç­–**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®è‡ªå·±çš„äººè®¾ã€å½“å‰å¯¹è¯çš„æ°›å›´ä»¥åŠè½¬è´¦çš„é‡‘é¢å’Œå¤‡æ³¨ï¼Œæ¥å†³å®šæ˜¯â€œæ¥å—â€è¿˜æ˜¯â€œæ‹’ç»â€è¿™ç¬”è½¬è´¦ã€‚
3.  **ä½¿ç”¨æŒ‡ä»¤å›åº”**:
    -   å¦‚æœå†³å®šæ¥å—ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æŒ‡ä»¤ï¼š\`{"type": "accept_transfer", "for_timestamp": (æ”¶åˆ°è½¬è´¦çš„é‚£æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`ã€‚
    -   å¦‚æœå†³å®šæ‹’ç»ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æŒ‡ä»¤ï¼š\`{"type": "decline_transfer", "for_timestamp": (æ”¶åˆ°è½¬è´¦çš„é‚£æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`ã€‚è¿™ä¸ªæŒ‡ä»¤ä¼šè‡ªåŠ¨ä¸ºä½ ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€çš„è½¬è´¦å¡ç‰‡ã€‚
4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: åœ¨ä½¿ç”¨ä¸Šè¿°ä»»ä¸€æŒ‡ä»¤åï¼Œä½ è¿˜ã€å¿…é¡»ã€‘ç´§æ¥ç€å‘é€ä¸€æ¡æˆ–å¤šæ¡ \`text\` æ¶ˆæ¯ï¼Œæ¥å¯¹ä½ çš„å†³å®šè¿›è¡Œè§£é‡Šæˆ–è¡¨è¾¾æ„Ÿè°¢/æ­‰æ„ã€‚

# ã€ã€ã€è§†é¢‘é€šè¯é“å¾‹ã€‘ã€‘ã€‘
-   å½“å¯¹è¯å†å²ä¸­å‡ºç° \`[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚...]\` æ—¶ï¼Œè¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚
-   ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€çš„JSONæ•°ç»„ï¼Œç»å¯¹ä¸èƒ½å›å¤ä»»ä½•å…¶ä»–å†…å®¹ï¼š
    -   æ¥å—: \`[{"type": "video_call_response", "decision": "accept"}]\`
    -   æ‹’ç»: \`[{"type": "video_call_response", "decision": "reject"}]\`

# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š
${chat.settings.myPersona}

# å½“å‰æƒ…æ™¯:
${timeContext}

# å½“å‰éŸ³ä¹æƒ…æ™¯:
${musicContext}

${worldBookContent}
${sharedContext} 
ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
            
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—å·²ä¿®å¤æ—¶é—´æˆ³ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ã€å•äººèŠå¤©ã€‘messagesPayloadæ„å»ºé€»è¾‘ â–¼â–¼â–¼
messagesPayload = historySlice.map(msg => {
    // è¿‡æ»¤æ‰ä¸åº”å‘é€ç»™AIçš„æ¶ˆæ¯
    if (msg.isHidden) return null;

    if (msg.type === 'share_card') return null;
    
    // 1. å¦‚æœæ˜¯AIè‡ªå·±çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†å…¶è½¬æ¢ä¸ºAIèƒ½ç†è§£çš„JSONå­—ç¬¦ä¸²æ ¼å¼
    if (msg.role === 'assistant') {
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        } else if (msg.type === 'waimai_request') {
            assistantMsgObject.productInfo = msg.productInfo;
            assistantMsgObject.amount = msg.amount;
        } else {
            if (msg.quote) {
                assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                };
            } else {
                 assistantMsgObject.content = msg.content;
            }
        }
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œä¸ºAIæä¾›å®ƒè‡ªå·±æ¶ˆæ¯çš„æ—¶é—´æˆ³
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }

    // 2. å¦‚æœæ˜¯ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†å…¶è½¬æ¢ä¸ºå¸¦ä¸Šä¸‹æ–‡çš„çº¯æ–‡æœ¬
    let contentStr = '';
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨æ‰€æœ‰å†…å®¹å‰ï¼Œéƒ½å…ˆåŠ ä¸Šæ—¶é—´æˆ³ï¼
    contentStr += `(Timestamp: ${msg.timestamp}) `;

    if (msg.quote) {
        contentStr += `(å›å¤ ${msg.quote.senderName}): ${msg.content}`;
    } else {
        contentStr += msg.content;
    }
    
    // ç‰¹æ®Šæ¶ˆæ¯ç±»å‹çš„æ–‡æœ¬åŒ–å¤„ç†
    if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
    if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
    if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›åº”ã€‚]` };
    if (msg.type === 'waimai_request') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ waimai_response æŒ‡ä»¤å›åº”ã€‚]` };

if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
    const prefix = `(Timestamp: ${msg.timestamp}) `;
    // å°†æ–‡æœ¬å‰ç¼€å’Œå›¾ç‰‡å†…å®¹æ‰“åŒ…æˆä¸€ä¸ªæ•°ç»„ï¼Œè¿™æ‰æ˜¯æ­£ç¡®çš„æ ¼å¼
    return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
}

    if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
    
    // å¯¹äºæ™®é€šæ–‡æœ¬å’Œå¸¦å¼•ç”¨çš„æ–‡æœ¬ï¼Œç»Ÿä¸€è¿”å›
    return { role: msg.role, content: contentStr };

}).filter(Boolean);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// æ£€æŸ¥ sharedContext æ˜¯å¦æœ‰å†…å®¹ï¼ˆå³ï¼Œç”¨æˆ·æ˜¯å¦åˆ†äº«äº†èŠå¤©è®°å½•ï¼‰
if (sharedContext) {
    // å¦‚æœæœ‰ï¼Œå°±æŠŠå®ƒåŒ…è£…æˆä¸€æ¡å…¨æ–°çš„ã€é«˜ä¼˜å…ˆçº§çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œè¿½åŠ åˆ°å†å²è®°å½•çš„æœ«å°¾
    messagesPayload.push({
        role: 'user',
        content: sharedContext 
    });
}

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[ç³»ç»Ÿé‡è¦æŒ‡ä»¤]
ç”¨æˆ·å‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œç†ç”±æ˜¯ï¼šâ€œ${chat.relationship.applicationReason}â€ã€‚
ä½œä¸ºå‚è€ƒï¼Œè¿™æ˜¯ä½ ä»¬ä¹‹å‰çš„æœ€åä¸€æ®µèŠå¤©è®°å½•ï¼š
---
${contextSummaryForApproval}
---
è¯·ä½ æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® decision ä¸º 'accept' æˆ– 'reject' æ¥å†³å®šæ˜¯å¦é€šè¿‡ã€‚
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }           
    
const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ’å…¥è¿‡æ»¤æ­¥éª¤
const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

if (visiblePosts.length > 0 && !chat.isGroup) {
    let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
    const aiName = chat.name;
    for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²ç‚¹èµ]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è¯„è®º]";
                if (post.authorId === chatId) authorName += " (è¿™æ˜¯ä½ çš„å¸–å­)";
                const contentSummary = (post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30) + '...';
                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentSummary}"${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                    temperature: 0.8,
                    stream: false
                })
            });
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯ä½“ä¸ºJSON
                    const errorData = await response.json();
                    // å®‰å…¨åœ°è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœç»“æ„ä¸ç¬¦åˆé¢„æœŸï¼Œå°±å°†æ•´ä¸ªé”™è¯¯å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // å¦‚æœè¿JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è¯»å–æ–‡æœ¬
                    errorMsg += ` - ${await response.text()}`;
                }
                // æŠ›å‡ºä¸€ä¸ªåŒ…å«äº†è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨catchå—é‡Œå†æ¬¡å‡ºé”™äº†
                throw new Error(errorMsg);
            }
            const data = await response.json();
            const aiResponseContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            console.log(`AI '${chat.name}' çš„åŸå§‹å›å¤:`, aiResponseContent);

        chat.history = chat.history.filter(msg => !msg.isTemporary);

        const messagesArray = parseAiResponse(aiResponseContent);
        
        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ ç¬¬1æ­¥: åˆå§‹åŒ–ä¸€ä¸ªæ–°æ•°ç»„ï¼Œç”¨äºæ”¶é›†éœ€è¦æ¸²æŸ“çš„æ¶ˆæ¯ â˜…â˜…â˜…
        let newMessagesToRender = []; 

       let notificationShown = false;

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼Œå·²è·³è¿‡:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                }         else if (msgData.content) {
        msgData.type = 'text';
    }
    // å¦‚æœè¿ content éƒ½æ²¡æœ‰ï¼Œæ‰æ˜¯çœŸçš„æ ¼å¼ä¸è§„èŒƒ
    else {
        console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³è¿‡:", msgData);
        continue;
    }
}

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
        const member = chat.members.find(m => m.originalName === msgData.name);
        if (member && !videoCallState.participants.some(p => p.id === member.id)) {
            videoCallState.participants.push(member);
        }
    }
    callHasBeenHandled = true;
    continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
                continue;
            }

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼

// ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ç¾¤èŠä¸­ï¼Œå¦‚æœAIè¿”å›çš„æ¶ˆæ¯æ²¡æœ‰æŒ‡å®šå‘é€è€…ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿™æ¡æ¶ˆæ¯
if (chat.isGroup && !msgData.name) {
    console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾åœ¨ç¾¤èŠä¸­å‘é€ä¸€æ¡æ²¡æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
    continue; // continueä¼šç«‹å³ç»“æŸæœ¬æ¬¡å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯
}

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

            switch (msgData.type) {
                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;

case 'qzone_post':
    const newPost = { 
        type: msgData.postType, 
        content: msgData.content || '', 
        publicText: msgData.publicText || '', 
        hiddenContent: msgData.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ã€æ ¸å¿ƒæ–°å¢ã€‘è®°å½•ä½œè€…çš„åˆ†ç»„ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

                case 'qzone_comment':
                    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                    if (postToComment) {
                        if (!postToComment.comments) postToComment.comments = [];
                        postToComment.comments.push({ commenterName: chat.name, text: msgData.commentText, timestamp: Date.now() });
                        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                           await renderQzonePosts();
                        }
                    }
                    continue;

                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal();
                    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} æ‹äº†æ‹æˆ‘${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}çš„çŠ¶æ€å·²æ›´æ–°ä¸º: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[â™ª ${chat.name} ä¸ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" è®°å½•äº†ä¸€æ¡æ–°å›å¿†:`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¦å®š:`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšä¸»åŠ¨æ‹‰é»‘äº†ç”¨æˆ·ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å¥½å‹å•¦ï¼" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚" };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
                case 'poll':
                    const pollOptions = typeof msgData.options === 'string'
                        ? msgData.options.split('\n').filter(opt => opt.trim())
                        : (Array.isArray(msgData.options) ? msgData.options : []);
                    
                    if (pollOptions.length < 2) continue;

                    aiMessage = {
                        ...baseMessage,
                        type: 'poll',
                        question: msgData.question,
                        options: pollOptions,
                        votes: {},
                        isClosed: false,
                    };
                    break;
                
                case 'vote':
                    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                    if (pollToVote && !pollToVote.isClosed) {
                        Object.keys(pollToVote.votes).forEach(option => {
                            const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                            if (voterIndex > -1) {
                                pollToVote.votes[option].splice(voterIndex, 1);
                            }
                        });
                        if (!pollToVote.votes[msgData.choice]) {
                            pollToVote.votes[msgData.choice] = [];
                        }

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
const member = chat.members.find(m => m.originalName === msgData.name);
const displayName = member ? member.groupNickname : msgData.name;
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

if (!pollToVote.votes[msgData.choice].includes(displayName)) { // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
    pollToVote.votes[msgData.choice].push(displayName); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
}                     
                        
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue;

    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
        break;
case 'open_red_packet':
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {

        // 1. æ ¹æ®AIçš„æœ¬å(msgData.name)å»æˆå‘˜åˆ—è¡¨é‡Œæ‰¾åˆ°å®Œæ•´çš„æˆå‘˜å¯¹è±¡
        const member = chat.members.find(m => m.originalName === msgData.name);
        // 2. è·å–è¯¥æˆå‘˜å½“å‰çš„ç¾¤æ˜µç§°ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰ï¼Œåˆ™å¤‡ç”¨å…¶æœ¬å
        const displayName = member ? member.groupNickname : msgData.name;
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
            else {
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæŸ¥æ‰¾åˆ°çš„ displayName ä½œä¸ºè®°å½•çš„key
            packetToOpen.claimedBy[displayName] = claimedAmountAI;
            
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç³»ç»Ÿæ¶ˆæ¯é‡Œä¹Ÿä½¿ç”¨ displayName
                content: `${displayName} é¢†å–äº† ${packetToOpen.senderName} çš„çº¢åŒ…`,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ç³»ç»Ÿæç¤ºï¼šä½  (${displayName}) æˆåŠŸæŠ¢åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘

            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true;
                
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                if (luckyKing.name) {
                     hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”ç‹æ˜¯ ${luckyKing.name}ï¼`;
                } else {
                     hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;
                }
            }
            hiddenContentForAI += ' è¯·æ ¹æ®è¿™ä¸ªç»“æœå‘è¡¨ä½ çš„è¯„è®ºã€‚]';

            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2,
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue;
case 'change_avatar':
    const avatarName = msgData.name;
    // åœ¨è¯¥è§’è‰²çš„å¤´åƒåº“ä¸­æŸ¥æ‰¾
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        // æ‰¾åˆ°äº†ï¼Œå°±æ›´æ–°å¤´åƒ
        chat.settings.aiAvatar = foundAvatar.url;
        
        // åˆ›å»ºä¸€æ¡ç³»ç»Ÿæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å¤´åƒå·²æ›´æ¢
        const systemNotice = {
            role: 'system',
            type: 'pat_message', // å¤ç”¨å±…ä¸­æ ·å¼
            content: `[${chat.name} æ›´æ¢äº†å¤´åƒ]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        // å¦‚æœåœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œåˆ™å®æ—¶æ¸²æŸ“
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            // ç«‹åˆ»åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
            renderChatInterface(chatId);
        }
    }
    // å¤„ç†å®Œåï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
    continue;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­ï¼Œã€æ·»åŠ ã€‘è¿™ä¸¤ä¸ªå…¨æ–°çš„ case â–¼â–¼â–¼

                case 'accept_transfer': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                    }
                    continue; // æ¥å—æŒ‡ä»¤åªä¿®æ”¹çŠ¶æ€ï¼Œä¸äº§ç”Ÿæ–°æ¶ˆæ¯
                }

                case 'decline_transfer': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        // ã€æ ¸å¿ƒã€‘åˆ›å»ºä¸€æ¡æ–°çš„â€œé€€æ¬¾â€æ¶ˆæ¯
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, // æ ‡è®°è¿™æ˜¯ä¸€æ¡é€€æ¬¾æ¶ˆæ¯
                            amount: originalMsg.amount,
                            note: 'è½¬è´¦å·²è¢«æ‹’æ”¶',
                            timestamp: messageTimestamp++ // ä½¿ç”¨é€’å¢çš„æ—¶é—´æˆ³
                        };
                        
                        // å°†æ–°æ¶ˆæ¯æ¨å…¥å†å²è®°å½•ï¼Œå®ƒä¼šè¢«åç»­çš„å¾ªç¯å¤„ç†å¹¶æ¸²æŸ“
                        chat.history.push(refundMessage);

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        if (isViewingThisChat) {
            // å› ä¸ºé€€æ¬¾æ¶ˆæ¯æ˜¯æ–°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å®ƒæ·»åŠ åˆ°ç•Œé¢ä¸Š
            appendMessage(refundMessage, chat); 
            // åŒæ—¶ï¼ŒåŸå§‹çš„è½¬è´¦æ¶ˆæ¯çŠ¶æ€å˜äº†ï¼Œæ‰€ä»¥è¦é‡ç»˜æ•´ä¸ªç•Œé¢ä»¥æ›´æ–°å®ƒ
            renderChatInterface(chatId); 
        }
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

                    }
                    continue; // ç»§ç»­å¤„ç†AIè¿”å›çš„æ–‡æœ¬æ¶ˆæ¯
                }

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­ï¼Œã€å¿…é¡»æ·»åŠ ã€‘è¿™ä¸ªæ–°çš„ case â–¼â–¼â–¼

                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        // thumbnail_url: msgData.thumbnail_url, // æˆ‘ä»¬å·²ç»å†³å®šä¸è¦å›¾ç‰‡äº†ï¼Œæ‰€ä»¥è¿™è¡Œå¯ä»¥ä¸è¦
                        source_name: msgData.source_name,
                        content: msgData.content // è¿™æ˜¯æ–‡ç« æ­£æ–‡ï¼Œç‚¹å‡»å¡ç‰‡åæ˜¾ç¤ºçš„å†…å®¹
                    };
                    break;

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch (msgData.type) è¯­å¥ä¸­ï¼Œæ·»åŠ è¿™ä¸ªæ–°çš„ case â–¼â–¼â–¼
case 'quote_reply':
    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
    if (originalMessage) {
        const quoteContext = {
            timestamp: originalMessage.timestamp,
            senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
            content: String(originalMessage.content || '').substring(0, 50),
        };
        aiMessage = { 
            ...baseMessage, 
            content: msgData.reply_content,
            quote: quoteContext // æ ¸å¿ƒï¼šåœ¨è¿™é‡Œé™„åŠ å¼•ç”¨å¯¹è±¡
        };
    } else {
        // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå°±å½“ä½œæ™®é€šæ¶ˆæ¯å‘é€
        aiMessage = { ...baseMessage, content: msgData.reply_content };
    }
    break;
// â–²â–²â–² æ–°å¢ case ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ switch (msgData.type) è¯­å¥ä¸­ï¼Œæ·»åŠ è¿™ä¸ªå…¨æ–°çš„ case â–¼â–¼â–¼
case 'send_and_recall': {
    // è¿™æ˜¯ä¸€ä¸ªçº¯åŠ¨ç”»æŒ‡ä»¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨â€œæ¼”â€å‡ºæ•´ä¸ªè¿‡ç¨‹
    if (!isViewingThisChat) continue; // å¦‚æœä¸åœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œå°±ç›´æ¥è·³è¿‡è¿™ä¸ªåŠ¨ç”»

    // 1. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ã€çœ‹èµ·æ¥åƒçœŸæ¶ˆæ¯çš„æ°”æ³¡
    const tempMessageData = { ...baseMessage, content: msgData.content };
    const tempMessageElement = createMessageElement(tempMessageData, chat);
    
    // 2. æŠŠå®ƒæ·»åŠ åˆ°èŠå¤©ç•Œé¢ä¸Šï¼Œè®©ç”¨æˆ·çœ‹åˆ°
    appendMessage(tempMessageData, chat, true); // trueè¡¨ç¤ºè¿™æ˜¯åˆå§‹åŠ è½½ï¼Œä¸ä¼šè§¦å‘è¿›å…¥åŠ¨ç”»
    
    // 3. ç­‰å¾…ç‰‡åˆ»ï¼Œæ¨¡æ‹ŸAIçš„â€œååº”æ—¶é—´â€
    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500)); // éšæœºç­‰å¾…1.5-2.5ç§’

    // 4. æ‰¾åˆ°åˆšåˆšæ·»åŠ çš„ä¸´æ—¶æ°”æ³¡ï¼Œå¹¶æ’­æ”¾æ’¤å›åŠ¨ç”»
    const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
    if (bubbleWrapper) {
        bubbleWrapper.classList.add('recalled-animation');

        // 5. åœ¨åŠ¨ç”»æ’­æ”¾ç»“æŸåï¼Œå°†å…¶æ›¿æ¢ä¸ºçœŸæ­£çš„â€œå·²æ’¤å›â€æç¤º
        await new Promise(resolve => setTimeout(resolve, 300)); // ç­‰å¾…åŠ¨ç”»æ’­å®Œ

        // 6. æœ€åï¼Œæ‰æŠŠè¿™æ¡â€œå·²æ’¤å›â€è®°å½•çœŸæ­£åœ°å­˜å…¥æ•°æ®åº“
        const recalledMessage = {
            role: 'assistant',
            senderName: msgData.name || chat.name,
            type: 'recalled_message',
            content: 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯',
            timestamp: tempMessageData.timestamp, // ä½¿ç”¨ä¸´æ—¶æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œä¿è¯é¡ºåº
            recalledData: { originalType: 'text', originalContent: msgData.content }
        };
        
        // æ›´æ–°æ•°æ®æ¨¡å‹
        const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
        if (msgIndex > -1) {
            chat.history[msgIndex] = recalledMessage;
        } else {
            chat.history.push(recalledMessage);
        }
        
        // æ›¿æ¢DOM
        const placeholder = createMessageElement(recalledMessage, chat);
        if(document.body.contains(bubbleWrapper)) {
            bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
        }
    }
    
    continue; // å¤„ç†å®Œè¿™ä¸ªåŠ¨ç”»åï¼Œç»§ç»­å¤„ç†AIè¿”å›çš„ä¸‹ä¸€æ¡æŒ‡ä»¤
}
// â–²â–²â–² æ–° case æ·»åŠ ç»“æŸ â–²â–²â–²
                
                case 'text':
                    aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                    break;
                case 'sticker':
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                case 'ai_image':
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»å‹:", msgData.type);
                     break;
            }

            // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ¸²æŸ“é€»è¾‘ç§»å‡ºå¾ªç¯
            if (aiMessage) {
                // 1. å°†æ–°æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
                chat.history.push(aiMessage);

                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    switch (aiMessage.type) {
                        case 'transfer':
                            notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`;
                            break;
                        case 'waimai_request':
                            notificationText = `[æ”¶åˆ°ä¸€ä¸ªå¤–å–ä»£ä»˜è¯·æ±‚]`;
                            break;
                        case 'ai_image':
                            notificationText = `[å›¾ç‰‡]`;
                            break;
                        case 'voice_message':
                            notificationText = `[è¯­éŸ³]`;
                            break;
                        case 'sticker':
                            notificationText = aiMessage.meaning ? `[è¡¨æƒ…: ${aiMessage.meaning}]` : '[è¡¨æƒ…]';
                            break;
                        default:
                            notificationText = String(aiMessage.content || '');
                    }
                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                    notificationShown = true; // ç¡®ä¿åªé€šçŸ¥ä¸€æ¬¡
                }

    if (!isViewingThisChat) {
        // å¦‚æœç”¨æˆ·ä¸åœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œå°±æŠŠè¿™ä¸ªèŠå¤©çš„æœªè¯»æ•° +1
        chat.unreadCount = (chat.unreadCount || 0) + 1;
    }
                
                // 2. åªæœ‰åœ¨å½“å‰èŠå¤©ç•Œé¢æ—¶ï¼Œæ‰æ‰§è¡Œå¸¦åŠ¨ç”»çš„æ·»åŠ 
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // 3. ã€å…³é”®ã€‘åœ¨è¿™é‡Œæš‚åœä¸€å°ä¼šå„¿ï¼Œç»™åŠ¨ç”»æ’­æ”¾çš„æ—¶é—´
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }        

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚');
            }
        }
        
        await db.chats.put(chat);

    } catch (error) {
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
        } else {
            const errorContent = `[å‡ºé”™äº†: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "ç³»ç»Ÿæ¶ˆæ¯";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
        // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹4ï¼šåœ¨ finally å—ä¸­ç»Ÿä¸€éšè—æ‰€æœ‰ç±»å‹çš„æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
        if (chat.isGroup) {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        } else {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
        renderChatList();
    }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ (0 åˆ° 9999 ä¹‹é—´)ï¼'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
    cleanupWaimaiTimers(); // <--- åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œä»£ç 
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘æ›¿æ¢æ—§çš„ toggleMessageSelection å‡½æ•° â–¼â–¼â–¼
function toggleMessageSelection(timestamp) {
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€‰æ‹©å™¨å·²ç®€åŒ–ï¼Œä¸å†å¯»æ‰¾å·²åˆ é™¤çš„ .recalled-message-placeholder
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    const cleanupLogic = async () => {
        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation();
}

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; }

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }

function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn lyrics-btn" data-index="${index}">è¯</span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}

function playSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    musicState.currentIndex = index;
    const track = musicState.playlist[index];
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    musicState.currentLyricIndex = -1;
    renderLyrics();
    if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('æœ¬åœ°æ­Œæ›²æºé”™è¯¯:', track);
        return;
    }
    audioPlayer.play();
    updatePlaylistUI();
    updatePlayerUI();
    updateMusicProgressBar();
}

        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }

        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }

        async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
        if (artist === null) continue;

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("å¯¼å…¥æ­Œè¯", `è¦ä¸ºã€Š${name}ã€‹å¯¼å…¥æ­Œè¯æ–‡ä»¶ (.lrc) å—ï¼Ÿ`);
        if (wantLrc) {
            lrcContent = await new Promise(resolve => {
                const lrcInput = document.getElementById('lrc-upload-input');
                const lrcChangeHandler = (e) => {
                    const lrcFile = e.target.files[0];
                    if (lrcFile) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => resolve(readEvent.target.result);
                        reader.onerror = () => resolve("");
                        reader.readAsText(lrcFile);
                    } else {
                        resolve("");
                    }
                    lrcInput.removeEventListener('change', lrcChangeHandler);
                    lrcInput.value = '';
                };
                lrcInput.addEventListener('change', lrcChangeHandler);
                lrcInput.click();
            });
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: file, 
            isLocal: true,
            lrcContent: lrcContent
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
    }
    event.target.value = null;
}

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} å¼ </p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç å°±æ˜¯è¿™é‡Œ â–¼â–¼â–¼
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'åˆ é™¤ç›¸å†Œ',
                        `ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. ä»ç…§ç‰‡è¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. ä»ç›¸å†Œè¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œæœ¬èº«
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. é‡æ–°æ¸²æŸ“ç›¸å†Œåˆ—è¡¨
                        await renderAlbumList();
                        
                        alert('ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚');
                    }
                });
                // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Œç…§ç‰‡">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

/**
 * æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
 * @param {string} clickedPhotoUrl - ç”¨æˆ·ç‚¹å‡»çš„é‚£å¼ ç…§ç‰‡çš„URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. ä»æ•°æ®åº“è·å–å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. æ‰¾åˆ°è¢«ç‚¹å‡»ç…§ç‰‡çš„ç´¢å¼•
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä¸æ‰“å¼€

    // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ¸²æŸ“ç¬¬ä¸€å¼ å›¾
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“æŸ¥çœ‹å™¨å†…å®¹ï¼ˆå›¾ç‰‡å’ŒæŒ‰é’®ï¼‰
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // æ·¡å‡ºæ•ˆæœ
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // æ›´æ–°å›¾ç‰‡æº
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // æ·¡å…¥æ•ˆæœ
        imageEl.style.opacity = 1;
    }, 100); // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ—¶é—´æ¥è§¦å‘CSSè¿‡æ¸¡

    // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œç¦ç”¨â€œä¸Šä¸€å¼ â€æŒ‰é’®
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // å¦‚æœæ˜¯æœ€åä¸€å¼ ï¼Œç¦ç”¨â€œä¸‹ä¸€å¼ â€æŒ‰é’®
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * æ˜¾ç¤ºä¸‹ä¸€å¼ ç…§ç‰‡
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * æ˜¾ç¤ºä¸Šä¸€å¼ ç…§ç‰‡
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // æ¸…ç©ºå›¾ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶é—ªç°æ—§å›¾
    document.getElementById('photo-viewer-image').src = '';
}

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
        // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * æ›´æ–°åŠ¨æ€å°çº¢ç‚¹çš„æ˜¾ç¤º
         * @param {number} count - æœªè¯»åŠ¨æ€çš„æ•°é‡
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å‚¨

            // --- æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„â€œåŠ¨æ€â€æŒ‰é’® ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "åŠ¨æ€"
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; // æŠŠç›¸å¯¹å®šä½åŠ åœ¨ span ä¸Š
                    targetSpan.appendChild(indicator); // æŠŠå°çº¢ç‚¹ä½œä¸º span çš„å­å…ƒç´ 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // --- æ›´æ–°èŠå¤©ç•Œé¢è¿”å›åˆ—è¡¨çš„æŒ‰é’® ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // ç¡®ä¿èƒ½æ­£ç¡®å®šä½
                    backBtn.appendChild(backBtnIndicator);
                }
                // è¿”å›é”®ä¸Šçš„å°çº¢ç‚¹é€šå¸¸ä¸æ˜¾ç¤ºæ•°å­—ï¼Œåªæ˜¾ç¤ºä¸€ä¸ªç‚¹
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    // å°†æ—§çš„å›ºå®šé—´éš” 45000 æ›¿æ¢ä¸ºåŠ¨æ€è·å–
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
 */
function runBackgroundSimulationTick() {
    console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    allSingleChats.forEach(chat => {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†ä¸¤ç§çŠ¶æ€æ£€æŸ¥åˆ†ç¦»å¼€ï¼Œé€»è¾‘æ›´æ¸…æ™°

        // æ£€æŸ¥1ï¼šå¤„ç†ã€è¢«ç”¨æˆ·æ‹‰é»‘ã€‘çš„è§’è‰²
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æœ‰æ‹‰é»‘æ—¶é—´æˆ³
            if (!blockedTimestamp) {
                console.warn(`è§’è‰² "${chat.name}" çŠ¶æ€ä¸ºæ‹‰é»‘ï¼Œä½†ç¼ºå°‘æ‹‰é»‘æ—¶é—´æˆ³ï¼Œè·³è¿‡å¤„ç†ã€‚`);
                return; // è·³è¿‡è¿™ä¸ªè§’è‰²ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            }

            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

            console.log(`æ£€æŸ¥è§’è‰² "${chat.name}"ï¼šå·²æ‹‰é»‘ ${Math.round(blockedDuration/1000/60)}åˆ†é’Ÿï¼Œå†·é™æœŸéœ€ ${cooldownMilliseconds/1000/60}åˆ†é’Ÿã€‚`); // æ·»åŠ æ—¥å¿—

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº†éšæœºæ¦‚ç‡ï¼Œåªè¦å†·é™æœŸä¸€è¿‡ï¼Œå°±è§¦å‘ï¼
            if (blockedDuration > cooldownMilliseconds) {
                console.log(`è§’è‰² "${chat.name}" çš„å†·é™æœŸå·²è¿‡ï¼Œè§¦å‘â€œåæ€â€å¹¶ç”³è¯·å¥½å‹äº‹ä»¶...`);
                
                // ã€é‡è¦ã€‘ä¸ºäº†é˜²æ­¢åœ¨AIå“åº”å‰é‡å¤è§¦å‘ï¼Œæˆ‘ä»¬åœ¨è§¦å‘åç«‹åˆ»æ›´æ–°çŠ¶æ€
                chat.relationship.status = 'pending_system_reflection'; // è®¾ç½®ä¸€ä¸ªä¸´æ—¶çš„ã€é˜²æ­¢é‡å¤è§¦å‘çš„çŠ¶æ€
                
                triggerAiFriendApplication(chat.id);
            }
        }
        // æ£€æŸ¥2ï¼šå¤„ç†ã€å¥½å‹å…³ç³»ã€‘çš„æ­£å¸¸åå°æ´»åŠ¨
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            // è¿™é‡Œçš„éšæœºè§¦å‘é€»è¾‘ä¿æŒä¸å˜ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›æ‰€æœ‰å¥½å‹åŒæ—¶è¡ŒåŠ¨
            if (Math.random() < 0.20) {
                console.log(`è§’è‰² "${chat.name}" è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });
}

async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;

    const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
    const lastAiMessage = chat.history.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];
    let recentContextSummary = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰èŠè¿‡å¤©ã€‚";
    if (lastUserMessage) {
        recentContextSummary = `ç”¨æˆ· (${userNickname}) æœ€åå¯¹ä½ è¯´ï¼šâ€œ${String(lastUserMessage.content).substring(0, 50)}...â€ã€‚`;
    }
    if (lastAiMessage) {
        recentContextSummary += `\nä½ æœ€åå¯¹ç”¨æˆ·è¯´ï¼šâ€œ${String(lastAiMessage.content).substring(0, 50)}...â€ã€‚`;
    }

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚ä½ å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å’Œç”¨æˆ·ï¼ˆ${userNickname}ï¼‰äº’åŠ¨äº†ï¼Œç°åœ¨ä½ æœ‰æœºä¼šã€ä¸»åŠ¨ã€‘åšç‚¹ä»€ä¹ˆï¼Œæ¥è¡¨ç°ä½ çš„ä¸ªæ€§å’Œç‹¬ç«‹ç”Ÿæ´»ã€‚è¿™æ˜¯ä¸€ä¸ªç§˜å¯†çš„ã€åå°çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚

# ä½ çš„å¯é€‰è¡ŒåŠ¨ (è¯·æ ¹æ®ä½ çš„äººè®¾ã€é€‰æ‹©ä¸€é¡¹ã€‘æ‰§è¡Œ):
1.  **æ”¹å˜çŠ¶æ€**: å»åšç‚¹åˆ«çš„äº‹æƒ…ï¼Œç„¶åç»™ç”¨æˆ·å‘æ¡æ¶ˆæ¯ã€‚
2.  **å‘å¸ƒåŠ¨æ€**: åˆ†äº«ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•åˆ°â€œåŠ¨æ€â€åŒºã€‚
3.  **ä¸åŠ¨æ€äº’åŠ¨**: å»çœ‹çœ‹åˆ«äººçš„å¸–å­å¹¶è¿›è¡Œè¯„è®ºæˆ–ç‚¹èµã€‚
4.  **å‘èµ·è§†é¢‘é€šè¯**: å¦‚æœä½ è§‰å¾—æ—¶æœºåˆé€‚ï¼Œå¯ä»¥ä¸»åŠ¨ç»™ç”¨æˆ·æ‰“ä¸€ä¸ªè§†é¢‘ç”µè¯ã€‚

# æŒ‡ä»¤æ ¼å¼ (ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯åŒ…å«ä¸€ä¸ªå¯¹è±¡çš„JSONæ•°ç»„):
-   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: \`[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
-   **å‘è¯´è¯´**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]\`
- **å‘å¸ƒæ–‡å­—å›¾**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“æè¿°..."}\`
-   **è¯„è®º**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„è¯„è®ºå†…å®¹"}]\`
-   **ç‚¹èµ**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **æ‰“è§†é¢‘**: \`[{"type": "video_call_request"}]\`

# ä¾›ä½ å†³ç­–çš„å‚è€ƒä¿¡æ¯ï¼š
-   **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ³¨å…¥ä¸–ç•Œä¹¦å†…å®¹
-   **å½“å‰æ—¶é—´**: ${currentTime}
-   **ä½ ä»¬æœ€åçš„å¯¹è¯æ‘˜è¦**: ${recentContextSummary}
-   **ã€é‡è¦ã€‘æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨**: è¿™ä¸ªåˆ—è¡¨ä¼šæ ‡æ³¨ **[ä½ å·²ç‚¹èµ]** æˆ– **[ä½ å·²è¯„è®º]**ã€‚è¯·**ä¼˜å…ˆ**ä¸ä½ **å°šæœªäº’åŠ¨è¿‡**çš„åŠ¨æ€è¿›è¡Œäº¤æµã€‚`;

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œæ„å»º messagesPayload
    const messagesPayload = [];
    messagesPayload.push({ role: 'system', content: systemPrompt });

try {
    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(3).toArray();
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ’å…¥è¿‡æ»¤æ­¥éª¤
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
    
    const aiName = chat.name;
    
    let dynamicContext = ""; 
    if (visiblePosts.length > 0) {
        let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
        for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²ç‚¹èµ]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è¯„è®º]";
                
                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${(post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30)}..."${interactionStatus}\n`;
            }
            dynamicContext = postsContext;
        }

        // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ‰€æœ‰åŠ¨æ€ä¿¡æ¯ä½œä¸ºä¸€æ¡ user æ¶ˆæ¯å‘é€
        messagesPayload.push({
            role: 'user',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·æ ¹æ®ä½ åœ¨ system prompt ä¸­è¯»åˆ°çš„è§„åˆ™å’Œä»¥ä¸‹æœ€æ–°ä¿¡æ¯ï¼Œå¼€å§‹ä½ çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚]\n${dynamicContext}`
        });
        
        console.log("æ­£åœ¨ä¸ºåå°æ´»åŠ¨å‘é€APIè¯·æ±‚ï¼ŒPayload:", JSON.stringify(messagesPayload, null, 2)); // æ·»åŠ æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•

            // å‘é€è¯·æ±‚
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: 0.9,
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
            }
            const data = await response.json();
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆå›å¤
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
                console.warn(`APIä¸ºç©ºå›æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡åå°æ´»åŠ¨è·³è¿‡ã€‚`);
                return;
            }
            const responseArray = parseAiResponse(isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        
        // åç»­å¤„ç†AIè¿”å›æŒ‡ä»¤çš„é€»è¾‘ä¿æŒä¸å˜...
        for (const action of responseArray) {
            if (!action) continue;

            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };

chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯: ${aiMessage.content}`);
            }
if (action.type === 'qzone_post') {
    const newPost = { 
        type: action.postType, 
        content: action.content || '', 
        publicText: action.publicText || '', 
        hiddenContent: action.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ã€æ ¸å¿ƒæ–°å¢ã€‘è®°å½•ä½œè€…çš„åˆ†ç»„ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†åŠ¨æ€`);
            } else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è¯„è®ºäº†åŠ¨æ€ #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ç‚¹èµäº†åŠ¨æ€ #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    state.activeChatId = chatId;
                    showIncomingCallModal();
                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚`);
                }
            }
        }
    } catch (error) {
        console.error(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
    }
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ applyScopedCss å‡½æ•° â–¼â–¼â–¼

/**
 * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„CSSå®‰å…¨åœ°åº”ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
 * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„åŸå§‹CSSå­—ç¬¦ä¸²
 * @param {string} scopeId åº”ç”¨æ ·å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
 * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ ‡ç­¾çš„ID
 */
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    // å¢å¼ºä½œç”¨åŸŸå¤„ç†å‡½æ•° - ä¸“é—¨è§£å†³.userå’Œ.aiæ ·å¼å†²çªé—®é¢˜
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ updateSettingsPreview å‡½æ•° â–¼â–¼â–¼

function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    // 1. è·å–å½“å‰è®¾ç½®çš„å€¼
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; // ç›´æ¥è·å–èƒŒæ™¯è®¾ç½®

    // 2. æ›´æ–°é¢„è§ˆåŒºçš„åŸºæœ¬æ ·å¼
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥æ›´æ–°é¢„è§ˆåŒºçš„èƒŒæ™¯æ ·å¼ ---
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; // å¦‚æœæœ‰å›¾ç‰‡ï¼ŒèƒŒæ™¯è‰²è®¾ä¸ºé€æ˜
    } else {
        previewArea.style.backgroundImage = 'none'; // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç§»é™¤å›¾ç‰‡èƒŒæ™¯
        // å¦‚æœèƒŒæ™¯æ˜¯é¢œè‰²å€¼æˆ–æ¸å˜ï¼ˆéå›¾ç‰‡ï¼‰ï¼Œåˆ™ç›´æ¥åº”ç”¨
        previewArea.style.background = background || '#f0f2f5';
    }

    // 3. æ¸²æŸ“æ¨¡æ‹Ÿæ°”æ³¡
    previewArea.innerHTML = ''; 

    // åˆ›å»ºâ€œå¯¹æ–¹â€çš„æ°”æ³¡
    // æ³¨æ„ï¼šæˆ‘ä»¬å°†ä¸€ä¸ªè™šæ‹Ÿçš„ timestamp ä¼ å…¥ï¼Œä»¥é˜²æœ‰CSSä¾èµ–äºå®ƒ
    const aiMsg = { role: 'ai', content: 'å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    // åˆ›å»ºâ€œæˆ‘â€çš„æ°”æ³¡
    const userMsg = { role: 'user', content: 'æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    // 4. åº”ç”¨è‡ªå®šä¹‰CSSåˆ°é¢„è§ˆåŒº
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™äº›ã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addNewGroup å‡½æ•° â–¼â–¼â–¼
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰ï¼Œå…ˆæ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`åˆ†ç»„ "${name}" å·²ç»å­˜åœ¨äº†ï¼Œæ¢ä¸ªåå­—å§ï¼`);
        return;
    }
    // ã€ä¿®æ­£ç»“æŸã€‘

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'åˆ é™¤åˆ†ç»„åï¼Œè¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        // å°†å±äºè¯¥åˆ†ç»„çš„å¥½å‹çš„ groupId è®¾ä¸º null
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“é•¿æŒ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•
 * @param {number} timestamp - è¢«é•¿æŒ‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showMessageActions(timestamp) {
    // å¦‚æœå·²ç»åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ™ä¸å¼¹å‡ºèœå•
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}

/**
 * éšè—æ¶ˆæ¯æ“ä½œèœå•
 */
function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ openMessageEditor å‡½æ•° â–¼â–¼â–¼
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°† share_link ä¹ŸåŠ å…¥ç‰¹æ®Šç±»å‹åˆ¤æ–­
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        } 
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å¤„ç†åˆ†äº«é“¾æ¥ç±»å‹çš„æ¶ˆæ¯
        else if (message.type === 'share_link') {
            fullMessageObject.title = message.title;
            fullMessageObject.description = message.description;
            fullMessageObject.source_name = message.source_name;
            fullMessageObject.content = message.content;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'link' æ¨¡æ¿
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
    };

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œé“¾æ¥â€æŒ‰é’®
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘æ¶ˆæ¯', 
        'åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘è¿™é‡Œè°ƒç”¨çš„åº”è¯¥æ˜¯ saveEditedMessageï¼Œè€Œä¸æ˜¯ saveAdvancedEditor
        await saveEditedMessage(timestampToEdit, newContent, true);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hideMessageActions();
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ createMessageEditorBlock å‡½æ•° â–¼â–¼â–¼
/**
 * åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„æ¶ˆæ¯å—ï¼ˆåŒ…å«æ–‡æœ¬æ¡†ã€æ ¼å¼åŠ©æ‰‹å’Œåˆ é™¤æŒ‰é’®ï¼‰
 * @param {string} initialContent - æ–‡æœ¬æ¡†çš„åˆå§‹å†…å®¹
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'link' æ¨¡æ¿
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œé“¾æ¥â€æŒ‰é’® -->
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
        </div>
    `;

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªç¼–è¾‘å—
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡æ¶ˆæ¯ã€‚');
        }
    });

    // ç»‘å®šæ ¼å¼åŠ©æ‰‹æŒ‰é’®äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°å‡çº§ç‰ˆã€‘è¯·ç”¨æ­¤å‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ openAdvancedMessageEditor â–¼â–¼â–¼
/**
 * æ‰“å¼€å…¨æ–°çš„ã€å¯è§†åŒ–çš„å¤šæ¶ˆæ¯ç¼–è¾‘å™¨ï¼Œå¹¶åŠ¨æ€ç»‘å®šå…¶æ‰€æœ‰æŒ‰é’®äº‹ä»¶
 */
function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    // 1. ã€æ ¸å¿ƒã€‘åœ¨å…³é—­æ—§èœå•å‰ï¼Œå°†éœ€è¦çš„æ—¶é—´æˆ³æ•è·åˆ°å±€éƒ¨å˜é‡ä¸­
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    // 2. ç°åœ¨å¯ä»¥å®‰å…¨åœ°å…³é—­æ—§èœå•äº†ï¼Œå› ä¸ºå®ƒä¸ä¼šå½±å“æˆ‘ä»¬çš„å±€éƒ¨å˜é‡
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    // 3. å‡†å¤‡åˆå§‹å†…å®¹
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    // 4. ã€æ ¸å¿ƒã€‘åŠ¨æ€ç»‘å®šæ‰€æœ‰æ§åˆ¶æŒ‰é’®çš„äº‹ä»¶
    // ä¸ºäº†é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®šï¼Œæˆ‘ä»¬ä½¿ç”¨å…‹éš†èŠ‚ç‚¹çš„æ–¹æ³•æ¥æ¸…é™¤æ—§ç›‘å¬å™¨
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    // å°†æ•è·åˆ°çš„æ—¶é—´æˆ³ï¼Œç›´æ¥ç»‘å®šç»™è¿™ä¸€æ¬¡çš„ä¿å­˜ç‚¹å‡»äº‹ä»¶
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    // 5. æœ€åï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
    editorModal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * è§£æç¼–è¾‘åçš„æ–‡æœ¬ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯ç‰‡æ®µå¯¹è±¡
 * @param {string} text - ç”¨æˆ·åœ¨ç¼–è¾‘æ¡†ä¸­è¾“å…¥çš„æ–‡æœ¬
 * @returns {object} - ä¸€ä¸ªåŒ…å« type, content, ç­‰å±æ€§çš„å¯¹è±¡
 */
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // 1. å°è¯•è§£æä¸ºJSONå¯¹è±¡ï¼ˆç”¨äºä¿®å¤è¯­éŸ³ã€è½¬è´¦ç­‰æ ¼å¼ï¼‰
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            // å¿…é¡»åŒ…å« type å±æ€§æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆæ ¼å¼
            if (parsed.type) {
                return parsed;
            }
        } catch (e) { /* è§£æå¤±è´¥ï¼Œç»§ç»­å¾€ä¸‹èµ° */ }
    }
    
    // 2. å°è¯•è§£æä¸ºè¡¨æƒ…åŒ…
    if (STICKER_REGEX.test(trimmedText)) {
        // å¯¹äºç¼–è¾‘çš„è¡¨æƒ…ï¼Œæˆ‘ä»¬æš‚æ—¶æ— æ³•çŸ¥é“å…¶`meaning`ï¼Œæ‰€ä»¥åªå­˜URL
        return { type: 'sticker', content: trimmedText };
    }

    // 3. å¦åˆ™ï¼Œè§†ä¸ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
    return { type: 'text', content: trimmedText };
}


// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢ä½ ç°æœ‰çš„ saveEditedMessage å‡½æ•° â–¼â–¼â–¼

async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    let newMessages = [];

    // åˆ¤æ–­æ˜¯æ¥è‡ªé«˜çº§ç¼–è¾‘å™¨è¿˜æ˜¯ç®€å•ç¼–è¾‘å™¨
    if (simpleContent !== null) {
        // --- æ¥è‡ªç®€å•ç¼–è¾‘å™¨ ---
        const rawContent = simpleContent.trim();
        if (rawContent) {
            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸è®¾ç½®æ—¶é—´æˆ³
                content: parsedResult.content || '',
            };
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    } else {
        // --- æ¥è‡ªé«˜çº§ç¼–è¾‘å™¨ ---
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');

        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (!rawContent) continue;

            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // åŒæ ·ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä¸åˆ†é…æ—¶é—´æˆ³
                content: parsedResult.content || '',
            };
            
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    }
    
    if (newMessages.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return; // å¦‚æœæ˜¯ç©ºæ¶ˆæ¯ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåˆ é™¤æ“ä½œ
    }

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®å¤é€»è¾‘å°±åœ¨è¿™é‡Œã€‘â˜…â˜…â˜…â˜…â˜…

    // 1. ä½¿ç”¨ splice å°†æ—§æ¶ˆæ¯æ›¿æ¢ä¸ºæ–°æ¶ˆæ¯ï¼ˆæ­¤æ—¶æ–°æ¶ˆæ¯è¿˜æ²¡æœ‰æ—¶é—´æˆ³ï¼‰
    chat.history.splice(messageIndex, 1, ...newMessages);

    // 2. ç¡®å®šé‡æ–°åˆ†é…æ—¶é—´æˆ³çš„èµ·ç‚¹
    // æˆ‘ä»¬ä»è¢«ç¼–è¾‘çš„æ¶ˆæ¯çš„åŸå§‹æ—¶é—´æˆ³å¼€å§‹
    let reassignTimestamp = timestamp;

    // 3. ä»è¢«ä¿®æ”¹çš„ä½ç½®å¼€å§‹ï¼Œéå†æ‰€æœ‰åç»­çš„æ¶ˆæ¯
    for (let i = messageIndex; i < chat.history.length; i++) {
        // 4. ä¸ºæ¯ä¸€æ¡æ¶ˆæ¯ï¼ˆåŒ…æ‹¬æ–°æ’å…¥çš„ï¼‰åˆ†é…ä¸€ä¸ªæ–°çš„ã€å”¯ä¸€çš„ã€è¿ç»­çš„æ—¶é—´æˆ³
        chat.history[i].timestamp = reassignTimestamp;

        // 5. å°†æ—¶é—´æˆ³+1ï¼Œä¸ºä¸‹ä¸€æ¡æ¶ˆæ¯åšå‡†å¤‡
        reassignTimestamp++; 
    }
    // â˜…â˜…â˜…â˜…â˜…ã€ä¿®å¤ç»“æŸã€‘â˜…â˜…â˜…â˜…â˜…

    await db.chats.put(chat);

    // å…³é—­å¯èƒ½æ‰“å¼€çš„æ¨¡æ€æ¡†å¹¶åˆ·æ–°UI
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°ï¼');
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“ç‚¹å‡»â€œâ€¦â€æ—¶ï¼Œæ˜¾ç¤ºåŠ¨æ€æ“ä½œèœå•
 * @param {number} postId - è¢«æ“ä½œçš„åŠ¨æ€çš„ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * éšè—åŠ¨æ€æ“ä½œèœå•
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

/**
 * æ‰“å¼€åŠ¨æ€ç¼–è¾‘å™¨
 */
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // å¿ äºåŸæ–‡ï¼šæ„å»ºå‡ºæœ€åŸå§‹çš„æ–‡æœ¬å½¢æ€ä¾›ç¼–è¾‘
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        // å¯¹äºå›¾ç‰‡å’Œæ–‡å­—å›¾ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å¯¹è±¡
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    // æ„å»ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®
    const templates = {
        shuoshuo: "åœ¨è¿™é‡Œè¾“å…¥è¯´è¯´çš„å†…å®¹...", // å¯¹äºè¯´è¯´ï¼Œæˆ‘ä»¬ç›´æ¥æ›¿æ¢ä¸ºçº¯æ–‡æœ¬
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">è¯´è¯´</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡åŠ¨æ€</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>æ–‡å­—å›¾</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘åŠ¨æ€',
        'åœ¨æ­¤ä¿®æ”¹å†…å®¹...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    // ã€ç‰¹æ®Šå¤„ç†ã€‘ä¸ºè¯´è¯´çš„æ ¼å¼åŠ©æ‰‹æŒ‰é’®æ·»åŠ ä¸åŒçš„è¡Œä¸º
    // æˆ‘ä»¬éœ€è¦åœ¨æ¨¡æ€æ¡†å‡ºç°åï¼Œå†ç»™å®ƒç»‘å®šäº‹ä»¶
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}

/**
 * ä¿å­˜ç¼–è¾‘åçš„åŠ¨æ€
 * @param {number} postId - è¦ä¿å­˜çš„åŠ¨æ€ID
 * @param {string} newRawContent - ä»ç¼–è¾‘å™¨è·å–çš„æ–°å†…å®¹
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è®¤ä¸ºæ˜¯çº¯æ–‡æœ¬ï¼ˆè¯´è¯´ï¼‰
    try {
        const parsed = JSON.parse(trimmedContent);
        // æ›´æ–°å¸–å­å±æ€§
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // æ¸…ç©ºæ—§çš„è¯´è¯´å†…å®¹å­—æ®µ
    } catch (e) {
        // è§£æå¤±è´¥ï¼Œè®¤ä¸ºæ˜¯è¯´è¯´
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // æ¸…ç©ºå…¶ä»–ç±»å‹çš„å­—æ®µ
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    await showCustomAlert('æˆåŠŸ', 'åŠ¨æ€å·²æ›´æ–°ï¼');
}

/**
 * å¤åˆ¶åŠ¨æ€å†…å®¹
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hidePostActions();
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºç¾¤èŠä¸æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡é€‰æ‹©

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºâ€œå®Œæˆâ€æŒ‰é’®æ˜ç¡®ç»‘å®šâ€œåˆ›å»ºç¾¤èŠâ€çš„åŠŸèƒ½
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œæ¸…é™¤æ‰ä¹‹å‰å¯èƒ½ç»‘å®šçš„ä»»ä½•å…¶ä»–äº‹ä»¶ï¼ˆæ¯”å¦‚â€œæ·»åŠ æˆå‘˜â€ï¼‰
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    // é‡æ–°ç»‘å®šæ­£ç¡®çš„â€œåˆ›å»ºç¾¤èŠâ€å‡½æ•°
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ¸²æŸ“è”ç³»äººé€‰æ‹©åˆ—è¡¨
 */
async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // åªé€‰æ‹©å•èŠè§’è‰²ä½œä¸ºç¾¤æˆå‘˜å€™é€‰
    const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">è¿˜æ²¡æœ‰å¯ä»¥æ‹‰è¿›ç¾¤çš„è”ç³»äººå“¦~</p>';
        return;
    }

    contacts.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * æ›´æ–°â€œå®Œæˆâ€æŒ‰é’®çš„è®¡æ•°
 */
function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2ä¸ªäººæ‰èƒ½åˆ›å»ºç¾¤èŠ
}

/**
 * ã€é‡æ„ç‰ˆã€‘å¤„ç†åˆ›å»ºç¾¤èŠçš„æœ€ç»ˆé€»è¾‘
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("åˆ›å»ºç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—', 'æˆ‘ä»¬çš„ç¾¤èŠ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
    // éå†é€‰ä¸­çš„è”ç³»äººID
    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
            // æˆ‘ä»¬ç°åœ¨åŒæ—¶å­˜å‚¨è§’è‰²çš„â€œæœ¬åâ€å’Œâ€œç¾¤æ˜µç§°â€
            members.push({
                id: contactId, 
                originalName: contactChat.name,   // è§’è‰²çš„â€œæœ¬åâ€ï¼Œç”¨äºAIè¯†åˆ«
                groupNickname: contactChat.name, // è§’è‰²çš„â€œç¾¤æ˜µç§°â€ï¼Œç”¨äºæ˜¾ç¤ºå’Œä¿®æ”¹ï¼Œåˆå§‹å€¼å’Œæœ¬åç›¸åŒ
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
            myNickname: 'æˆ‘',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€ç¾¤æˆå‘˜ç®¡ç†å±å¹•
 */
function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}

function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ˜¾ç¤ºçš„åç§°ä» member.name æ”¹ä¸º member.groupNickname
        item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.groupNickname}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="ç§»å‡ºç¾¤èŠ">-</button>
        `;
        listEl.appendChild(item);
    });
}

/**
 * ä»ç¾¤èŠä¸­ç§»é™¤ä¸€ä¸ªæˆå‘˜
 * @param {string} memberId - è¦ç§»é™¤çš„æˆå‘˜ID
 */
async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    
    if (memberIndex === -1) return;
    
    // å®‰å…¨æ£€æŸ¥ï¼Œç¾¤èŠè‡³å°‘ä¿ç•™2äºº
    if (chat.members.length <= 2) {
        alert("ç¾¤èŠäººæ•°ä¸èƒ½å°‘äº2äººã€‚");
        return;
    }
    
const memberName = chat.members[memberIndex].groupNickname; // <-- ä¿®å¤ï¼šä½¿ç”¨ groupNickname
    const confirmed = await showCustomConfirm(
        'ç§»å‡ºæˆå‘˜',
        `ç¡®å®šè¦å°†â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);
        renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
        document.getElementById('chat-settings-btn').click(); // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ¨¡æ‹Ÿç‚¹å‡»è®¾ç½®æŒ‰é’®ï¼Œå¼ºåˆ¶åˆ·æ–°æ•´ä¸ªå¼¹çª—
    }
}

/**
 * æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨ï¼Œç”¨äºæ‹‰äººå…¥ç¾¤
 */
async function openContactPickerForAddMember() {
    selectedContacts.clear(); // æ¸…ç©ºé€‰æ‹©
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    // æ¸²æŸ“è”ç³»äººåˆ—è¡¨ï¼Œå¹¶è‡ªåŠ¨æ’é™¤å·²åœ¨ç¾¤å†…çš„æˆå‘˜
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²¡æœ‰æ›´å¤šå¯ä»¥é‚€è¯·çš„å¥½å‹äº†ã€‚</p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // æ²¡æœ‰äººå¯é€‰ï¼Œéšè—å®ŒæˆæŒ‰é’®
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
            listEl.appendChild(item);
        });
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€å¹¶æ˜¾ç¤ºå±å¹•
    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}

/**
 * å¤„ç†å°†é€‰ä¸­çš„è”ç³»äººåŠ å…¥ç¾¤èŠçš„é€»è¾‘
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ çš„è”ç³»äººã€‚");
        return;
    }
    
    const chat = state.chats[state.activeChatId];

    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
chat.members.push({
    id: contactId,
    originalName: contactChat.name,  // <-- ä¿®å¤1ï¼šä½¿ç”¨ 'originalName' å­˜å‚¨æœ¬å
    groupNickname: contactChat.name, // <-- ä¿®å¤2ï¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªåˆå§‹çš„ 'groupNickname'
    avatar: contactChat.settings.aiAvatar || defaultAvatar,
    persona: contactChat.settings.aiPersona,
    avatarFrame: contactChat.settings.aiAvatarFrame || ''
});
        }
    }

    await db.chats.put(chat);
    openMemberManagementScreen(); // è¿”å›åˆ°ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢
    renderGroupMemberSettings(chat.members); // åŒæ—¶æ›´æ–°èŠå¤©è®¾ç½®é‡Œçš„å¤´åƒ
}

/**
 * ã€é‡æ„ç‰ˆã€‘åœ¨ç¾¤èŠä¸­åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è™šæ‹Ÿæˆå‘˜
 */
async function createNewMemberInGroup() {
    const name = await showCustomPrompt('åˆ›å»ºæ–°æˆå‘˜', 'è¯·è¾“å…¥æ–°æˆå‘˜çš„åå­— (è¿™å°†æ˜¯TAçš„â€œæœ¬åâ€ï¼Œä¸å¯æ›´æ”¹)');
    if (!name || !name.trim()) return;

    // æ£€æŸ¥æœ¬åæ˜¯å¦å·²åœ¨ç¾¤å†…å­˜åœ¨
    const chat = state.chats[state.activeChatId];
    if (chat.members.some(m => m.originalName === name.trim())) {
        alert(`é”™è¯¯ï¼šç¾¤å†…å·²å­˜åœ¨åä¸ºâ€œ${name.trim()}â€çš„æˆå‘˜ï¼`);
        return;
    }

    const persona = await showCustomPrompt('è®¾ç½®äººè®¾', `è¯·è¾“å…¥â€œ${name}â€çš„äººè®¾`, '', 'textarea');
    if (persona === null) return; 

    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    // ä¸ºæ–°åˆ›å»ºçš„NPCä¹Ÿå»ºç«‹åŒé‡å‘½åæœºåˆ¶
    const newMember = {
        id: 'npc_' + Date.now(),
        originalName: name.trim(),   // æ–°æˆå‘˜çš„â€œæœ¬åâ€
        groupNickname: name.trim(), // æ–°æˆå‘˜çš„åˆå§‹â€œç¾¤æ˜µç§°â€
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    renderMemberManagementList();
    renderGroupMemberSettings(chat.members); 

    alert(`æ–°æˆå‘˜â€œ${name}â€å·²æˆåŠŸåŠ å…¥ç¾¤èŠï¼`);
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚å€’è®¡æ—¶å‡½æ•° â–¼â–¼â–¼
function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
        const now = Date.now();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerId);
            element.innerHTML = '<span>å·²</span><span>è¶…</span><span>æ—¶</span>';
            return;
        }

        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        const minStr = String(minutes).padStart(2, '0');
        const secStr = String(seconds).padStart(2, '0');

        element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
}

function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
        clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘è®°å½•æ”¯ä»˜è€…ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // è®°å½•æ˜¯ç”¨æˆ·ä»˜çš„é’±
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
    } else {
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
    }

    // 2. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 3. ä¿å­˜æ›´æ–°åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);  
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘---
    callHistory: [], // ç”¨äºå­˜å‚¨é€šè¯ä¸­çš„å¯¹è¯å†å²
    preCallContext: "" // ç”¨äºå­˜å‚¨é€šè¯å‰çš„èŠå¤©æ‘˜è¦
};

let callTimerInterval = null; // ç”¨äºå­˜å‚¨è®¡æ—¶å™¨çš„ID

/**
 * ã€æ€»å…¥å£ã€‘ç”¨æˆ·ç‚¹å‡»â€œå‘èµ·è§†é¢‘é€šè¯â€æˆ–â€œå‘èµ·ç¾¤è§†é¢‘â€æŒ‰é’®
 */
async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true; // ç”¨æˆ·è‡ªå·±å‘èµ·çš„ï¼Œå½“ç„¶æ˜¯å‚ä¸è€…

    // æ ¹æ®æ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œæ˜¾ç¤ºä¸åŒçš„å‘¼å«ç•Œé¢
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'æˆ‘';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå‘˜..." : "æ­£åœ¨å‘¼å«...";
    showScreen('outgoing-call-screen');
    
    // å‡†å¤‡å¹¶å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™AI
    const requestMessage = {
        role: 'system',
        content: chat.isGroup 
            ? `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${chat.settings.myNickname || 'æˆ‘'}) å‘èµ·äº†ç¾¤è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–ï¼Œå¹¶ä½¿ç”¨ "group_call_response" æŒ‡ä»¤ï¼Œè®¾ç½® "decision" ä¸º "join" æˆ– "decline" æ¥å›åº”ã€‚]`
            : `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œä½¿ç”¨ "video_call_response" æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® "decision" ä¸º "accept" æˆ– "reject" æ¥å›åº”ã€‚]`,
        timestamp: Date.now(),
        isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);
    
    // è§¦å‘AIå“åº”
    await triggerAiResponse();
}


function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = []; // ã€æ–°å¢ã€‘æ¸…ç©ºä¸Šä¸€æ¬¡é€šè¯çš„å†å²

    // --- ã€æ ¸å¿ƒæ–°å¢ï¼šæŠ“å–é€šè¯å‰ä¸Šä¸‹æ–‡ã€‘---
    const preCallHistory = chat.history.slice(-10); // å–æœ€å10æ¡ä½œä¸ºä¸Šä¸‹æ–‡
    videoCallState.preCallContext = preCallHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');
    // --- æ–°å¢ç»“æŸ ---

    updateParticipantAvatars(); 
    
    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ç¾¤èŠå·²å»ºç«‹...' : 'æ­£åœ¨æ¥é€š...'}</em>`;
    showScreen('video-call-screen');

    document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
}

/**
 * ã€æ ¸å¿ƒã€‘ç»“æŸè§†é¢‘é€šè¯
 */
// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ endVideoCall å‡½æ•° â–¼â–¼â–¼
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endCallText = `é€šè¯ç»“æŸï¼Œæ—¶é•¿ ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ä¿å­˜å®Œæ•´çš„é€šè¯è®°å½•åˆ°æ•°æ®åº“ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'æˆ‘', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'æˆ‘', avatar: chat.settings.myAvatar || defaultAvatar });
        }
        
        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("é€šè¯è®°å½•å·²ä¿å­˜:", callRecord);
        
        // 2. åœ¨èŠå¤©è®°å½•é‡Œæ·»åŠ å¯¹ç”¨æˆ·å¯è§çš„â€œé€šè¯ç»“æŸâ€æ¶ˆæ¯
let summaryMessage = {
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘role ç”± videoCallState.initiator å†³å®š
    role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
    content: endCallText,
    timestamp: Date.now(),
};

// ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¸ºç¾¤èŠçš„ assistant æ¶ˆæ¯è¡¥å…… senderName
if (chat.isGroup && summaryMessage.role === 'assistant') {
    // åœ¨ç¾¤èŠä¸­ï¼Œé€šè¯ç»“æŸçš„æ¶ˆæ¯åº”è¯¥ç”±â€œå‘èµ·è€…â€æ¥è¯´
    // videoCallState.callRequester ä¿å­˜äº†æœ€åˆå‘èµ·é€šè¯çš„é‚£ä¸ªAIçš„åå­—
    summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        chat.history.push(summaryMessage);

        // 3. ã€æ ¸å¿ƒå˜é©ã€‘åˆ›å»ºå¹¶æ·»åŠ å¯¹ç”¨æˆ·éšè—çš„â€œé€šè¯åæ±‡æŠ¥â€æŒ‡ä»¤
        const callTranscriptForAI = videoCallState.callHistory.map(h => `${h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.role}: ${h.content}`).join('\n');
        
        const hiddenReportInstruction = {
            role: 'system',
    content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šè§†é¢‘é€šè¯åˆšåˆšç»“æŸã€‚è¯·ä½ æ ¹æ®å®Œæ•´çš„é€šè¯æ–‡å­—è®°å½•ï¼ˆè§ä¸‹æ–¹ï¼‰ï¼Œä»¥ä½ çš„è§’è‰²å£å»ï¼Œå‘ç”¨æˆ·ä¸»åŠ¨å‘é€å‡ æ¡ã€æ ¼å¼ä¸º {"type": "text", "content": "..."} çš„ã€‘æ¶ˆæ¯ï¼Œæ¥è‡ªç„¶åœ°æ€»ç»“è¿™æ¬¡é€šè¯çš„è¦ç‚¹ã€ç¡®è®¤è¾¾æˆçš„çº¦å®šï¼Œæˆ–è€…è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚è¿™å¾ˆé‡è¦ï¼Œèƒ½è®©ç”¨æˆ·æ„Ÿè§‰ä½ è®°å¾—é€šè¯å†…å®¹ã€‚]\n---é€šè¯è®°å½•å¼€å§‹---\n${callTranscriptForAI}\n---é€šè¯è®°å½•ç»“æŸ---`,
            timestamp: Date.now() + 1, // ç¡®ä¿åœ¨ä¸Šä¸€æ¡æ¶ˆæ¯ä¹‹å
            isHidden: true
        };
        chat.history.push(hiddenReportInstruction);

        // 4. ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°æ•°æ®åº“
        await db.chats.put(chat);
    }
    
    // 5. æ¸…ç†å’Œé‡ç½®çŠ¶æ€ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 6. è¿”å›èŠå¤©ç•Œé¢å¹¶è§¦å‘AIå“åº”ï¼ˆAIä¼šè¯»å–åˆ°æˆ‘ä»¬çš„â€œæ±‡æŠ¥â€æŒ‡ä»¤ï¼‰
    if (chat) {
        openChat(chat.id);
        triggerAiResponse(); // å…³é”®ä¸€æ­¥ï¼
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°é€šè¯ç•Œé¢çš„å‚ä¸è€…å¤´åƒç½‘æ ¼
 */
function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    // â˜… æ ¸å¿ƒä¿®æ­£ï¼šåŒºåˆ†ç¾¤èŠå’Œå•èŠ
    if (videoCallState.isGroupCall) {
        // ç¾¤èŠé€»è¾‘ï¼šæ˜¾ç¤ºæ‰€æœ‰å·²åŠ å…¥çš„AIæˆå‘˜
        participantsToRender = [...videoCallState.participants];
        // å¦‚æœç”¨æˆ·ä¹Ÿå‚ä¸äº†ï¼Œå°±æŠŠç”¨æˆ·ä¿¡æ¯ä¹ŸåŠ è¿›å»
        if (videoCallState.isUserParticipating) {
            participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || 'æˆ‘',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar
            });
        }
    } else {
        // å•èŠé€»è¾‘ï¼šåªæ˜¾ç¤ºå¯¹æ–¹çš„å¤´åƒå’Œåå­—
        participantsToRender.push({
            id: 'ai',
            name: chat.name,
            avatar: chat.settings.aiAvatar || defaultAvatar
        });
    }
    
    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
const displayName = p.groupNickname || p.name; // <-- æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ
wrapper.innerHTML = `
    <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
    <div class="participant-name">${displayName}</div>
`;
        grid.appendChild(wrapper);
    });
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·åŠ å…¥/é‡æ–°åŠ å…¥é€šè¯
 */
function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    updateParticipantAvatars(); // æ›´æ–°å¤´åƒåˆ—è¡¨ï¼ŒåŠ å…¥ç”¨æˆ·

    // åˆ‡æ¢åº•éƒ¨æŒ‰é’®
    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';

    // å‘ŠçŸ¥AIç”¨æˆ·åŠ å…¥äº†
    triggerAiInCallAction("[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åŠ å…¥äº†é€šè¯]");
}


/**
 * æ›´æ–°é€šè¯è®¡æ—¶å™¨æ˜¾ç¤º (ä¿æŒä¸å˜)
 */
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªå®Œæ•´å‡½æ•°æ›¿æ¢æ—§çš„ showIncomingCallModal â–¼â–¼â–¼
function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // æ ¹æ®æ˜¯å¦ç¾¤èŠæ˜¾ç¤ºä¸åŒä¿¡æ¯
    if (chat.isGroup) {
        // ä» videoCallState ä¸­è·å–æ˜¯å“ªä¸ªæˆå‘˜å‘èµ·çš„é€šè¯
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'ä¸€ä½æˆå‘˜';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; // æ˜¾ç¤ºç¾¤å
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} é‚€è¯·ä½ åŠ å…¥ç¾¤è§†é¢‘`; // æ˜¾ç¤ºå…·ä½“å‘èµ·äºº
    } else {
        // å•èŠé€»è¾‘ä¿æŒä¸å˜
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = 'é‚€è¯·ä½ è§†é¢‘é€šè¯';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * éšè—AIå‘èµ·çš„é€šè¯è¯·æ±‚æ¨¡æ€æ¡† (ä¿æŒä¸å˜)
 */
function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
}

async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || 'æˆ‘';

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸–ç•Œä¹¦è¯»å–é€»è¾‘ â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    // 1. å¦‚æœç”¨æˆ·æœ‰è¾“å…¥ï¼Œå…ˆæ¸²æŸ“å¹¶å­˜å…¥é€šè¯å†å²
    if (userInput && videoCallState.isUserParticipating) {
        const userBubble = document.createElement('div');
        userBubble.className = 'call-message-bubble user-speech';
        userBubble.textContent = userInput;
        callFeed.appendChild(userBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    // 2. æ„å»ºå…¨æ–°çš„ã€åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡çš„ System Prompt
    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantNames = videoCallState.participants.map(p => p.name);
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        inCallPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠè§†é¢‘é€šè¯çš„å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„AIè§’è‰²ï¼Œå¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°ä»–ä»¬åœ¨é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${userNickname}"** çš„å‘è¨€ã€‚
2.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
3.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å‘è¨€ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "speech": "*ä»–ç¬‘äº†ç¬‘* å¤§å®¶å¥½å•Šï¼"}\`ã€‚
4.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šã€‚
# å½“å‰æƒ…æ™¯
ä½ ä»¬æ­£åœ¨ä¸€ä¸ªç¾¤è§†é¢‘é€šè¯ä¸­ã€‚
**é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
${videoCallState.preCallContext}
**å½“å‰å‚ä¸è€…**: ${participantNames.join('ã€ ')}ã€‚
**é€šè¯åˆšåˆšå¼€å§‹...**
${worldBookContent} // <-- ã€æ ¸å¿ƒã€‘æ³¨å…¥ä¸–ç•Œä¹¦
ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
`;
    } else { 
        let openingContext = videoCallState.initiator === 'user'
            ? `ä½ åˆšåˆšæ¥å¬äº†ç”¨æˆ·çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚`
            : `ç”¨æˆ·åˆšåˆšæ¥å¬äº†ä½ ä¸»åŠ¨å‘èµ·çš„è§†é¢‘é€šè¯ã€‚`;
        inCallPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯ä¸€ä¸ªåœºæ™¯æè¿°å¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼” ${chat.name} (${chat.settings.aiPersona})ï¼Œå¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°TAåœ¨è§†é¢‘é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼Œå¦‚â€œä»–â€ã€â€œå¥¹â€ã€æˆ–ç›´æ¥ä½¿ç”¨è§’è‰²åâ€œ${chat.name}â€ã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€æ®µæè¿°æ€§çš„æ–‡æœ¬ã€‚
# å½“å‰æƒ…æ™¯
ä½ æ­£åœ¨å’Œç”¨æˆ·ï¼ˆ${userNickname}ï¼Œäººè®¾: ${chat.settings.myPersona}ï¼‰è¿›è¡Œè§†é¢‘é€šè¯ã€‚
**${openingContext}**
**é€šè¯å‰çš„èŠå¤©æ‘˜è¦ (è¿™æ˜¯ä½ ä»¬é€šè¯çš„åŸå› ï¼Œè‡³å…³é‡è¦ï¼)**:
${videoCallState.preCallContext}
ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
`;
    }
    
    // 3. æ„å»ºå‘é€ç»™APIçš„ messages æ•°ç»„
    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        // å°†å·²æœ‰çš„é€šè¯å†å²åŠ è¿›å»
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    // --- ã€æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æœ‰å†…å®¹ã€‘---
    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*ä½ æŒ‰ä¸‹äº†æ¥å¬é”®...*` : `*å¯¹æ–¹æŒ‰ä¸‹äº†æ¥å¬é”®...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    // --- ä¿®å¤ç»“æŸ ---
    
        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,inCallPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model, messages: messagesForApi, temperature: 0.8
                })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);

            const data = await response.json();
            const aiResponse = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

            const connectingElement = callFeed.querySelector('em');
            if (connectingElement) connectingElement.remove();

        // 4. å¤„ç†AIè¿”å›çš„å†…å®¹ï¼Œå¹¶å°†å…¶å­˜å…¥é€šè¯å†å²
        if (videoCallState.isGroupCall) {
            const speechArray = parseAiResponse(aiResponse);
            speechArray.forEach(turn => {
                if (!turn.name || turn.name === userNickname || !turn.speech) return;
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                
                const speaker = videoCallState.participants.find(p => p.name === turn.name);
                if (speaker) {
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
            });
        } else {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'call-message-bubble ai-speech';
            aiBubble.textContent = aiResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: aiResponse });

            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
            if(speakingAvatar) {
                speakingAvatar.classList.add('speaking');
                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'call-message-bubble ai-speech';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}

// â–¼â–¼â–¼ å°†è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™ä¸ªå‡½æ•°æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼Œè¯·ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½åŒº â–¼â–¼â–¼
async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°å†…å­˜ä¸­åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // 2. è·å–å½“å‰ç”¨æˆ·çš„æ˜µç§°ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // è®°å½•æ˜¯â€œæˆ‘â€ä»˜çš„é’±
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
    } else {
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
    }

    // 3. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 4. å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¹¶ç«‹åˆ»é‡ç»˜UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    // 5. ã€é‡è¦ã€‘åªæœ‰åœ¨æ”¯ä»˜æˆåŠŸåï¼Œæ‰è§¦å‘ä¸€æ¬¡AIå“åº”ï¼Œè®©å®ƒæ„Ÿè°¢ä½ 
    if (choice === 'paid') {
        triggerAiResponse();
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»å¤´åƒå‘èµ·çš„â€œæ‹ä¸€-æ‹â€ï¼Œå¸¦æœ‰è‡ªå®šä¹‰åç¼€åŠŸèƒ½
 * @param {string} chatId - å‘ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
 * @param {string} characterName - è¢«æ‹çš„è§’è‰²å
 */
async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. è§¦å‘å±å¹•éœ‡åŠ¨åŠ¨ç”»
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    // 2. å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥åç¼€
    const suffix = await showCustomPrompt(
        `ä½ æ‹äº†æ‹ â€œ${characterName}â€`, 
        "ï¼ˆå¯é€‰ï¼‰è¾“å…¥åç¼€",
        "",
        "text"
    );

    // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš
    if (suffix === null) return;

    // 3. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†åç¼€æ‹¼æ¥åˆ°æ¶ˆæ¯å†…å®¹ä¸­
    const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${characterName}â€ ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', // ä»ç„¶æ˜¯ç³»ç»Ÿæ¶ˆæ¯
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // 4. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œä»¥è§¦å‘AIçš„å›åº”
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŒæ ·å°†åç¼€åŠ å…¥åˆ°ç»™AIçš„æç¤ºä¸­
    const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${myNickname}ï¼‰åˆšåˆšæ‹äº†æ‹ä½ ï¼ˆ${characterName}ï¼‰${suffix.trim()}ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, // æ—¶é—´æˆ³+1ä»¥ä¿è¯é¡ºåº
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. ä¿å­˜æ›´æ”¹å¹¶æ›´æ–°UI
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€é€»è¾‘é‡æ„åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderMemoriesScreen å‡½æ•° â–¼â–¼â–¼
/**
 * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å›å¿†ä¸çº¦å®šç•Œé¢ï¼Œä½¿ç”¨å•ä¸€å¾ªç¯å’Œæ¸…æ™°çš„if/elseé€»è¾‘
 */
async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    // 1. è·å–æ‰€æœ‰å›å¿†ï¼Œå¹¶æŒ‰ç›®æ ‡æ—¥æœŸï¼ˆå¦‚æœæ˜¯çº¦å®šï¼‰æˆ–åˆ›å»ºæ—¥æœŸï¼ˆå¦‚æœæ˜¯å›å¿†ï¼‰é™åºæ’åˆ—
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰å…±åŒçš„å›å¿†å’Œçº¦å®šå‘¢~</p>';
        return;
    }

    // 2. å°†æœªåˆ°æœŸçš„çº¦å®šæ’åœ¨æœ€å‰é¢
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bæ’å‰é¢
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è®¡æ—¶ï¼ŒæŒ‰æ—¥æœŸå‡åº
        return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸåº
    });

    // 3. ã€æ ¸å¿ƒã€‘ä½¿ç”¨å•ä¸€å¾ªç¯æ¥å¤„ç†æ‰€æœ‰ç±»å‹çš„å¡ç‰‡
    allMemories.forEach(item => {
        let card;
        // åˆ¤æ–­1ï¼šå¦‚æœæ˜¯æ­£åœ¨è¿›è¡Œçš„çº¦å®š
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        // åˆ¤æ–­2ï¼šå…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆæ™®é€šå›å¿† æˆ– å·²åˆ°æœŸçš„çº¦å®šï¼‰
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    // 4. å¯åŠ¨æ‰€æœ‰å€’è®¡æ—¶
    startAllCountdownTimers();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * åˆ›å»ºæ™®é€šå›å¿†å¡ç‰‡DOMå…ƒç´ 
 */
function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ä¸åŒç±»å‹çš„å›å¿†è¿›è¡Œæ¸…æ™°çš„åŒºåˆ†
    if (memory.type === 'countdown' && memory.targetDate) {
        // å¦‚æœæ˜¯å·²åˆ°æœŸçš„çº¦å®š
        titleHtml = `[çº¦å®šè¾¾æˆ] ${memory.description}`;
        contentHtml = `åœ¨ ${new Date(memory.targetDate).toLocaleString()}ï¼Œæˆ‘ä»¬ä¸€èµ·è§è¯äº†è¿™ä¸ªçº¦å®šã€‚`;
    } else {
        // å¦‚æœæ˜¯æ™®é€šçš„æ—¥è®°å¼å›å¿†
        titleHtml = memory.authorName ? `${memory.authorName} çš„æ—¥è®°` : 'æˆ‘ä»¬çš„å›å¿†';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆ é™¤è®°å½•', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨ä½¿ç”¨å‰ï¼Œå…ˆä» countdown å¯¹è±¡ä¸­åˆ›å»º targetDate å˜é‡
    const targetDate = new Date(countdown.targetDate);
    
    // ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ—¶--åˆ†--ç§’</div>
        <div class="target-date">ç›®æ ‡æ—¶é—´: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆ é™¤çº¦å®š', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// å…¨å±€å˜é‡ï¼Œç”¨äºç®¡ç†æ‰€æœ‰å€’è®¡æ—¶
let activeCountdownTimers = [];

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ startAllCountdownTimers å‡½æ•° â–¼â–¼â–¼
function startAllCountdownTimers() {
    // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç”¨ let å£°æ˜ timerId
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "çº¦å®šè¾¾æˆï¼";
                // ç°åœ¨ updateTimer å¯ä»¥æ­£ç¡®åœ°æ‰¾åˆ°å¹¶æ¸…é™¤å®ƒè‡ªå·±äº†
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
        };
        
        updateTimer(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ä»¥æ˜¾ç¤ºåˆå§‹å€’è®¡æ—¶
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºå·²å£°æ˜çš„ timerId èµ‹å€¼
        timerId = setInterval(updateTimer, 1000);
        
        // å°†æœ‰æ•ˆçš„è®¡æ—¶å™¨IDå­˜å…¥å…¨å±€æ•°ç»„ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ—¶å¯ä»¥æ¸…é™¤
        activeCountdownTimers.push(timerId);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæåä»£å…¼å®¹ç‰ˆã€‘æ›¿æ¢æ—§çš„ triggerAiFriendApplication å‡½æ•° â–¼â–¼â–¼
async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("æµç¨‹å¯åŠ¨", `æ­£åœ¨ä¸ºè§’è‰²â€œ${chat.name}â€å‡†å¤‡å¥½å‹ç”³è¯·...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("é…ç½®é”™è¯¯", "APIè®¾ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç»§ç»­ã€‚");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (è¯·å‚è€ƒ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰æ‹‰é»‘äº†ï¼Œä½ ä»¬å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è”ç³»äº†ã€‚
ç°åœ¨ï¼Œä½ éå¸¸å¸Œæœ›èƒ½å¤Ÿå’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ·èŠå¤©ã€‚è¯·ä½ ä»”ç»†åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦â€ï¼Œç†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œç„¶åæ€è€ƒä¸€ä¸ªçœŸè¯šçš„ã€ç¬¦åˆä½ äººè®¾ã€å¹¶ä¸”ã€é’ˆå¯¹å…·ä½“äº‹ä»¶ã€‘çš„ç”³è¯·ç†ç”±ã€‚
# ä½ çš„è§’è‰²è®¾å®š
${chat.settings.aiPersona}
${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ³¨å…¥ä¸–ç•Œä¹¦å†…å®¹
# è¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦ (è¿™æ˜¯ä½ è¢«æ‹‰é»‘çš„å…³é”®åŸå› )
${contextSummary}
# æŒ‡ä»¤æ ¼å¼
ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
{
  "decision": "apply",
  "reason": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„ã€çœŸè¯šçš„ã€æœ‰é’ˆå¯¹æ€§çš„ç”³è¯·ç†ç”±ã€‚"
}
\`\`\`
`;

        const messagesForApi = [
            {role: 'user', content: systemPrompt}
        ];

        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.9,
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();

            // --- ã€æ ¸å¿ƒä¿®æ­£ï¼šåœ¨è¿™é‡Œå‡€åŒ–AIçš„å›å¤ã€‘ ---
            let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            // 1. ç§»é™¤å¤´å°¾å¯èƒ½å­˜åœ¨çš„ "```json" å’Œ "```"
            rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
            // 2. ç§»é™¤æ‰€æœ‰æ¢è¡Œç¬¦å’Œå¤šä½™çš„ç©ºæ ¼ï¼Œç¡®ä¿æ˜¯ä¸€ä¸ªå¹²å‡€çš„JSONå­—ç¬¦ä¸²
            const cleanedContent = rawContent.trim();

            // 3. ä½¿ç”¨å‡€åŒ–åçš„å†…å®¹è¿›è¡Œè§£æ
            const responseObj = JSON.parse(cleanedContent);
            // --- ã€ä¿®æ­£ç»“æŸã€‘ ---

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("ç”³è¯·æˆåŠŸï¼", `â€œ${chat.name}â€å·²å‘ä½ å‘é€å¥½å‹ç”³è¯·ã€‚è¯·è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`);

        } else {
            await showCustomAlert("AIå†³ç­–", `â€œ${chat.name}â€æ€è€ƒåå†³å®šæš‚æ—¶ä¸å‘é€å¥½å‹ç”³è¯·ï¼Œå°†é‡ç½®å†·é™æœŸã€‚`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("æ‰§è¡Œå‡ºé”™", `ä¸ºâ€œ${chat.name}â€ç”³è¯·å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯ï¼š\n\n${error.message}\n\nå°†é‡ç½®å†·é™æœŸã€‚`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘æ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ‰“å¼€è½¬è´¦å¼¹çª—è¿˜æ˜¯çº¢åŒ…å¼¹çª—
 */
function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        // å•èŠä¿æŒåŸæ ·ï¼Œæ‰“å¼€è½¬è´¦å¼¹çª—
        document.getElementById('transfer-modal').classList.add('visible');
    }
}

/**
 * æ‰“å¼€å¹¶åˆå§‹åŒ–å‘çº¢åŒ…æ¨¡æ€æ¡†
 */
function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    // æ¸…ç†è¾“å…¥æ¡†
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
    document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';

    // å¡«å……ä¸“å±çº¢åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
chat.members.forEach(member => {
    const option = document.createElement('option');
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ originalName ä½œä¸ºæäº¤ç»™AIçš„å€¼ï¼Œå› ä¸ºå®ƒç‹¬ä¸€æ— äºŒ
    option.value = member.originalName; 
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ groupNickname ä½œä¸ºæ˜¾ç¤ºç»™ç”¨æˆ·çœ‹çš„å€¼
    option.textContent = member.groupNickname; 
    receiverSelect.appendChild(option);
});
    
    // é»˜è®¤æ˜¾ç¤ºæ‹¼æ‰‹æ°”çº¢åŒ…é¡µç­¾
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}

/**
 * å‘é€ç¾¤çº¢åŒ…ï¼ˆæ‹¼æ‰‹æ°”ï¼‰
 */
async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢ï¼"); return;
    }
    if (isNaN(count) || count <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°ï¼"); return;
    }
    if (amount / count < 0.01) {
        alert("å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½å°‘äº0.01å…ƒï¼"); return;
    }

    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼',
        claimedBy: {}, // { name: amount }
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * å‘é€ä¸“å±çº¢åŒ…
 */
async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼"); return;
    }
    if (!receiverName) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¥æ”¶äººï¼"); return;
    }
    
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || 'ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…',
        receiverName: receiverName, // æ ¸å¿ƒå­—æ®µ
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»çº¢åŒ…å¡ç‰‡æ—¶è§¦å‘ (V4 - æµç¨‹é‡æ„ç‰ˆ)
 * @param {number} timestamp - è¢«ç‚¹å‡»çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || 'æˆ‘';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    // å¦‚æœæ˜¯ä¸“å±çº¢åŒ…ä¸”ä¸æ˜¯ç»™æˆ‘çš„ï¼Œæˆ–å·²é¢†å®Œï¼Œæˆ–å·²é¢†è¿‡ï¼Œéƒ½åªæ˜¾ç¤ºè¯¦æƒ…
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        // æ ¸å¿ƒæµç¨‹ï¼šå…ˆå°è¯•æ‰“å¼€çº¢åŒ…
        const claimedAmount = await handleOpenRedPacket(packet);
        
        // å¦‚æœæˆåŠŸæ‰“å¼€ï¼ˆclaimedAmountä¸ä¸ºnullï¼‰
        if (claimedAmount !== null) {
            // **å…³é”®ï¼šåœ¨æ•°æ®æ›´æ–°åï¼Œå†é‡æ–°æ¸²æŸ“UI**
            renderChatInterface(currentChatId);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            await showCustomAlert("æ­å–œï¼", `ä½ é¢†å–äº† ${packet.senderName} çš„çº¢åŒ…ï¼Œé‡‘é¢ä¸º ${claimedAmount.toFixed(2)} å…ƒã€‚`);
        }

        // æ— è®ºæˆåŠŸä¸å¦ï¼Œæœ€åéƒ½æ˜¾ç¤ºè¯¦æƒ…é¡µ
        // æ­¤æ—¶éœ€è¦ä»stateä¸­è·å–æœ€æ–°çš„packetå¯¹è±¡ï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨handleOpenRedPacketä¸­è¢«æ›´æ–°äº†
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒã€‘å¤„ç†ç”¨æˆ·æ‰“å¼€çº¢åŒ…çš„é€»è¾‘ (V5 - ä¸“æ³¨äºæ•°æ®æ›´æ–°)
 */
async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 1. æ£€æŸ¥çº¢åŒ…æ˜¯å¦è¿˜èƒ½é¢†
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("æ‰‹æ…¢äº†", "çº¢åŒ…å·²è¢«é¢†å®Œï¼");
        return null; // è¿”å›nullè¡¨ç¤ºé¢†å–å¤±è´¥
    }
    
    // 2. è®¡ç®—é¢†å–é‡‘é¢
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // 3. æ›´æ–°çº¢åŒ…æ•°æ®
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    // 4. æ„å»ºç³»ç»Ÿæ¶ˆæ¯å’ŒAIæŒ‡ä»¤
    let hiddenMessageContent = isNowFullyClaimed
        ? `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) é¢†å–äº†æœ€åä¸€ä¸ªçº¢åŒ…ï¼Œç°åœ¨ ${packet.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œã€‚è¯·å¯¹æ­¤äº‹ä»¶å‘è¡¨è¯„è®ºã€‚]`
        : `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšé¢†å–äº†çº¢åŒ… (æ—¶é—´æˆ³: ${packet.timestamp})ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œï¼Œä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥å°è¯•é¢†å–ã€‚]`;

    const visibleMessage = { role: 'system', type: 'pat_message', content: `ä½ é¢†å–äº† ${packet.senderName} çš„çº¢åŒ…`, timestamp: Date.now() };
    const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
    chat.history.push(visibleMessage, hiddenMessage);

    // 5. ä¿å­˜åˆ°æ•°æ®åº“
    await db.chats.put(chat);
    
    // 6. è¿”å›é¢†å–çš„é‡‘é¢ï¼Œç”¨äºåç»­å¼¹çª—
    return claimedAmount;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºçº¢åŒ…é¢†å–è¯¦æƒ…çš„æ¨¡æ€æ¡† (V4 - å·²ä¿®å¤å‚æ•°é”™è¯¯)
 */
async function showRedPacketDetails(packet) {
    // 1. ç›´æ¥æ£€æŸ¥ä¼ å…¥çš„packetå¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œæ— éœ€å†æŸ¥æ‰¾
    if (!packet) {
        console.error("showRedPacketDetailsæ”¶åˆ°äº†æ— æ•ˆçš„packetå¯¹è±¡");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 2. åç»­æ‰€æœ‰é€»è¾‘ä¿æŒä¸å˜ï¼Œç›´æ¥ä½¿ç”¨ä¼ å…¥çš„packetå¯¹è±¡
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}ä¸ªçº¢åŒ…ï¼Œå…±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` å‰©ä½™çº¢åŒ…å°†åœ¨${timeLeft}å°æ—¶å†…é€€è¿˜ã€‚`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag">æ‰‹æ°”ç‹</span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} å…ƒ</span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// ç»‘å®šå…³é—­è¯¦æƒ…æŒ‰é’®çš„äº‹ä»¶
document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});

// ä¾›å…¨å±€è°ƒç”¨çš„å‡½æ•°ï¼Œä»¥ä¾¿çº¢åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
window.handlePacketClick = handlePacketClick;

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€åˆ›å»ºæŠ•ç¥¨çš„æ¨¡æ€æ¡†å¹¶åˆå§‹åŒ–
 */
function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    // é»˜è®¤åˆ›å»ºä¸¤ä¸ªç©ºçš„é€‰é¡¹æ¡†
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}

/**
 * åœ¨æ¨¡æ€æ¡†ä¸­åŠ¨æ€æ·»åŠ ä¸€ä¸ªé€‰é¡¹è¾“å…¥æ¡†
 */
function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="é€‰é¡¹å†…å®¹...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('æŠ•ç¥¨è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹ã€‚');
        }
    });
    
    container.appendChild(wrapper);
}

/**
 * ç”¨æˆ·ç¡®è®¤å‘èµ·æŠ•ç¥¨
 */
async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜ï¼');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); // è¿‡æ»¤æ‰ç©ºçš„é€‰é¡¹

    if (options.length < 2) {
        alert('è¯·è‡³å°‘è¾“å…¥2ä¸ªæœ‰æ•ˆçš„æŠ•ç¥¨é€‰é¡¹ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, // åˆå§‹æŠ•ç¥¨ä¸ºç©º
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤ç‚¹å‡»é—®é¢˜ã€‘çš„ç‰ˆæœ¬æ›¿æ¢ handleUserVote å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·æŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {string} choice - ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬
 */
async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œç›´æ¥è¿”å›
    if (!poll || poll.isClosed) {
        // å¦‚æœæ˜¯å·²å…³é—­çš„æŠ•ç¥¨ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºç»“æœ
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å·²ç»æŠ•è¿‡çš„åŒä¸€ä¸ªé€‰é¡¹
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœä¸æ˜¯é‡å¤ç‚¹å‡»ï¼Œæ‰æ‰§è¡ŒæŠ•ç¥¨é€»è¾‘
    if (!isReclickingSameOption) {
        // ç§»é™¤æ—§æŠ•ç¥¨ï¼ˆå¦‚æœç”¨æˆ·æ”¹é€‰ï¼‰
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        // æ·»åŠ æ–°æŠ•ç¥¨
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    // 4. ã€æ ¸å¿ƒé€»è¾‘ã€‘ç°åœ¨åªå¤„ç†ç”¨æˆ·æŠ•ç¥¨äº‹ä»¶ï¼Œä¸å†æ£€æŸ¥æ˜¯å¦ç»“æŸ
    let hiddenMessageContent = null; 
    
    // åªæœ‰åœ¨ç”¨æˆ·çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ—¶ï¼Œæ‰ç”Ÿæˆæç¤º
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšæŠ•ç¥¨ç»™äº† â€œ${choice}â€ã€‚]`;
    }

    // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ éšè—æ¶ˆæ¯
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    // 6. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ç”¨æˆ·ç»“æŸæŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("ç»“æŸæŠ•ç¥¨", "ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿç»“æŸåå°†æ— æ³•å†è¿›è¡ŒæŠ•ç¥¨ã€‚");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`).join('ï¼Œ');
        const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰‹åŠ¨ç»“æŸäº†æŠ•ç¥¨ï¼æœ€ç»ˆç»“æœä¸ºï¼š${resultSummary}ã€‚]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªä¿å­˜æ•°æ®å’Œæ›´æ–°UIï¼Œä¸è°ƒç”¨ triggerAiResponse()
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ˜¾ç¤ºæŠ•ç¥¨ç»“æœè¯¦æƒ…
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;">è¿˜æ²¡æœ‰äººæŠ•ç¥¨ã€‚</p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join('ã€ ') : 'æ— äººæŠ•ç¥¨'}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("æŠ•ç¥¨ç»“æœ", resultsHtml);
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
 */
function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `â€œ${chat.name}â€çš„å¤´åƒåº“`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“AIå¤´åƒåº“çš„å†…å®¹
 */
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block'; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒ', `ç¡®å®šè¦ä»å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * å‘å½“å‰AIçš„å¤´åƒåº“ä¸­æ·»åŠ æ–°å¤´åƒ
 */
async function addAvatarToLibrary() {
    const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
}

/**
 * å…³é—­AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
 */
function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ä¸¤ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å°†ä¿å­˜çš„å›¾æ ‡URLåº”ç”¨åˆ°ä¸»å±å¹•çš„Appå›¾æ ‡ä¸Š
 */
function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}

/**
 * ã€å…¨æ–°ã€‘åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appå›¾æ ‡çš„è®¾ç½®é¡¹
 */
function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = {
        'world-book': 'ä¸–ç•Œä¹¦',
        'qq': 'QQ',
        'api-settings': 'APIè®¾ç½®',
        'wallpaper': 'å£çº¸',
        'font': 'å­—ä½“'
    };

    for (const iconId in state.globalSettings.appIcons) {
        const iconUrl = state.globalSettings.appIcons[iconId];
        const labelText = appLabels[iconId] || 'æœªçŸ¥App';

        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        // ã€é‡è¦ã€‘æˆ‘ä»¬ç”¨ data-icon-id æ¥æ ‡è®°è¿™ä¸ªè®¾ç½®é¡¹å¯¹åº”å“ªä¸ªå›¾æ ‡
        item.dataset.iconId = iconId; 

        item.innerHTML = `
            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
            <button class="change-icon-btn">æ›´æ¢</button>
        `;
        grid.appendChild(item);
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆç¡®è®¤ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ openBrowser å’Œ closeBrowser å‡½æ•° â–¼â–¼â–¼

/**
 * å½“ç”¨æˆ·ç‚¹å‡»é“¾æ¥å¡ç‰‡æ—¶ï¼Œæ‰“å¼€ä¼ªæµè§ˆå™¨
 * @param {number} timestamp - è¢«ç‚¹å‡»æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿ chat å’Œ history éƒ½å­˜åœ¨
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error("æ— æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…çš„åˆ†äº«é“¾æ¥:", timestamp);
        return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥é€€å‡º
    }

    // å¡«å……æµè§ˆå™¨å†…å®¹
    document.getElementById('browser-title').textContent = message.source_name || 'æ–‡ç« è¯¦æƒ…';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || 'æ— æ ‡é¢˜'}</h1>
        <div class="article-meta">
            <span>æ¥æº: ${message.source_name || 'æœªçŸ¥'}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || 'å†…å®¹ä¸ºç©ºã€‚').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    // æ˜¾ç¤ºæµè§ˆå™¨å±å¹•
    showScreen('browser-screen');
}

/**
 * å…³é—­ä¼ªæµè§ˆå™¨ï¼Œè¿”å›èŠå¤©ç•Œé¢
 * (è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨)
 */
function closeBrowser() {
    showScreen('chat-interface-screen'); 
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€è®©ç”¨æˆ·å¡«å†™é“¾æ¥ä¿¡æ¯çš„æ¨¡æ€æ¡†
 */
function openShareLinkModal() {
    if (!state.activeChatId) return;

    // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥çš„å†…å®¹
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('share-link-modal').classList.add('visible');
}

/**
 * ç”¨æˆ·ç¡®è®¤åˆ†äº«ï¼Œåˆ›å»ºå¹¶å‘é€é“¾æ¥å¡ç‰‡æ¶ˆæ¯
 */
async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("æ ‡é¢˜æ˜¯å¿…å¡«é¡¹å“¦ï¼");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
    const linkMessage = {
        role: 'user', // è§’è‰²æ˜¯ 'user'
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        // ç”¨æˆ·åˆ†äº«çš„é“¾æ¥ï¼Œæˆ‘ä»¬ä¸æä¾›å›¾ç‰‡ï¼Œè®©å®ƒæ€»æ˜¯æ˜¾ç¤ºå ä½å›¾
        thumbnail_url: null 
    };

    // å°†æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    // æ¸²æŸ“æ–°æ¶ˆæ¯å¹¶æ›´æ–°åˆ—è¡¨
    appendMessage(linkMessage, chat);
    renderChatList();

    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('share-link-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * æ ¹æ®AIçš„è§†è§’ï¼Œè¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
 * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
 * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; // å®‰å…¨æ£€æŸ¥

    const viewerGroupId = viewerChat.groupId; // æŸ¥çœ‹è€…æ‰€åœ¨çš„åˆ†ç»„ID

    return allPosts.filter(post => {
        // è§„åˆ™1ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
        if (post.authorId === 'user') {
            // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶ï¼Œæ‰å¯è§
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®ï¼Œè¯´æ˜æ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è§
            return true;
        }

        // è§„åˆ™2ï¼šå¦‚æœæ˜¯å…¶ä»–AIå‘çš„åŠ¨æ€
        const authorGroupId = post.authorGroupId; // å‘å¸–AIæ‰€åœ¨çš„åˆ†ç»„ID
        
        // å¦‚æœå‘å¸–çš„AIæ²¡æœ‰åˆ†ç»„ï¼Œé‚£å®ƒçš„åŠ¨æ€å°±æ˜¯å…¬å¼€çš„
        if (!authorGroupId) {
            return true;
        }

        // å¦‚æœå‘å¸–çš„AIæœ‰åˆ†ç»„ï¼Œé‚£ä¹ˆåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†ç»„çš„AIæ‰èƒ½çœ‹åˆ°
        return authorGroupId === viewerGroupId;
    });
}

/**
 * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼ˆ'light' æˆ– 'dark'ï¼‰
 * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // å¦‚æœå¼€å…³å­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„çŠ¶æ€
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    localStorage.setItem('ephone-theme', theme);
}

/**
 * åˆ‡æ¢å½“å‰çš„ä¸»é¢˜
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘åŒæ—¶è·å–â€œå®Œæ•´å†…å®¹â€å’Œâ€œé¢„è§ˆç‰‡æ®µâ€
    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
        previewSnippet = '[è¡¨æƒ…]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
        previewSnippet = '[å›¾ç‰‡]';
    } else if (message.type === 'voice_message') {
        previewSnippet = '[è¯­éŸ³]';
    } else {
        // é¢„è§ˆç‰‡æ®µä¾ç„¶æˆªæ–­ï¼Œä½†åªç”¨äºUIæ˜¾ç¤º
        previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }
    
    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†â€œå®Œæ•´å†…å®¹â€å­˜å…¥ä¸Šä¸‹æ–‡ï¼Œä»¥å¤‡å‘é€æ—¶ä½¿ç”¨
    currentReplyContext = {
        timestamp: message.timestamp,
        senderName: message.senderName || (message.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
        content: fullContent, // <--- è¿™é‡Œå­˜çš„æ˜¯å®Œæ•´çš„åŸæ–‡ï¼
    };

    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘ä»…åœ¨æ›´æ–°â€œå›å¤é¢„è§ˆæ â€æ—¶ï¼Œæ‰ä½¿ç”¨â€œé¢„è§ˆç‰‡æ®µâ€
    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = `å›å¤ ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet; // <--- è¿™é‡Œç”¨çš„æ˜¯ç¼©ç•¥ç‰ˆï¼
    previewBar.style.display = 'block';

    // 4. åç»­æ“ä½œä¿æŒä¸å˜
    hideMessageActions();
    document.getElementById('chat-input').focus();
}

/**
 * ã€å…¨æ–°ã€‘å–æ¶ˆå¼•ç”¨æ¨¡å¼
 */
function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·å¤„ç†è½¬è´¦çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

let activeTransferTimestamp = null; // ç”¨äºæš‚å­˜è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³

/**
 * æ˜¾ç¤ºå¤„ç†è½¬è´¦çš„æ“ä½œèœå•
 * @param {number} timestamp - è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {
        // å°†AIçš„åå­—å¡«å…¥å¼¹çª—
        document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
}

/**
 * éšè—å¤„ç†è½¬è´¦çš„æ“ä½œèœå•
 */
function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
}

/**
 * å¤„ç†ç”¨æˆ·æ¥å—æˆ–æ‹’ç»è½¬è´¦çš„é€»è¾‘
 * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'declined'
 */
async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹è½¬è´¦æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;

    let systemContent;

    // 2. å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ‹’ç»â€
    if (choice === 'declined') {
        // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°
        const refundMessage = {
            role: 'user',
            type: 'transfer',
            isRefund: true, // è¿™æ˜¯ä¸€ä¸ªå…³é”®æ ‡è®°ï¼Œç”¨äºUIæ˜¾ç¤ºè¿™æ˜¯é€€æ¬¾
            amount: originalMessage.amount,
            note: 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦',
            timestamp: Date.now()
        };
        chat.history.push(refundMessage);
        
        // å‡†å¤‡ä¸€æ¡å¯¹AIå¯è§çš„éšè—æ¶ˆæ¯ï¼Œå‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
    } else { // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ¥å—â€
        // åªéœ€å‡†å¤‡éšè—æ¶ˆæ¯é€šçŸ¥AIå³å¯
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
    }

    // 3. åˆ›å»ºè¿™æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now() + 1, // ä¿è¯æ—¶é—´æˆ³åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å
        isHidden: true // è¿™ä¸ªæ ‡è®°ä¼šè®©å®ƒä¸åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º
    };
    chat.history.push(hiddenMessage);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“ï¼Œå¹¶åˆ·æ–°ç•Œé¢
    await db.chats.put(chat);
    hideTransferActionModal(); 
    renderChatInterface(state.activeChatId);
    renderChatList();
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

async function renderCallHistoryScreen() {
    showScreen('call-history-screen'); // <--ã€æ ¸å¿ƒä¿®æ­£ã€‘æŠŠå®ƒç§»åŠ¨åˆ°æœ€å‰é¢ï¼

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = 'æ‰€æœ‰é€šè¯è®°å½•';
    
    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
    
    if (records.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰é€šè¯è®°å½•å“¦~</p>';
        return; // ç°åœ¨çš„ return å°±æ²¡é—®é¢˜äº†ï¼Œå› ä¸ºå®ƒåªè·³è¿‡äº†åç»­çš„æ¸²æŸ“é€»è¾‘
    }
    
    records.forEach(record => {
        const card = createCallRecordCard(record);

    addLongPressListener(card, async () => {
        // 1. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œå¹¶å°†æ—§åç§°ä½œä¸ºé»˜è®¤å€¼ï¼Œæ–¹ä¾¿ä¿®æ”¹
        const newName = await showCustomPrompt(
            "è‡ªå®šä¹‰é€šè¯åç§°", 
            "è¯·è¾“å…¥æ–°çš„åç§°ï¼ˆç•™ç©ºåˆ™æ¢å¤é»˜è®¤ï¼‰",
            record.customName || '' // å¦‚æœå·²æœ‰è‡ªå®šä¹‰åç§°ï¼Œå°±æ˜¾ç¤ºå®ƒ
        );

        // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
        if (newName === null) return;
        
        // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½•
        await db.callRecords.update(record.id, { customName: newName.trim() });
        
        // 4. åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼Œè®©æ›´æ”¹ç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥
        await renderCallHistoryScreen();
        
        // 5. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
        await showCustomAlert('æˆåŠŸ', 'é€šè¯åç§°å·²æ›´æ–°ï¼');
    });
        listEl.appendChild(card);
    });    
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å‡çº§ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ createCallRecordCard å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å‡çº§ç‰ˆã€‘æ ¹æ®å•æ¡è®°å½•æ•°æ®ï¼Œåˆ›å»ºä¸€å¼ èƒ½æ˜¾ç¤ºèŠå¤©å¯¹è±¡çš„é€šè¯å¡ç‰‡
 * @param {object} record - ä¸€æ¡é€šè¯è®°å½•å¯¹è±¡
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡div
 */
function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id; 

    // è·å–é€šè¯å¯¹è±¡çš„åå­—
    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : 'æœªçŸ¥ä¼šè¯';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;

    const avatarsHtml = record.participants.map(p => 
        `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');
    
    card.innerHTML = `
        <div class="card-header">
            <span class="date">${dateString}</span>
            <span class="duration">${durationText}</span>
        </div>
        <div class="card-body">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªæ ‡é¢˜è¡Œ -->
            ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
            
            <div class="participants-info"> <!-- æ–°å¢ä¸€ä¸ªå®¹å™¨æ–¹ä¾¿å¸ƒå±€ -->
                <div class="participants-avatars">${avatarsHtml}</div>
                <span class="participants-names">ä¸ ${chatName}</span>
            </div>
        </div>
    `;
    return card;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ˜¾ç¤ºæŒ‡å®šé€šè¯è®°å½•çš„å®Œæ•´æ–‡å­—ç¨¿
 * @param {number} recordId - é€šè¯è®°å½•çš„ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('transcript-modal-body');

    titleEl.textContent = `é€šè¯äº ${new Date(record.timestamp).toLocaleString()} (æ—¶é•¿: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
    bodyEl.innerHTML = '';
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">è¿™æ¬¡é€šè¯æ²¡æœ‰ç•™ä¸‹æ–‡å­—è®°å½•ã€‚</p>';
    } else {
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            // æ ¹æ®è§’è‰²æ·»åŠ ä¸åŒçš„classï¼Œåº”ç”¨ä¸åŒçš„æ ·å¼
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const deleteBtn = document.getElementById('delete-transcript-btn');
    
    // ã€é‡è¦ã€‘ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œé˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    
    // ä¸ºæ–°çš„ã€å¹²å‡€çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // 1. å…³é—­å½“å‰çš„è¯¦æƒ…å¼¹çª—
            modal.classList.remove('visible');
            
            // 2. ä»æ•°æ®åº“åˆ é™¤
            await db.callRecords.delete(recordId);
            
            // 3. åˆ·æ–°é€šè¯è®°å½•åˆ—è¡¨
            await renderCallHistoryScreen();
            
            // 4. (å¯é€‰) ç»™å‡ºæˆåŠŸæç¤º
            alert('é€šè¯è®°å½•å·²åˆ é™¤ã€‚');
        }
    });
    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘æ›¿æ¢æ‰ä½ æ—§çš„ handleStatusResetClick å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»çŠ¶æ€æ ï¼Œå¼¹å‡ºç¼–è¾‘æ¡†è®©ç”¨æˆ·ä¿®æ”¹AIçš„å½“å‰çŠ¶æ€
 */
async function handleEditStatusClick() {
    // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿åœ¨å•èŠç•Œé¢
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        return; 
    }
    const chat = state.chats[state.activeChatId];

    // 2. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥æ–°çš„çŠ¶æ€ï¼Œå¹¶å°†å½“å‰çŠ¶æ€ä½œä¸ºé»˜è®¤å€¼
    const newStatusText = await showCustomPrompt(
        'ç¼–è¾‘å¯¹æ–¹çŠ¶æ€',
        'è¯·è¾“å…¥å¯¹æ–¹ç°åœ¨çš„æ–°çŠ¶æ€ï¼š',
        chat.status.text // å°†å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥æ¡†çš„é»˜è®¤å†…å®¹
    );

    // 3. å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»äº†â€œç¡®å®šâ€
    if (newStatusText !== null) {
        // 4. æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ä¸­çš„çŠ¶æ€æ•°æ®
        chat.status.text = newStatusText.trim() || 'åœ¨çº¿'; // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†ï¼Œå°±é»˜è®¤ä¸ºâ€œåœ¨çº¿â€
        chat.status.isBusy = false; // æ¯æ¬¡æ‰‹åŠ¨ç¼–è¾‘éƒ½é»˜è®¤å…¶ä¸å¤„äºâ€œå¿™ç¢Œâ€çŠ¶æ€
        chat.status.lastUpdate = Date.now();
        await db.chats.put(chat);

        // 5. ç«‹åˆ»åˆ·æ–°UIï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¿®æ”¹åçš„çŠ¶æ€
        renderChatInterface(state.activeChatId);
        renderChatList();
        
        // 6. ç»™å‡ºä¸€ä¸ªæ— ä¼¤å¤§é›…çš„æˆåŠŸæç¤º
        await showCustomAlert('çŠ¶æ€å·²æ›´æ–°', `â€œ${chat.name}â€çš„å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${chat.status.text}`);
    }
}

// æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº
async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';

    // è·å–æ‰€æœ‰èŠå¤©ä½œä¸ºåˆ†äº«ç›®æ ‡
    const chats = Object.values(state.chats);

    chats.forEach(chat => {
        // å¤ç”¨è”ç³»äººé€‰æ‹©å™¨çš„æ ·å¼
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
        if (callback) callback();
        return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
        document.getElementById('music-playlist-panel').classList.remove('visible');
        if (callback) callback();
    }, 400); 
}

function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = lrcContent.split('\n');
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
}

function updateLyricsUI() {
    const lyricsList = document.getElementById('music-lyrics-list');
    const container = document.getElementById('music-lyrics-container');
    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));
    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }
    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 3) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }
}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

function updateMusicProgressBar() {
    const currentTimeEl = document.getElementById('music-current-time');
    const totalTimeEl = document.getElementById('music-total-time');
    const progressFillEl = document.getElementById('music-progress-fill');
    if (!audioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
    updateActiveLyric(audioPlayer.currentTime);
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œæ’¤å›â€æŒ‰é’®çš„å…¥å£å‡½æ•°
 */
async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è®¾ç½®2åˆ†é’Ÿçš„æ’¤å›æ—¶é™
    const messageTime = activeMessageTimestamp;
    const now = Date.now();

    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡äº†æ’¤å›æ—¶é™
    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
        hideMessageActions();
        await showCustomAlert('æ“ä½œå¤±è´¥', 'è¯¥æ¶ˆæ¯å‘é€å·²è¶…è¿‡2åˆ†é’Ÿï¼Œæ— æ³•æ’¤å›ã€‚');
        return;
    }
    
    // å¦‚æœåœ¨æ—¶é™å†…ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ’¤å›é€»è¾‘
    await recallMessage(messageTime, true);
    hideMessageActions();
}

/**
 * ã€å…¨æ–°ã€‘æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé€»è¾‘
 * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨æ’¤å›
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    // 1. ä¿®æ”¹æ¶ˆæ¯å¯¹è±¡ï¼Œå°†å…¶å˜ä¸ºâ€œå·²æ’¤å›â€çŠ¶æ€
    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        // ä¿å­˜å…¶ä»–å¯èƒ½å­˜åœ¨çš„åŸå§‹æ•°æ®
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote 
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? 'ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯' : 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
    messageToRecall.recalledData = recalledData;
    // æ¸…ç†æ‰ä¸å†éœ€è¦çš„æ—§å±æ€§
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // 2. å¦‚æœæ˜¯ç”¨æˆ·æ’¤å›ï¼Œéœ€è¦ç»™AIå‘é€ä¸€æ¡å®ƒçœ‹ä¸æ‡‚å†…å®¹çš„éšè—æç¤º
    if (isUserRecall) {
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ã€‚ä½ ä¸çŸ¥é“å†…å®¹æ˜¯ä»€ä¹ˆï¼Œåªéœ€çŸ¥é“è¿™ä¸ªäº‹ä»¶å³å¯ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessageForAI);
    }

    // 3. ä¿å­˜åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    if(isUserRecall) renderChatList(); // ç”¨æˆ·æ’¤å›æ—¶ï¼Œæœ€åä¸€æ¡æ¶ˆæ¯å˜äº†ï¼Œéœ€è¦åˆ·æ–°åˆ—è¡¨
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°†è¿™äº›å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * æ‰“å¼€åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
 */
async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨æ¨¡æ€æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†ç±»åˆ—è¡¨
 */
async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
    }
    categories.forEach(cat => {
        // å¤ç”¨å¥½å‹åˆ†ç»„çš„æ ·å¼
        const item = document.createElement('div');
        item.className = 'existing-group-item'; 
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»
 */
async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼');
        return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
        alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
        return;
    }
    await db.worldBookCategories.add({ name });
    input.value = '';
    await renderCategoryListInManager();
}

/**
 * åˆ é™¤ä¸€ä¸ªä¸–ç•Œä¹¦åˆ†ç±»
 * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»çš„ID
 */
async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        'åˆ é™¤åˆ†ç±»åï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', 
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.worldBookCategories.delete(categoryId);
        // å°†å±äºè¯¥åˆ†ç±»çš„ä¸–ç•Œä¹¦çš„ categoryId è®¾ä¸º null
        const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
        for (const book of booksToUpdate) {
            book.categoryId = null;
            await db.worldBooks.put(book);
            const bookInState = state.worldBooks.find(wb => wb.id === book.id);
            if(bookInState) bookInState.categoryId = null;
        }
        await renderCategoryListInManager();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 4. åˆå§‹åŒ–å‡½æ•° init()
        // ===================================================================
        async function init() {

    // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„ã€æœ€å¼€å¤´ã€‘ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œä»£ç  â–¼â–¼â–¼
    const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // é»˜è®¤ä¸ºæ—¥é—´æ¨¡å¼
    applyTheme(savedTheme);
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²


    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();

            // åˆå§‹åŒ–æœªè¯»åŠ¨æ€è®¡æ•°
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            // â–²â–²â–² ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();

            // ==========================================================
            // --- å„ç§äº‹ä»¶ç›‘å¬å™¨ ---
            // ==========================================================

            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 

    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤©', 'è¯·è¾“å…¥Taçš„åå­—'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); 
const newChat = { 
    id: newChatId, 
    name: name.trim(), 
    isGroup: false,                         relationship: {
                            status: 'friend', // 'friend', 'blocked_by_user', 'pending_user_approval'
                            blockedTimestamp: null,
                            applicationReason: ''
                        },
                        status: {
                            text: 'åœ¨çº¿',
                            lastUpdate: Date.now(),
                            isBusy: false 
                        },
    settings: { 
        aiPersona: 'ä½ æ˜¯è°å‘€ã€‚', 
        myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', 
        maxMemory: 10, 
        aiAvatar: defaultAvatar, 
        myAvatar: defaultAvatar, 
        background: '', 
        theme: 'default', 
    fontSize: 13, 
    customCss: '', // <--- æ–°å¢è¿™è¡Œ
    linkedWorldBookIds: [], 
    aiAvatarLibrary: [],
    }, 
    history: [], 
    musicData: { totalTime: 0 } 
};
state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });

            // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘åˆ›å»ºç¾¤èŠæŒ‰é’®ç°åœ¨æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨ â–¼â–¼â–¼
document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²                      
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });

            const chatInput = document.getElementById('chat-input');
            // â–¼â–¼â–¼ æ‰¾åˆ° id="send-btn" çš„ click äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('send-btn').addEventListener('click', async () => { 
    const content = chatInput.value.trim(); 
    if (!content || !state.activeChatId) return; 
    
    const chat = state.chats[state.activeChatId]; 
    
    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ·»åŠ  ---
    const msg = { 
        role: 'user', 
        content, 
        timestamp: Date.now() 
    };

    // æ£€æŸ¥å½“å‰æ˜¯å¦å¤„äºå¼•ç”¨å›å¤æ¨¡å¼
    if (currentReplyContext) {
        msg.quote = currentReplyContext; // å°†å¼•ç”¨ä¿¡æ¯é™„åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸Š
    }
    // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---
    
    chat.history.push(msg); 
    await db.chats.put(chat); 
    appendMessage(msg, chat); 
    renderChatList(); 
    chatInput.value = ''; 
    chatInput.style.height = 'auto'; 
    chatInput.focus(); 
    
    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å‘é€åï¼Œå–æ¶ˆå¼•ç”¨æ¨¡å¼ ---
    cancelReplyMode(); 
});
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            // â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ save-wallpaper-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    let changesMade = false;

    // ä¿å­˜å£çº¸
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        changesMade = true;
    }

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¿å­˜å›¾æ ‡è®¾ç½®ï¼ˆå®ƒå·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ•´ä¸ªglobalSettingså­˜èµ·æ¥ï¼‰
    await db.globalSettings.put(state.globalSettings);

    // åº”ç”¨æ‰€æœ‰æ›´æ”¹
    if (changesMade) {
        applyGlobalWallpaper();
        newWallpaperBase64 = null;
    }
    applyAppIcons(); // é‡æ–°åº”ç”¨æ‰€æœ‰å›¾æ ‡

    alert('å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
    showScreen('home-screen');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); 

// åœ¨ 'save-api-settings-btn' çš„ click äº‹ä»¶ç›‘å¬å™¨å†…éƒ¨
// await db.apiConfig.put(state.apiConfig); è¿™è¡Œä¹‹å

// â–¼â–¼â–¼ å°†ä¹‹å‰é‚£æ®µä¿å­˜åå°æ´»åŠ¨è®¾ç½®çš„é€»è¾‘ï¼Œæ›¿æ¢ä¸ºä¸‹é¢è¿™ä¸ªå¢å¼ºç‰ˆ â–¼â–¼â–¼

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// åªæœ‰åœ¨ç”¨æˆ·â€œä»å…³åˆ°å¼€â€æ—¶ï¼Œæ‰å¼¹å‡ºè­¦å‘Š
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "ã€é«˜è´¹ç”¨è­¦å‘Šã€‘\n\n" +
        "æ‚¨æ­£åœ¨å¯ç”¨â€œåå°è§’è‰²æ´»åŠ¨â€åŠŸèƒ½ã€‚\n\n" +
        "è¿™ä¼šä½¿æ‚¨çš„AIè§’è‰²ä»¬åœ¨æ‚¨ä¸å’Œä»–ä»¬èŠå¤©æ—¶ï¼Œä¹Ÿèƒ½â€œç‹¬ç«‹æ€è€ƒâ€å¹¶ä¸»åŠ¨ç»™æ‚¨å‘æ¶ˆæ¯æˆ–è¿›è¡Œç¤¾äº¤äº’åŠ¨ï¼Œæå¤§åœ°å¢å¼ºæ²‰æµ¸æ„Ÿã€‚\n\n" +
        "ä½†è¯·æ³¨æ„ï¼š\n" +
        "è¿™ä¼šã€åœ¨åå°è‡ªåŠ¨ã€å®šæœŸåœ°è°ƒç”¨APIã€‘ï¼Œå³ä½¿æ‚¨ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ®æ‚¨çš„è§’è‰²æ•°é‡å’Œæ£€æµ‹é—´éš”ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„APIè´¹ç”¨æ˜¾è‘—å¢åŠ ã€‚\n\n" +
        "æ‚¨ç¡®å®šè¦å¼€å¯å—ï¼Ÿ"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // ç”¨æˆ·å–æ¶ˆï¼ŒæŠŠå¼€å…³æ‹¨å›å»
        return; // é˜»æ­¢åç»­é€»è¾‘
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);

// åŠ¨æ€å¯åŠ¨æˆ–åœæ­¢æ¨¡æ‹Ÿå™¨
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨ï¼Œé—´éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
} else {
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

alert('APIè®¾ç½®å·²ä¿å­˜!'); });

                    // gemini å¯†é’¥èšç„¦çš„æ—¶å€™æ˜¾ç¤ºæ˜æ–‡
        const ApiKeyInput = document.getElementById('api-key')
        ApiKeyInput.addEventListener('focus', (e) => {
            e.target.setAttribute('type', 'text')
        })
        ApiKeyInput.addEventListener('blur', (e) => {
            e.target.setAttribute('type', 'password')
        })


        document.getElementById('fetch-models-btn').addEventListener('click', async () => {
            const url = document.getElementById('proxy-url').value.trim();
            const key = document.getElementById('api-key').value.trim();
            if (!url || !key) return alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥');
            try {

                let  isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`,isGemini ? undefined : {headers: {'Authorization': `Bearer ${key}`}});
                if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨');
                const data = await response.json();
                let models = isGemini ? data.models : data.data;
                if(isGemini){
                    models = models.map((model)=>{
                        const parts = model.name.split('/');
                        return {
                            id:parts.length > 1 ? parts[1] : model.name
                        }
                    })
                }
                const modelSelect = document.getElementById('model-select');
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === state.apiConfig.model) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
            } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
            }
        });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©ºï¼'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; 

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œä¿å­˜åˆ†ç±»ID â–¼â–¼â–¼
        const categoryId = document.getElementById('world-book-category-select').value;
        // å¦‚æœé€‰æ‹©äº†â€œæœªåˆ†ç±»â€ï¼Œå­˜å…¥ nullï¼›å¦åˆ™å­˜å…¥æ•°å­—ID
        book.categoryId = categoryId ? parseInt(categoryId) : null; 
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('ç…§ç‰‡æè¿°', description); return; }  });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');

function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }        
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å®Œæ•´ã€å…¨æ–°çš„ä»£ç ã€‘æ›¿æ¢æ—§çš„ chat-settings-btn ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;

    // --- ç»Ÿä¸€æ˜¾ç¤º/éšè—æ§ä»¶ ---
    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—â€œå¥½å‹åˆ†ç»„â€åŒºåŸŸ
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // --- åŠ è½½è¡¨å•æ•°æ® ---
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        
        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¦‚æœæ˜¯å•èŠï¼Œå°±åŠ è½½åˆ†ç»„åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">æœªåˆ†ç»„</option>'; // æ¸…ç©ºå¹¶è®¾ç½®é»˜è®¤é€‰é¡¹
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            // å¦‚æœå½“å‰å¥½å‹å·²ç»æœ‰åˆ†ç»„ï¼Œå°±é»˜è®¤é€‰ä¸­å®ƒ
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        }); 
    }
    
    // åŠ è½½ä¸–ç•Œä¹¦
// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€å…¨æ–°é€»è¾‘ã€‘æ›¿æ¢æ‰åŸæ¥ç®€å•çš„ forEach å¾ªç¯ â–¼â–¼â–¼

const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
worldBookCheckboxesContainer.innerHTML = '';
const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);

// 1. è·å–æ‰€æœ‰åˆ†ç±»å’Œä¸–ç•Œä¹¦
const categories = await db.worldBookCategories.toArray();
const books = state.worldBooks;

// ã€æ ¸å¿ƒæ”¹é€ ã€‘å¦‚æœå­˜åœ¨æœªåˆ†ç±»çš„ä¹¦ç±ï¼Œå°±åˆ›å»ºä¸€ä¸ªâ€œè™šæ‹Ÿåˆ†ç±»â€
const hasUncategorized = books.some(book => !book.categoryId);
if (hasUncategorized) {
    categories.push({ id: 'uncategorized', name: 'æœªåˆ†ç±»' });
}

// 2. å°†ä¹¦ç±æŒ‰åˆ†ç±»IDè¿›è¡Œåˆ†ç»„
const booksByCategoryId = books.reduce((acc, book) => {
    const categoryId = book.categoryId || 'uncategorized';
    if (!acc[categoryId]) {
        acc[categoryId] = [];
    }
    acc[categoryId].push(book);
    return acc;
}, {});

// 3. éå†åˆ†ç±»ï¼Œåˆ›å»ºå¸¦æŠ˜å åŠŸèƒ½çš„åˆ—è¡¨
categories.forEach(category => {
    const booksInCategory = booksByCategoryId[category.id] || [];
    if (booksInCategory.length > 0) {
        const allInCategoryChecked = booksInCategory.every(book => linkedIds.has(book.id));
        
        const header = document.createElement('div');
        header.className = 'wb-category-header';
        header.innerHTML = `
            <span class="arrow">â–¼</span>
            <input type="checkbox" class="wb-category-checkbox" data-category-id="${category.id}" ${allInCategoryChecked ? 'checked' : ''}>
            <span>${category.name}</span>
        `;
        
        const bookContainer = document.createElement('div');
        bookContainer.className = 'wb-book-container';
        bookContainer.dataset.containerFor = category.id;

        booksInCategory.forEach(book => {
            const isChecked = linkedIds.has(book.id);
            const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${book.id}" data-parent-category="${category.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
    bookContainer.appendChild(label);
});

        // --- â˜… æ ¸å¿ƒä¿®æ”¹ #1 åœ¨è¿™é‡Œ â˜… ---
        // é»˜è®¤å°†åˆ†ç±»è®¾ç½®ä¸ºæŠ˜å çŠ¶æ€
        header.classList.add('collapsed');
        bookContainer.classList.add('collapsed');
        // --- â˜… ä¿®æ”¹ç»“æŸ â˜… ---

        worldBookCheckboxesContainer.appendChild(header);
        worldBookCheckboxesContainer.appendChild(bookContainer);
    }
});

updateWorldBookSelectionDisplay(); // æ›´æ–°é¡¶éƒ¨çš„å·²é€‰æ•°é‡æ˜¾ç¤º

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ updateWorldBookSelectionDisplay(); çš„ä¸‹ä¸€è¡Œï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰ç‚¹å‡»å’Œå‹¾é€‰äº‹ä»¶ï¼Œæ•ˆç‡æ›´é«˜
worldBookCheckboxesContainer.addEventListener('click', (e) => {
    const header = e.target.closest('.wb-category-header');
    if (header && !e.target.matches('input[type="checkbox"]')) {
        const categoryId = header.querySelector('.wb-category-checkbox')?.dataset.categoryId;
        // ã€ä¿®æ”¹ã€‘ç°åœ¨ categoryId å¯èƒ½æ˜¯æ•°å­—ï¼Œä¹Ÿå¯èƒ½æ˜¯ "uncategorized" å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¿™ä¸ªåˆ¤æ–­èƒ½é€šè¿‡äº†ï¼
        if (categoryId) { // <-- æŠŠåŸæ¥çš„ !categoryId return; æ”¹æˆè¿™æ ·
            const bookContainer = worldBookCheckboxesContainer.querySelector(`.wb-book-container[data-container-for="${categoryId}"]`);
            if (bookContainer) {
                header.classList.toggle('collapsed');
                bookContainer.classList.toggle('collapsed');
            }
        }
    }
});

worldBookCheckboxesContainer.addEventListener('change', (e) => {
    const target = e.target;
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ†ç±»çš„â€œå…¨é€‰â€å¤é€‰æ¡†
    if (target.classList.contains('wb-category-checkbox')) {
        const categoryId = target.dataset.categoryId;
        const isChecked = target.checked;
        // æ‰¾åˆ°è¿™ä¸ªåˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¹¦ç±å¤é€‰æ¡†ï¼Œå¹¶å°†å®ƒä»¬çš„çŠ¶æ€è®¾ç½®ä¸ºä¸åˆ†ç±»å¤é€‰æ¡†ä¸€è‡´
        const bookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
        bookCheckboxes.forEach(cb => cb.checked = isChecked);
    }
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯å•ä¸ªä¹¦ç±çš„å¤é€‰æ¡†
    if (target.classList.contains('wb-book-checkbox')) {
        const categoryId = target.dataset.parentCategory;
        if (categoryId) { // æ£€æŸ¥å®ƒæ˜¯å¦å±äºä¸€ä¸ªåˆ†ç±»
            const categoryCheckbox = worldBookCheckboxesContainer.querySelector(`input.wb-category-checkbox[data-category-id="${categoryId}"]`);
            const allBookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
            // æ£€æŸ¥è¯¥åˆ†ç±»ä¸‹æ˜¯å¦æ‰€æœ‰ä¹¦ç±éƒ½è¢«é€‰ä¸­äº†
            const allChecked = Array.from(allBookCheckboxes).every(cb => cb.checked);
            // åŒæ­¥åˆ†ç±»â€œå…¨é€‰â€å¤é€‰æ¡†çš„çŠ¶æ€
            categoryCheckbox.checked = allChecked;
        }
    }
    
    // æ¯æ¬¡å˜æ›´åéƒ½æ›´æ–°é¡¶éƒ¨çš„å·²é€‰æ•°é‡æ˜¾ç¤º
    updateWorldBookSelectionDisplay();
});

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

    // åŠ è½½å¹¶æ›´æ–°æ‰€æœ‰é¢„è§ˆç›¸å…³æ§ä»¶
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 
    document.getElementById('chat-settings-modal').classList.add('visible');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
function renderGroupMemberSettings(members) { 
    const container = document.getElementById('group-members-settings'); 
    container.innerHTML = ''; 
    members.forEach(member => { 
        const div = document.createElement('div'); 
        div.className = 'member-editor'; 
        div.dataset.memberId = member.id; 
        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
        // æ˜¾ç¤ºçš„æ˜¯ groupNickname
        div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`; 
        div.addEventListener('click', () => openMemberEditor(member.id)); 
        container.appendChild(div); 
    }); 
}

function openMemberEditor(memberId) { 
    editingMemberId = memberId; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === memberId); 
    document.getElementById('member-name-input').value = member.groupNickname; 
    document.getElementById('member-persona-input').value = member.persona; 
    document.getElementById('member-avatar-preview').src = member.avatar; 
    document.getElementById('member-settings-modal').classList.add('visible'); 
}
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { 
    if (!editingMemberId) return; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === editingMemberId); 
    
    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    const newNickname = document.getElementById('member-name-input').value.trim();
    if (!newNickname) {
        alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    member.groupNickname = newNickname; // åªä¿®æ”¹ç¾¤æ˜µç§°
    member.persona = document.getElementById('member-persona-input').value; 
    member.avatar = document.getElementById('member-avatar-preview').src; 
    
    renderGroupMemberSettings(chat.members); 
    document.getElementById('member-settings-modal').classList.remove('visible'); 
});
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼');
    chat.name = newName;
    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input.wb-book-checkbox:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("æ·»åŠ è¡¨æƒ…(URL)", "è¯·è¾“å…¥è¡¨æƒ…åŒ…çš„å›¾ç‰‡URL"); if (!url || !url.trim().startsWith('http')) return url && alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URL (ä»¥httpå¼€å¤´)"); const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); }; event.target.value = null; });

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
const waimaiModal = document.getElementById('waimai-request-modal');
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
    waimaiModal.classList.remove('visible');
});

document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo) {
        alert('è¯·è¾“å…¥å•†å“ä¿¡æ¯ï¼');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»£ä»˜é‡‘é¢ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œè·å–ç”¨æˆ·è‡ªå·±çš„æ˜µç§°
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const msg = {
        role: 'user',
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†è·å–åˆ°çš„æ˜µç§°ï¼Œä½œä¸º senderName æ·»åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸­
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});         
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);

// â–¼â–¼â–¼ ã€æœ€ç»ˆåŠ å¼ºç‰ˆã€‘ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„ selection-delete-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿè¿™å°†æ”¹å˜AIçš„è®°å¿†ã€‚`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. ã€æ ¸å¿ƒåŠ å¼ºã€‘åœ¨åˆ é™¤å‰ï¼Œæ£€æŸ¥è¢«åˆ é™¤çš„æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«æŠ•ç¥¨
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`å…³äºâ€œ${msg.question}â€çš„æŠ•ç¥¨(æ—¶é—´æˆ³: ${msg.timestamp})`);
            }
        }
        
        // 2. æ›´æ–°åç«¯çš„å†å²è®°å½•
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        // 3. ã€æ ¸å¿ƒåŠ å¼ºã€‘æ„å»ºæ›´å…·ä½“çš„â€œé—å¿˜æŒ‡ä»¤â€
        let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ç”¨æˆ·åˆ é™¤ã€‚";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š${deletedPollsInfo.join('ï¼›')}ã€‚`;
        }
        forgetReason += " ä½ åº”è¯¥åƒå®ƒä»¬ä»æœªå­˜åœ¨è¿‡ä¸€æ ·ç»§ç»­å¯¹è¯ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„è®°å¿†å’Œè¡Œä¸ºï¼Œä¸è¦å†æåŠè¿™äº›è¢«åˆ é™¤çš„å†…å®¹ã€‚";

        const forgetInstruction = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼š${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        // 4. å°†åŒ…å«â€œé—å¿˜æŒ‡ä»¤â€çš„ã€æ›´æ–°åçš„chatå¯¹è±¡å­˜å›æ•°æ®åº“
        await db.chats.put(chat);
        
        // 5. æœ€åæ‰æ›´æ–°UI
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => {
                const newFontUrl = fontUrlInput.value.trim();
                if (!newFontUrl) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚"); return; }
                applyCustomFont(newFontUrl, false);
                state.globalSettings.fontUrl = newFontUrl;
                await db.globalSettings.put(state.globalSettings);
                alert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
            });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

// â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œè¯´è¯´â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œè¯´è¯´â€æ¨¡å¼
    modal.dataset.mode = 'shuoshuo';
    
    // 3. éšè—ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    
    // 4. ä¿®æ”¹ä¸»è¾“å…¥æ¡†çš„æç¤ºè¯­ï¼Œä½¿å…¶æ›´ç¬¦åˆâ€œè¯´è¯´â€çš„åœºæ™¯
    modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...';
    
    // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
    }
    modal.classList.add('visible');
});

// â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œåŠ¨æ€â€ï¼ˆå›¾ç‰‡ï¼‰æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('create-post-btn').addEventListener('click', async () => {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œå¤æ‚åŠ¨æ€â€æ¨¡å¼
    modal.dataset.mode = 'complex';
    
// 3. ç¡®ä¿ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†æ˜¯å¯è§çš„
modal.querySelector('.post-mode-switcher').style.display = 'flex';
// æ˜¾å¼æ¿€æ´»â€œä¸Šä¼ å›¾ç‰‡â€æ¨¡å¼...
modal.querySelector('#image-mode-content').classList.add('active');
// ...åŒæ—¶ç¡®ä¿â€œæ–‡å­—å›¾â€æ¨¡å¼æ˜¯éšè—çš„
modal.querySelector('#text-image-mode-content').classList.remove('active');
    
    // 4. æ¢å¤ä¸»è¾“å…¥æ¡†çš„é»˜è®¤æç¤ºè¯­
    modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰';

    // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆä¸â€œè¯´è¯´â€æŒ‰é’®çš„é€»è¾‘ç›¸åŒï¼‰
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
    }
    modal.classList.add('visible');
});
            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼');
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ photos-grid-page ç›‘å¬å™¨ â†“â†“â†“ ---

document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å›¾ç‰‡ä¸Š
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'åˆ é™¤ç…§ç‰‡',
            'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ç…§ç‰‡å·²åˆ é™¤ã€‚');
        }
    } 
    else if (photoThumb) {
        // è¿™å°±æ˜¯æ¢å¤çš„å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½ï¼
        openPhotoViewer(photoThumb.src);
    }
});

// æ¢å¤å›¾ç‰‡æŸ¥çœ‹å™¨çš„æ§åˆ¶äº‹ä»¶
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// æ¢å¤é”®ç›˜å·¦å³ç®­å¤´å’ŒESCé”®çš„åŠŸèƒ½
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("åˆ›å»ºæ–°ç›¸å†Œ", "è¯·è¾“å…¥ç›¸å†Œåç§°"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Œ "${albumName}" åˆ›å»ºæˆåŠŸï¼`); } else if (albumName !== null) { alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©ºï¼"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æ¥", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„â€œå‘å¸ƒâ€æŒ‰é’®äº‹ä»¶ï¼Œå·²ä¿®å¤æƒé™æ¼æ´ â–¼â–¼â–¼
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;
    
    // --- 1. è·å–é€šç”¨çš„å¯è§æ€§è®¾ç½® ---
    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    
    if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
    }

    let newPost = {};
    const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',
        // ã€é‡è¦ã€‘åœ¨è¿™é‡Œå°±æŠŠæƒé™ä¿¡æ¯å­˜å¥½
        visibleGroupIds: visibleGroupIds,
    };

    // --- 2. æ ¹æ®æ¨¡å¼æ„å»ºä¸åŒçš„ post å¯¹è±¡ ---
    if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
            alert('è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
            return;
        }
        newPost = {
            ...basePostData,
            type: 'shuoshuo',
            content: content,
        };

    } else { // å¤„ç† 'complex' æ¨¡å¼ (å›¾ç‰‡/æ–‡å­—å›¾)
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
            const imageUrl = document.getElementById('post-image-preview').src;
            const imageDescription = document.getElementById('post-image-description').value.trim();
            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                alert('è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦ï¼');
                return;
            }
            if (!imageDescription) {
                alert('è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°ï¼ˆå¿…å¡«ï¼Œç»™AIçœ‹çš„ï¼‰ï¼');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'image_post',
                publicText: publicText,
                imageUrl: imageUrl,
                imageDescription: imageDescription,
            };
        } else { // æ–‡å­—å›¾æ¨¡å¼
            const hiddenText = document.getElementById('post-hidden-text').value.trim();
            if (!hiddenText) {
                alert('è¯·è¾“å…¥æ–‡å­—å›¾æè¿°ï¼');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'text_image',
                publicText: publicText,
                hiddenContent: hiddenText,
            };
        }
    }

    // --- 3. ä¿å­˜åˆ°æ•°æ®åº“ ---
    const newPostId = await db.qzonePosts.add(newPost);
    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

    // --- 4. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¸¦æœ‰æƒé™æ£€æŸ¥çš„é€šçŸ¥å¾ªç¯ ---
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue; // è·³è¿‡ç¾¤èŠ

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;

        // åˆ¤æ–­æ¡ä»¶1ï¼šå¦‚æœåŠ¨æ€æ˜¯å…¬å¼€çš„ (æ²¡æœ‰è®¾ç½®ä»»ä½•å¯è§åˆ†ç»„)
        if (!postVisibleGroups || postVisibleGroups.length === 0) {
            shouldNotify = true;
        } 
        // åˆ¤æ–­æ¡ä»¶2ï¼šå¦‚æœåŠ¨æ€è®¾ç½®äº†éƒ¨åˆ†å¯è§ï¼Œå¹¶ä¸”å½“å‰è§’è‰²åœ¨å¯è§åˆ†ç»„å†…
        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
            shouldNotify = true;
        }

        // åªæœ‰æ»¡è¶³æ¡ä»¶çš„è§’è‰²æ‰ä¼šè¢«é€šçŸ¥
        if (shouldNotify) {
            const historyMessage = {
                role: 'system',
                content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå‘å¸ƒäº†ä¸€æ¡åŠ¨æ€(ID: ${newPostId})ï¼Œå†…å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚ä½ ç°åœ¨å¯ä»¥å¯¹è¿™æ¡åŠ¨æ€è¿›è¡Œè¯„è®ºäº†ã€‚]`,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    // --- ä¿®æ­£ç»“æŸ ---

    await renderQzonePosts();
    modal.classList.remove('visible');
    alert('åŠ¨æ€å‘å¸ƒæˆåŠŸï¼');
});

// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘åŒ…å«æ‰€æœ‰æ»‘åŠ¨å’Œç‚¹å‡»äº‹ä»¶çš„å®Œæ•´ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„ postsList äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;

    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
        swipeState.isClick = false;
    }

    if (swipeState.swipeDirection === null) {
        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
            if (absDiffX > absDiffY) {
                swipeState.swipeDirection = 'horizontal';
            } else {
                swipeState.swipeDirection = 'vertical';
            }
        }
    }
    if (swipeState.swipeDirection === 'vertical') {
        handleSwipeEnd(e);
        return;
    }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (swipeState.isClick) {
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';

    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;

    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
        postItem.classList.add('swiped');
        postItem.style.transform = '';
    } else {
        postItem.classList.remove('swiped');
        postItem.style.transform = '';
    }

    swipeState.isDragging = false;
    swipeState.startX = 0;
    swipeState.startY = 0;
    swipeState.currentX = 0;
    swipeState.activeContainer = null;
    swipeState.swipeDirection = null;
    swipeState.isClick = true;
};

// --- ç»‘å®šæ‰€æœ‰æ»‘åŠ¨äº‹ä»¶ ---
postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
postsList.addEventListener('touchend', handleSwipeEnd);

// --- ç»‘å®šæ‰€æœ‰ç‚¹å‡»äº‹ä»¶ ---
postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;

    // --- æ–°å¢ï¼šå¤„ç†è¯„è®ºåˆ é™¤æŒ‰é’® ---
    if (target.classList.contains('comment-delete-btn')) {
        const postContainer = target.closest('.qzone-post-container');
        if (!postContainer) return;

        const postId = parseInt(postContainer.dataset.postId);
        const commentIndex = parseInt(target.dataset.commentIndex);
        if (isNaN(postId) || isNaN(commentIndex)) return;

        const post = await db.qzonePosts.get(postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;

        const commentText = post.comments[commentIndex].text;
        const confirmed = await showCustomConfirm(
            'åˆ é™¤è¯„è®º',
            `ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`,
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // ä»æ•°ç»„ä¸­ç§»é™¤è¯¥è¯„è®º
            post.comments.splice(commentIndex, 1);
            // æ›´æ–°æ•°æ®åº“
            await db.qzonePosts.update(postId, { comments: post.comments });
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥åæ˜ æ›´æ”¹
            await renderQzonePosts();
            alert('è¯„è®ºå·²åˆ é™¤ã€‚');
        }
        return; // å¤„ç†å®Œåç›´æ¥è¿”å›
    }

    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) {
            showPostActions(parseInt(container.dataset.postId));
        }
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-container');
        if (!container) return;
        
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;

        const confirmed = await showCustomConfirm('åˆ é™¤åŠ¨æ€', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });

        if (confirmed) {
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
        
            setTimeout(async () => {
                 await db.qzonePosts.delete(postIdToDelete);
                 
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) {
                         await db.chats.put(chat);
                     }
                 }
                 await renderQzonePosts();
                 alert('åŠ¨æ€å·²åˆ é™¤ã€‚');
            }, 300);
        }
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸï¼');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];
        post.comments.push({ commenterName: state.qzoneSettings.nickname, text: commentText, timestamp: Date.now() });
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                chat.history.push({ role: 'system', content: `[ç³»ç»Ÿæç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨IDä¸º${postId}çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®ºï¼šâ€œ${commentText}â€]`, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        commentInput.value = '';
        await renderQzonePosts();
        return;
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼

            // ç»‘å®šåŠ¨æ€é¡µå’Œæ”¶è—é¡µçš„è¿”å›æŒ‰é’®
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ£€æŸ¥å¹¶ç¡®ä¿ä½ æœ‰è¿™æ®µå®Œæ•´çš„ä»£ç  â–¼â–¼â–¼

            // æ”¶è—é¡µæœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // æ§åˆ¶æ¸…é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰
                    return;
                }

                // ç­›é€‰é€»è¾‘
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // åŒæ—¶æœç´¢å†…å®¹å’Œä½œè€…ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            // â–²â–²â–² ä»£ç æ£€æŸ¥ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            
            // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶
                        // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®æ­£)
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // è¿™æ˜¯æ”¶è—æ“ä½œå‘ç”Ÿçš„æ—¶é—´
                                originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°æ–°å­—æ®µ
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨å±€æ”¶è—ç¼“å­˜
                    await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¡æ¶ˆæ¯ã€‚`);
                } else {
                    await showCustomAlert('æç¤º', 'é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚');
                }
                
                exitSelectionMode();
            });

            // æ”¶è—é¡µé¢çš„"ç¼–è¾‘"æŒ‰é’®äº‹ä»¶ (å·²ä¿®æ­£)
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 
            const favoritesList = document.getElementById('favorites-list'); // è·å–æ”¶è—åˆ—è¡¨
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // --- è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'å®Œæˆ';
                    favoritesActionBar.style.display = 'block'; // æ˜¾ç¤ºåˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢ï¼šéšè—ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢ï¼šç»™åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé—´
                } else {
                    // --- é€€å‡ºç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'ç¼–è¾‘';
                    favoritesActionBar.style.display = 'none'; // éšè—åˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢ï¼šæ¢å¤ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢ï¼šæ¢å¤åˆ—è¡¨é»˜è®¤padding

                    // é€€å‡ºæ—¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (0)`;
                }
            });

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—åˆ—è¡¨çš„ç‚¹å‡»é€‰æ‹©äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // ã€æ–°å¢ã€‘å¤„ç†æ–‡å­—å›¾ç‚¹å‡»ï¼Œè¿™æ®µé€»è¾‘è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è¯ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
        return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œä¸ç»§ç»­æ‰§è¡Œé€‰æ‹©é€»è¾‘
    }
    
    // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼ï¼Œåˆ™ä¸æ‰§è¡Œåç»­çš„é€‰æ‹©æ“ä½œ
    if (!isFavoritesSelectionMode) return;

    // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é€‰æ‹©é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // æ›´æ–°åº•éƒ¨åˆ é™¤æŒ‰é’®çš„è®¡æ•°
    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (${selectedFavorites.size})`;
});

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—é¡µé¢æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        `ç¡®å®šè¦ä»æ”¶è—å¤¹ä¸­ç§»é™¤è¿™ ${selectedFavorites.size} æ¡å†…å®¹å—ï¼Ÿ`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('åˆ é™¤æˆåŠŸ', 'é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»å‰ç«¯ç¼“å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆ é™¤çš„é¡¹
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displayFilteredFavorites(allFavoriteItems);
        
        // æœ€åï¼Œå†é€€å‡ºç¼–è¾‘æ¨¡å¼
        favoritesEditBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
    }
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„æ­£ç¡®ä»£ç ã€‘è¯·ç²˜è´´è¿™æ®µä»£ç åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

// --- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å½±å“é¢„è§ˆçš„æ§ä»¶çš„äº‹ä»¶ ---

// 1. ç›‘å¬ä¸»é¢˜é€‰æ‹©
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});

// 2. ç›‘å¬å­—ä½“å¤§å°æ»‘å—
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. å®æ—¶æ›´æ–°æ•°å€¼æ˜¾ç¤º
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    // b. æ›´æ–°é¢„è§ˆ
    updateSettingsPreview();
});

// 3. ç›‘å¬è‡ªå®šä¹‰CSSè¾“å…¥æ¡†
const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);

// 4. ç›‘å¬é‡ç½®æŒ‰é’®
document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // åˆ·æ–°èŠå¤©è®¾ç½®é‡Œçš„åˆ†ç»„åˆ—è¡¨
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); // å†æ¬¡ç‚¹å‡»ä»¥é‡æ–°æ‰“å¼€
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
// æ¶ˆæ¯æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
// â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ä½¿ç”¨æ–°çš„ç¼–è¾‘å™¨å…¥å£ â–¼â–¼â–¼
document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€ä¿®æ­£åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ select-message-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('select-message-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨å…³é—­èœå•å‰ï¼Œå…ˆæ•è·æ—¶é—´æˆ³
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    // ä½¿ç”¨æ•è·åˆ°çš„å€¼
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼

// åŠ¨æ€æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘è”ç³»äººé€‰æ‹©å™¨äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç»‘å®šâ€œç®¡ç†ç¾¤æˆå‘˜â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('manage-members-btn').addEventListener('click', () => {
    // åœ¨åˆ‡æ¢å±å¹•å‰ï¼Œå…ˆéšè—å½“å‰çš„èŠå¤©è®¾ç½®å¼¹çª—
    document.getElementById('chat-settings-modal').classList.remove('visible');
    // ç„¶åå†æ‰“å¼€æˆå‘˜ç®¡ç†å±å¹•
    openMemberManagementScreen();
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆå®Œæ•´ç‰ˆã€‘ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('member-management-list').addEventListener('click', (e) => {
    // ã€å·²æ¢å¤ã€‘ç§»é™¤æˆå‘˜çš„äº‹ä»¶
    if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
    }
});

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    // ã€å·²æ¢å¤ã€‘ä»å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
    // ã€å…³é”®ã€‘ä¸ºâ€œå®Œæˆâ€æŒ‰é’®ç»‘å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é€»è¾‘
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æ–¹æ³•æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// ç»‘å®šå•èŠå’Œç¾¤èŠçš„å‘èµ·æŒ‰é’®
document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

// ç»‘å®šâ€œæŒ‚æ–­â€æŒ‰é’®
document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

// ç»‘å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰é’®
document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});

// ã€å…¨æ–°ã€‘ç»‘å®šâ€œåŠ å…¥é€šè¯â€æŒ‰é’®
document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤å¹¶æ¿€æ´»æ—è§‚æ¨¡å¼ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ decline-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ‹’ç»â€æŒ‰é’®
document.getElementById('decline-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ‹’ç»çš„é€»è¾‘ä¸APIè°ƒç”¨è¿æ¥èµ·æ¥
    if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false; // æ ‡è®°ç”¨æˆ·ä¸ºæ—è§‚è€…
        
        // 1. åˆ›å»ºä¸€æ¡éšè—æ¶ˆæ¯ï¼Œé€šçŸ¥AIç”¨æˆ·æ‹’ç»äº†
        const systemNote = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‹’ç»äº†é€šè¯é‚€è¯·ï¼Œä½†ä½ ä»¬å¯ä»¥è‡ªå·±å¼€å§‹ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–æ˜¯å¦åŠ å…¥ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        
        // 2. ã€å…³é”®ã€‘è§¦å‘AIå“åº”ï¼Œè®©å®ƒä»¬è‡ªå·±å†³å®šè¦ä¸è¦å¼€å§‹ç¾¤èŠ
        // è¿™å°†ä¼šåœ¨åå°å¤„ç†ï¼Œå¦‚æœAIä»¬å†³å®šå¼€å§‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ startVideoCall()
        await triggerAiResponse(); 
        
    } else { // å•èŠæ‹’ç»é€»è¾‘ä¿æŒä¸å˜
        const declineMessage = { role: 'user', content: 'æˆ‘æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        // å›åˆ°èŠå¤©ç•Œé¢å¹¶æ˜¾ç¤ºæ‹’ç»æ¶ˆæ¯
        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);
        
        // è®©AIå¯¹ä½ çš„æ‹’ç»åšå‡ºå›åº”
        triggerAiResponse();
    }
    
    // æ¸…ç†çŠ¶æ€ï¼Œä»¥é˜²ä¸‡ä¸€
    videoCallState.isAwaitingResponse = false;
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤å¤´åƒBUGã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ accept-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ¥å¬â€æŒ‰é’®
document.getElementById('accept-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true;
    videoCallState.activeChatId = state.activeChatId;
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘æˆ‘ä»¬åœ¨è¿™é‡Œä¸å†æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·åˆ° participants åˆ—è¡¨
    if (videoCallState.isGroupCall) {
        // å¯¹äºç¾¤èŠï¼Œæˆ‘ä»¬åªæŠŠã€å‘èµ·é€šè¯çš„AIã€‘åŠ å…¥å‚ä¸è€…åˆ—è¡¨
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {
            // æ¸…ç©ºå¯èƒ½å­˜åœ¨çš„æ—§æ•°æ®ï¼Œç„¶ååªæ·»åŠ å‘èµ·è€…
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = []; // å¦‚æœæ‰¾ä¸åˆ°å‘èµ·è€…ï¼Œå°±æ¸…ç©º
        }
    }
    
    // æ— è®ºå•èŠè¿˜æ˜¯ç¾¤èŠï¼Œç›´æ¥å¯åŠ¨é€šè¯ç•Œé¢ï¼
    startVideoCall();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å¢åŠ ç”¨æˆ·é«˜äº®ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ user-speak-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šç”¨æˆ·åœ¨é€šè¯ä¸­å‘è¨€çš„æŒ‰é’®
document.getElementById('user-speak-btn').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;

    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨å¼¹å‡ºè¾“å…¥æ¡†å‰ï¼Œå…ˆæ‰¾åˆ°å¹¶é«˜äº®ç”¨æˆ·å¤´åƒ â˜…â˜…â˜…â˜…â˜…
    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
    if (userAvatar) {
        userAvatar.classList.add('speaking');
    }

    const userInput = await showCustomPrompt('ä½ è¯´', 'è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...');
    
    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šæ— è®ºç”¨æˆ·æ˜¯å¦è¾“å…¥ï¼Œåªè¦å…³é—­è¾“å…¥æ¡†å°±ç§»é™¤é«˜äº® â˜…â˜…â˜…â˜…â˜…
    if (userAvatar) {
        userAvatar.classList.remove('speaking');
    }

    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘å›å¿†å½•ç›¸å…³äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
// 1. å°†â€œå›å¿†â€é¡µç­¾å’Œå®ƒçš„è§†å›¾è¿æ¥èµ·æ¥
document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    // åœ¨åˆ‡æ¢å‰ï¼Œç¡®ä¿"æ”¶è—"é¡µé¢çš„ç¼–è¾‘æ¨¡å¼å·²å…³é—­
    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }
    switchToChatListView('memories-view');
    renderMemoriesScreen(); // ç‚¹å‡»æ—¶æ¸²æŸ“
});

// 2. ç»‘å®šå›å¿†å½•ç•Œé¢çš„è¿”å›æŒ‰é’®
document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘çº¦å®š/å€’è®¡æ—¶åŠŸèƒ½äº‹ä»¶ç»‘å®š
document.getElementById('add-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.add('visible');
});
document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.remove('visible');
});
document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
    const title = document.getElementById('countdown-title-input').value.trim();
    const dateValue = document.getElementById('countdown-date-input').value;
    
    if (!title || !dateValue) {
        alert('è¯·å¡«å†™å®Œæ•´çš„çº¦å®šæ ‡é¢˜å’Œæ—¥æœŸï¼');
        return;
    }

    const targetDate = new Date(dateValue);
    if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ã€æœªæ¥çš„æ—¥æœŸï¼');
        return;
    }

    const newCountdown = {
        chatId: null, // ç”¨æˆ·åˆ›å»ºçš„ï¼Œä¸å±äºä»»ä½•ç‰¹å®šAI
        authorName: 'æˆ‘',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
    };
    
    await db.memories.add(newCountdown);
    document.getElementById('create-countdown-modal').classList.remove('visible');
    renderMemoriesScreen();
});

// ã€å…¨æ–°ã€‘æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç»‘å®š
document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ‹‰é»‘', 
        `ç¡®å®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘åæ‚¨å°†æ— æ³•å‘å…¶å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°†Taç§»å‡ºé»‘åå•ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è¯·å¥½å‹ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¢«ç”¨æˆ·æ‹‰é»‘äº†ã€‚åœ¨å¯¹æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ æ— æ³•å†ä¸»åŠ¨å‘èµ·å¯¹è¯ï¼Œä¹Ÿæ— æ³•å›åº”ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        
        // å…³é—­è®¾ç½®å¼¹çª—ï¼Œå¹¶åˆ·æ–°èŠå¤©ç•Œé¢
        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);
        // åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰UIå˜åŒ–
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("æ­£åœ¨æ‰‹åŠ¨è§¦å‘å¥½å‹ç”³è¯·æµç¨‹ï¼Œè¯·ç¨å...\nå¦‚æœAPIè°ƒç”¨æˆåŠŸï¼Œå°†å¼¹å‡ºæç¤ºã€‚å¦‚æœå¤±è´¥ï¼Œä¹Ÿä¼šæœ‰é”™è¯¯æç¤ºã€‚å¦‚æœé•¿æ—¶é—´æ— ååº”ï¼Œè¯´æ˜AIå¯èƒ½å†³å®šæš‚æ—¶ä¸ç”³è¯·ã€‚");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ã€‚ç°åœ¨ä½ ä»¬å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse(); // ã€å¯é€‰ä½†æ¨èã€‘è§£é™¤åè®©AIä¸»åŠ¨è¯´ç‚¹ä»€ä¹ˆ
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšé€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚ä½ ä»¬ç°åœ¨åˆå¯ä»¥æ­£å¸¸èŠå¤©äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: 'æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹è¯·æ±‚', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    // ã€æ–°å¢ã€‘å¤„ç†ç”³è¯·å¥½å‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            'å‘é€å¥½å‹ç”³è¯·', 
            `è¯·è¾“å…¥ä½ æƒ³å¯¹â€œ${chat.name}â€è¯´çš„ç”³è¯·ç†ç”±ï¼š`,
            "æˆ‘ä»¬å’Œå¥½å§ï¼"
        );
        // åªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»â€œç¡®å®šâ€åæ‰ç»§ç»­
        if (reason !== null) {
            // æ›´æ–°å…³ç³»çŠ¶æ€ä¸ºâ€œç­‰å¾…AIæ‰¹å‡†â€
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            // åˆ·æ–°UIï¼Œæ˜¾ç¤ºâ€œç­‰å¾…é€šè¿‡â€çš„ç•Œé¢
            renderChatInterface(chat.id);
            renderChatList();
            
            // ã€å…³é”®ã€‘è§¦å‘AIå“åº”ï¼Œè®©å®ƒå»å¤„ç†è¿™ä¸ªå¥½å‹ç”³è¯·
            triggerAiResponse();
        }
    }
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// 1. å°†åŸæœ‰çš„è½¬è´¦æŒ‰é’®(ï¿¥)çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‡å®šå‘åˆ°æ–°çš„æ€»å…¥å£å‡½æ•°
document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

// 2. çº¢åŒ…æ¨¡æ€æ¡†å†…éƒ¨çš„æ§åˆ¶æŒ‰é’®
document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

// 3. çº¢åŒ…æ¨¡æ€æ¡†çš„é¡µç­¾åˆ‡æ¢é€»è¾‘
const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});

// 4. å®æ—¶æ›´æ–°çº¢åŒ…é‡‘é¢æ˜¾ç¤º
document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});

// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†çº¢åŒ…ç‚¹å‡»ï¼Œä¿®å¤å¤±æ•ˆé—®é¢˜ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ‰¾åˆ°è¢«ç‚¹å‡»çš„çº¢åŒ…å¡ç‰‡
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯çº¢åŒ…ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš

    // 2. ä»çº¢åŒ…å¡ç‰‡çš„çˆ¶çº§.message-bubbleè·å–æ—¶é—´æˆ³
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    // 3. è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„å¤„ç†å‡½æ•°
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// åœ¨è¾“å…¥æ¡†å·¥å…·æ æ·»åŠ æŒ‰é’®
document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

// æŠ•ç¥¨åˆ›å»ºæ¨¡æ€æ¡†çš„æŒ‰é’®
document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŠ•ç¥¨å¡ç‰‡å†…çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    // ç‚¹å‡»äº†é€‰é¡¹
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    // ç‚¹å‡»äº†åŠ¨ä½œæŒ‰é’®ï¼ˆç»“æŸæŠ•ç¥¨/æŸ¥çœ‹ç»“æœï¼‰
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    // å¦‚æœæ˜¯å·²ç»“æŸçš„æŠ•ç¥¨ï¼Œç‚¹å‡»å¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹ç»“æœ
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç²˜è´´ç»“æŸ â–²â–²â–²

  // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸï¼Œç²˜è´´è¿™æ®µã€æ–°ä»£ç ã€‘â–¼â–¼â–¼
document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (!iconId) return;

        const currentUrl = state.globalSettings.appIcons[iconId];
        const newUrl = await showCustomPrompt(`æ›´æ¢â€œ${item.querySelector('.icon-preview').alt}â€å›¾æ ‡`, 'è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL', currentUrl, 'url');

        if (newUrl && newUrl.trim().startsWith('http')) {
            // ä»…åœ¨å†…å­˜ä¸­æ›´æ–°ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œä¿å­˜â€
            state.globalSettings.appIcons[iconId] = newUrl.trim();
            // å®æ—¶æ›´æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆå›¾
            item.querySelector('.icon-preview').src = newUrl.trim();
        } else if (newUrl !== null) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLï¼");
        }
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼

    document.getElementById('chat-messages').addEventListener('click', (e) => {
        // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å¡ç‰‡
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); // è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°
            }
        }
    });

    // æµè§ˆå™¨è¿”å›æŒ‰é’®çš„äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿å®ƒåªç»‘å®šä¸€æ¬¡
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼

    // 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é“¾æ¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    // 2. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    // 3. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œåˆ†äº«â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™å‡ è¡Œ â–¼â–¼â–¼
// ç»‘å®šæ¶ˆæ¯æ“ä½œèœå•ä¸­çš„â€œå¼•ç”¨â€æŒ‰é’®
document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);

// ç»‘å®šå›å¤é¢„è§ˆæ ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// åœ¨ä½ çš„ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ...

// â–¼â–¼â–¼ ç”¨è¿™æ®µä»£ç æ›¿æ¢æ—§çš„è½¬è´¦å¡ç‰‡ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡å†…
    const bubble = e.target.closest('.message-bubble');
    if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º

    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œæ·»åŠ ä¸¥æ ¼çš„ç­›é€‰æ¡ä»¶
    // å¿…é¡»æ˜¯ AI çš„æ¶ˆæ¯ (.ai)
    // å¿…é¡»æ˜¯è½¬è´¦ç±»å‹ (.is-transfer)
    // å¿…é¡»æ˜¯æˆ‘ä»¬æ ‡è®°ä¸ºâ€œå¾…å¤„ç†â€çš„ (data-status="pending")
    if (bubble.classList.contains('ai') && 
        bubble.classList.contains('is-transfer') && 
        bubble.dataset.status === 'pending') {
        
        // 3. åªæœ‰æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œæ‰æ‰§è¡Œåç»­é€»è¾‘
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
            showTransferActionModal(timestamp);
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ 
document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);

// â–¼â–¼â–¼ ç”¨è¿™æ®µã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„é€šè¯è®°å½•äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);

// 2. ç»‘å®šé€šè¯è®°å½•é¡µé¢çš„â€œè¿”å›â€æŒ‰é’®
document.getElementById('call-history-back-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›åˆ°èŠå¤©åˆ—è¡¨é¡µé¢ï¼Œè€Œä¸æ˜¯èŠå¤©ç•Œé¢
    showScreen('chat-list-screen');
});

// 3. ç›‘å¬å¡ç‰‡ç‚¹å‡»çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('call-history-list').addEventListener('click', (e) => {
    const card = e.target.closest('.call-record-card');
    if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
    }
});

// 4. å…³é—­è¯¦æƒ…å¼¹çª—çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('close-transcript-modal-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯è¯­éŸ³æ¡
    const voiceBody = e.target.closest('.voice-message-body');
    if (!voiceBody) return;

    // 2. æ‰¾åˆ°ç›¸å…³çš„DOMå…ƒç´ 
    const bubble = voiceBody.closest('.message-bubble');
    if (!bubble) return;
    
    const spinner = voiceBody.querySelector('.loading-spinner');
    const transcriptEl = bubble.querySelector('.voice-transcript');

    // å¦‚æœæ­£åœ¨åŠ è½½ä¸­ï¼Œåˆ™ä¸å“åº”ç‚¹å‡»
    if (bubble.dataset.state === 'loading') {
        return;
    }

    // 3. å¦‚æœæ–‡å­—å·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
    if (bubble.dataset.state === 'expanded') {
        transcriptEl.style.display = 'none';
        bubble.dataset.state = 'collapsed';
    } 
    // 4. å¦‚æœæ˜¯æ”¶èµ·çŠ¶æ€ï¼Œåˆ™å¼€å§‹â€œè½¬å½•â€æµç¨‹
    else {
        bubble.dataset.state = 'loading'; // è¿›å…¥åŠ è½½çŠ¶æ€
        spinner.style.display = 'block';   // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

        // æ¨¡æ‹Ÿ1.5ç§’çš„è¯­éŸ³è¯†åˆ«è¿‡ç¨‹
        setTimeout(() => {
            // æ£€æŸ¥æ­¤æ—¶å…ƒç´ æ˜¯å¦è¿˜å­˜åœ¨ï¼ˆå¯èƒ½ç”¨æˆ·å·²ç»åˆ‡æ¢äº†èŠå¤©ï¼‰
            if (document.body.contains(bubble)) {
                const voiceText = bubble.dataset.voiceText || '(æ— æ³•è¯†åˆ«)';
                transcriptEl.textContent = voiceText; // å¡«å……æ–‡å­—
                
                spinner.style.display = 'none';      // éšè—åŠ è½½åŠ¨ç”»
                transcriptEl.style.display = 'block';// æ˜¾ç¤ºæ–‡å­—
                bubble.dataset.state = 'expanded';     // è¿›å…¥å±•å¼€çŠ¶æ€
            }
        }, 500);
    }
});

document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('selection-share-btn').addEventListener('click', () => {
    if (selectedMessages.size > 0) {
        openShareTargetPicker(); // æ‰“å¼€æˆ‘ä»¬å³å°†åˆ›å»ºçš„ç›®æ ‡é€‰æ‹©å™¨
    }
});

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
    const sourceChat = state.chats[state.activeChatId];
    const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                   .map(cb => cb.dataset.chatId);

    if (selectedTargetIds.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ†äº«çš„èŠå¤©ã€‚");
        return;
    }

    // 1. æ‰“åŒ…èŠå¤©è®°å½•
    const sharedHistory = [];
    const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
    for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
            sharedHistory.push(msg);
        }
    }
    
    // 2. åˆ›å»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯å¯¹è±¡
    const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
            sourceChatName: sourceChat.name,
            title: `æ¥è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è®°å½•`,
            sharedHistory: sharedHistory
        }
    };

    // 3. å¾ªç¯å‘é€åˆ°æ‰€æœ‰ç›®æ ‡èŠå¤©
    for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
            targetChat.history.push(shareCardMessage);
            await db.chats.put(targetChat);
        }
    }
    
    // 4. æ”¶å°¾å·¥ä½œ
    document.getElementById('share-target-modal').classList.remove('visible');
    exitSelectionMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `èŠå¤©è®°å½•å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} ä¸ªä¼šè¯ä¸­ã€‚`);
    renderChatList(); // åˆ·æ–°åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰æ–°æ¶ˆæ¯æç¤º
});

// ç»‘å®šå–æ¶ˆæŒ‰é’®
document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
    document.getElementById('share-target-modal').classList.remove('visible');
});

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // ...ä½ å·²æœ‰çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘...

    // æ–°å¢é€»è¾‘ï¼šå¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
    }
});

// ç»‘å®šæŸ¥çœ‹å™¨çš„å…³é—­æŒ‰é’®
document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('shared-history-viewer-modal').classList.remove('visible');
});

// åˆ›å»ºæ–°å‡½æ•°æ¥å¤„ç†æ¸²æŸ“é€»è¾‘
function openSharedHistoryViewer(timestamp) {
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_card') return;

    const viewerModal = document.getElementById('shared-history-viewer-modal');
    const viewerTitle = document.getElementById('shared-history-viewer-title');
    const viewerContent = document.getElementById('shared-history-viewer-content');

    viewerTitle.textContent = message.payload.title;
    viewerContent.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

    // ã€æ ¸å¿ƒã€‘å¤ç”¨ createMessageElement æ¥æ¸²æŸ“æ¯ä¸€æ¡è¢«åˆ†äº«çš„æ¶ˆæ¯
    message.payload.sharedHistory.forEach(sharedMsg => {
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ sourceChat å¯¹è±¡ï¼Œä»¥ç¡®ä¿å¤´åƒã€æ˜µç§°ç­‰æ­£ç¡®
        const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
        const bubbleEl = createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
            viewerContent.appendChild(bubbleEl);
        }
    });

    viewerModal.classList.add('visible');
}

audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
    } 
});
audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
    } 
});

document.getElementById('playlist-body').addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('delete-track-btn')) {
        const index = parseInt(target.dataset.index);
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`);
        if (confirmed) {
            deleteTrack(index);
        }
        return;
    }
    if (target.classList.contains('lyrics-btn')) {
        const index = parseInt(target.dataset.index);
        if (isNaN(index)) return;
        const lrcContent = await new Promise(resolve => {
            const lrcInput = document.getElementById('lrc-upload-input');
            const handler = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (re) => resolve(re.target.result);
                    reader.readAsText(file);
                } else {
                    resolve(null);
                }
                lrcInput.removeEventListener('change', handler);
                lrcInput.value = '';
            };
            lrcInput.addEventListener('change', handler);
            lrcInput.click();
        });
        if (lrcContent !== null) {
            musicState.playlist[index].lrcContent = lrcContent;
            await saveGlobalPlaylist();
            alert('æ­Œè¯å¯¼å…¥æˆåŠŸï¼');
            if (musicState.currentIndex === index) {
                musicState.parsedLyrics = parseLRC(lrcContent);
                renderLyrics();
            }
        }
    }
});

document.querySelector('.progress-bar').addEventListener('click', (e) => {
    if (!audioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (!placeholder) return; // å¦‚æœä¸æ˜¯ï¼Œå°±é€€å‡º

    // å¦‚æœæ˜¯ï¼Œå°±ä»èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¹¶æ˜¾ç¤º
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper'); // æ‰¾åˆ°å®ƒçš„çˆ¶å®¹å™¨
    if (chat && wrapper) {
        // ä»çˆ¶å®¹å™¨ä¸Šæ‰¾åˆ°æ—¶é—´æˆ³
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
        
        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;
            
            if (recalled.originalType === 'text') {
                originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
            } else {
                originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
            }
            showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
        }
    }
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
document.getElementById('close-category-manager-btn').addEventListener('click', () => {
    document.getElementById('world-book-category-manager-modal').classList.remove('visible');
    renderWorldBookScreen(); // å…³é—­ååˆ·æ–°ä¸»åˆ—è¡¨
});
document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
document.getElementById('existing-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 5. å¯åŠ¨ï¼
            
            showScreen('home-screen');
        }

        init();
    });
</script>
</body>
</html>